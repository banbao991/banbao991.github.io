<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 6.3.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.jpg">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.jpg">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.jpg">
  <link rel="mask-icon" href="/images/apple-touch-icon-next.jpg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css" integrity="sha256-AbA177XfpSnFEvgpYu1jMygiLabzPCJCRIBtR5jGc0k=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.css" integrity="sha256-Vzbj7sDDS/woiFS3uNKo8eIuni59rjyNGtXfstRzStA=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"example.com","root":"/","images":"/images","scheme":"Gemini","darkmode":false,"version":"8.13.1","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":{"enable":false,"style":null},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script>

    <meta name="description" content="陷入内核（traps）">
<meta property="og:type" content="article">
<meta property="og:title" content="xv6-labs-2020.lab3.traps">
<meta property="og:url" content="http://example.com/2021/05/06/OS/xv6-labs/lab3-traps/index.html">
<meta property="og:site_name" content="Banbao">
<meta property="og:description" content="陷入内核（traps）">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2021-05-06T04:00:00.000Z">
<meta property="article:modified_time" content="2021-07-22T11:13:05.909Z">
<meta property="article:author" content="banbao(990)">
<meta property="article:tag" content="OS">
<meta property="article:tag" content="xv6">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="http://example.com/2021/05/06/OS/xv6-labs/lab3-traps/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"en","comments":true,"permalink":"http://example.com/2021/05/06/OS/xv6-labs/lab3-traps/","path":"2021/05/06/OS/xv6-labs/lab3-traps/","title":"xv6-labs-2020.lab3.traps"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>xv6-labs-2020.lab3.traps | Banbao</title>
  






  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">Banbao</p>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a></li><li class="menu-item menu-item-categories(2)"><a href="/kits/paper-lists/" rel="section"><i class="fa fa-print fa-fw"></i>Categories(2)</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a></li><li class="menu-item menu-item-more-notes"><a href="https://github.com/banbao990/Use/" rel="noopener" target="_blank"><i class="fa fa-book fa-fw"></i>More notes</a></li><li class="menu-item menu-item-use"><a href="/use/" rel="section"><i class="fa fa-gamepad fa-fw"></i>Use</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="Searching..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#lab3-traps"><span class="nav-text">lab3 traps</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BD%9C%E4%B8%9A%E9%93%BE%E6%8E%A5"><span class="nav-text">1. 作业链接</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%9E%E4%B9%A0%E5%86%85%E5%AE%B9"><span class="nav-text">2. 实习内容</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#risc-v-%E6%B1%87%E7%BC%96%E4%BB%A3%E7%A0%81"><span class="nav-text">RISC-V 汇编代码</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#backtrace"><span class="nav-text">Backtrace</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#kerneldefs.h"><span class="nav-text">kernel&#x2F;defs.h</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#kernelriscv.h"><span class="nav-text">kernel&#x2F;riscv.h</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#kernelsysproc.c"><span class="nav-text">kernel&#x2F;sysproc.c</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#kernelprintf.c"><span class="nav-text">kernel&#x2F;printf.c</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#backtrace-%E7%94%A8%E9%80%94"><span class="nav-text">backtrace 用途</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#alarm"><span class="nav-text">Alarm</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%97%AE%E9%A2%98%E6%8F%8F%E8%BF%B0"><span class="nav-text">问题描述</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%87%86%E5%A4%87%E5%B7%A5%E4%BD%9C"><span class="nav-text">准备工作</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#makefile"><span class="nav-text">Makefile</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#useruser.h"><span class="nav-text">user&#x2F;user.h</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#useruser.pl"><span class="nav-text">user&#x2F;user.pl</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#kernelsyscall.h"><span class="nav-text">kernel&#x2F;syscall.h</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#kernelsyscall.c"><span class="nav-text">kernel&#x2F;syscall.c</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#kernelsysproc.c-1"><span class="nav-text">kernel&#x2F;sysproc.c</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#test0-invoke-handler"><span class="nav-text">test0: invoke handler</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#kernelproc.h"><span class="nav-text">kernel&#x2F;proc.h</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#kernelproc.c"><span class="nav-text">kernel&#x2F;proc.c</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#kernelsysproc.c-2"><span class="nav-text">kernel&#x2F;sysproc.c</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#kernelusertrap.c%E9%94%99%E8%AF%AF%E5%AE%9E%E7%8E%B0"><span class="nav-text">kernel&#x2F;usertrap.c（错误实现）</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#test1-resume-interrupted-code"><span class="nav-text">test1: resume interrupted
code</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#kernelusertrap.c%E6%AD%A3%E7%A1%AE%E5%AE%9E%E7%8E%B0"><span class="nav-text">kernel&#x2F;usertrap.c（正确实现）</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#kernelproc.h-1"><span class="nav-text">kernel&#x2F;proc.h</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#kernelsysproc.c-3"><span class="nav-text">kernel&#x2F;sysproc.c</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#test2-prevent-re-entrant-calls"><span class="nav-text">test2(): prevent re-entrant
calls</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%AE%9E%E7%8E%B0%E9%80%BB%E8%BE%91"><span class="nav-text">实现逻辑</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#kernelproc.h-2"><span class="nav-text">kernel&#x2F;proc.h</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#kernelproc.c-1"><span class="nav-text">kernel&#x2F;proc.c</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#kernelsysproc.c%E9%94%99%E8%AF%AF%E5%AE%9E%E7%8E%B0"><span class="nav-text">kernel&#x2F;sysproc.c（错误实现）</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#kernelsysproc.c%E6%AD%A3%E7%A1%AE%E5%AE%9E%E7%8E%B0"><span class="nav-text">kernel&#x2F;sysproc.c（正确实现）</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#kerneltrap.c"><span class="nav-text">kernel&#x2F;trap.c</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%9E%E9%AA%8C%E7%BB%93%E6%9E%9C"><span class="nav-text">3. 实验结果</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%81%87%E5%88%B0%E7%9A%84%E5%9B%B0%E9%9A%BE%E4%BB%A5%E5%8F%8A%E6%94%B6%E8%8E%B7"><span class="nav-text">4. 遇到的困难以及收获</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%80%E4%B8%AA%E5%B0%8F%E9%97%AE%E9%A2%98"><span class="nav-text">一个小问题</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#sys_alarm-%E4%BF%9D%E5%AD%98%E7%9A%84%E5%AF%84%E5%AD%98%E5%99%A8"><span class="nav-text">sys_alarm 保存的寄存器</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AF%B9%E8%AF%BE%E7%A8%8B%E6%88%96-lab-%E7%9A%84%E6%84%8F%E8%A7%81%E5%92%8C%E5%BB%BA%E8%AE%AE"><span class="nav-text">5. 对课程或 lab 的意见和建议</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8F%82%E8%80%83%E6%96%87%E7%8C%AE"><span class="nav-text">6. 参考文献</span></a></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="banbao(990)"
      src="/images/avatar.jpg">
  <p class="site-author-name" itemprop="name">banbao(990)</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">332</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">45</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">103</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author site-overview-item animated">
      <span class="links-of-author-item">
        <a href="https://github.com/banbao990" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;banbao990" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i></a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:2369896555@qq.com" title="E-Mail → mailto:2369896555@qq.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i></a>
      </span>
  </div>



        </div>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>

  <a href="https://github.com/banbao990" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/05/06/OS/xv6-labs/lab3-traps/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="banbao(990)">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Banbao">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="xv6-labs-2020.lab3.traps | Banbao">
      <meta itemprop="description" content="陷入内核（traps）">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          xv6-labs-2020.lab3.traps
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2021-05-06 12:00:00" itemprop="dateCreated datePublished" datetime="2021-05-06T12:00:00+08:00">2021-05-06</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2021-07-22 19:13:05" itemprop="dateModified" datetime="2021-07-22T19:13:05+08:00">2021-07-22</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/OS-xv6-labs/" itemprop="url" rel="index"><span itemprop="name">OS.xv6-labs</span></a>
        </span>
    </span>

  
    <span class="post-meta-item" title="Views" id="busuanzi_container_page_pv">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">Views: </span>
      <span id="busuanzi_value_page_pv"></span>
    </span>
</div>

            <div class="post-description">陷入内核（traps）</div>
        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <h1 id="lab3-traps">lab3 traps</h1>
<h2 id="作业链接">1. 作业链接</h2>
<ul>
<li>https://pdos.csail.mit.edu/6.828/2020/labs/traps.html</li>
</ul>
<h2 id="实习内容">2. 实习内容</h2>
<h3 id="risc-v-汇编代码">RISC-V 汇编代码</h3>
<p>（1）函数传参使用哪些寄存器？printf() 函数调用中 13
放在那个寄存器里？</p>
<ul>
<li>函数传递参数使用寄存器：a0-a7</li>
<li>放置在 a2 寄存器里（第 3 个参数）</li>
</ul>
<p>（2）哪一部分的代码体现了对 f(), g() 的调用？</p>
<ul>
<li>f()：编译器优化的太厉害了，直接把 f(8)+1 算出来了，结果是 12</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># f(int)</span><br><span class="line"># Line 46</span><br><span class="line">26: 45b1                li  a1,12</span><br></pre></td></tr></table></figure>
<ul>
<li>g()：编译器直接把 g() 函数优化成 inline 形式的，在调用 g()
的地方，直接使用 a0 = a0 + 3 代替</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># g(int)</span><br><span class="line"># Line 32</span><br><span class="line">14: 250d                addiw   a0,a0,3</span><br></pre></td></tr></table></figure>
<p>（3）printf() 函数的地址</p>
<ul>
<li>0000000000000630</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># Line 1092</span><br><span class="line">0000000000000630 &lt;printf&gt;:</span><br></pre></td></tr></table></figure>
<p>（4）在调用 printf() 之后，ra 寄存器中保存的值是多少？</p>
<ul>
<li>0x38
<ul>
<li>1536 = 0x600</li>
<li>0x630 - 0x600 + 0x8 = 0x38</li>
</ul></li>
</ul>
<p>（5）下列代码输出是什么？</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">unsigned</span> <span class="type">int</span> i = <span class="number">0x00646c72</span>;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;H%x Wo%s&quot;</span>, <span class="number">57616</span>, &amp;i);</span><br></pre></td></tr></table></figure>
<ul>
<li>输出为：<code>HE110 World</code>
<ul>
<li>57616 = 0xe110</li>
<li>RISC-V 是小端的，因此 i 在内存中的分布为 72 6c 64
00（低地址到高地址）,对应的字符串为 <code>rld</code></li>
</ul></li>
<li>如果 RISC-V 是大端的，为了保证输出输出不变，需要把 i 的值修改为
0x726c6400，不需要修改 57616</li>
</ul>
<p>（6）下列代码的输出是什么？</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;x=%d y=%d&quot;</span>, <span class="number">3</span>);</span><br></pre></td></tr></table></figure>
<ul>
<li>输出结果为：<code>x=3 y=5221</code>
<ul>
<li>其中 5221
为一个不确定的数字，寄存器传参的时候少传了一个参数，所以这个值我们是未知的</li>
</ul></li>
</ul>
<h3 id="backtrace">Backtrace</h3>
<ul>
<li>要求
<ul>
<li>The compiler puts in each stack frame a frame pointer that holds the
address of the caller's frame pointer. Your <code>backtrace</code>
should use these frame pointers to walk up the stack and print the saved
return address in each stack frame.</li>
</ul></li>
<li>在 sys_sleep() 中调用 backtrace()</li>
</ul>
<h4 id="kerneldefs.h">kernel/defs.h</h4>
<ul>
<li>添加函数原型，从而能够让 sleep() 调用 backtrace()</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">backtrace</span><span class="params">(<span class="type">void</span>)</span>;</span><br></pre></td></tr></table></figure>
<h4 id="kernelriscv.h">kernel/riscv.h</h4>
<ul>
<li>在这里添加读取寄存器 s0 的指令</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="keyword">inline</span> uint64 <span class="title function_">r_fp</span><span class="params">()</span> &#123;</span><br><span class="line">  uint64 x;</span><br><span class="line">  <span class="keyword">asm</span> <span class="title function_">volatile</span><span class="params">(<span class="string">&quot;mv %0, s0&quot;</span> : <span class="string">&quot;=r&quot;</span> (x) )</span>;</span><br><span class="line">  <span class="keyword">return</span> x;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="kernelsysproc.c">kernel/sysproc.c</h4>
<ul>
<li>在 sys_sleep() 函数中添加对 backtrace() 的调用</li>
<li>我直接加在开头了</li>
</ul>
<h4 id="kernelprintf.c">kernel/printf.c</h4>
<ul>
<li>添加函数实现</li>
<li>注意栈帧结构
<ul>
<li>return address: a fixed offset (-8) from the frame pointer of a
stackframe</li>
<li>the saved frame pointer: fixed offset (-16) from the frame
pointer</li>
</ul></li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// backtrace</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">backtrace</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// 获取当前的帧指针 frame pointer</span></span><br><span class="line">    uint64 fp = r_fp();</span><br><span class="line">    uint64 down = PGROUNDDOWN(fp);</span><br><span class="line">    uint64 up = PGROUNDUP(fp);</span><br><span class="line">    <span class="comment">// 栈向下增长, 因此循环的时候 fp 应该是越来越大</span></span><br><span class="line">    <span class="keyword">while</span>(fp &lt; up &amp;&amp; fp &gt; down) &#123;</span><br><span class="line">        printptr(*(uint64 *)(fp - <span class="number">8</span>));</span><br><span class="line">        consputc(<span class="string">&#x27;\n&#x27;</span>);</span><br><span class="line">        fp = *(uint64 *)(fp - <span class="number">16</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="backtrace-用途">backtrace 用途</h4>
<ul>
<li>Once your backtrace is working, call it from <code>panic</code> in
<code>kernel/printf.c</code> so that you see the kernel's backtrace when
it panics.</li>
</ul>
<h3 id="alarm">Alarm</h3>
<h4 id="问题描述">问题描述</h4>
<ul>
<li>In this exercise you'll add a feature to xv6 that periodically
alerts a process as it uses CPU time. This might be useful for
compute-bound processes that want to limit how much CPU time they chew
up, or for processes that want to compute but also want to take some
periodic action. More generally, you'll be implementing a primitive form
of user-level interrupt/fault handlers; you could use something similar
to handle page faults in the application, for example. Your solution is
correct if it passes alarmtest and usertests.</li>
<li>添加两个系统调用</li>
</ul>
<h4 id="准备工作">准备工作</h4>
<h5 id="makefile">Makefile</h5>
<ul>
<li>把 <code>$U/_alarmtest</code> 添加到 <code>UPROGS</code> 里</li>
</ul>
<h5 id="useruser.h">user/user.h</h5>
<ul>
<li>添加函数原型</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">sigalarm</span><span class="params">(<span class="type">int</span> ticks, <span class="type">void</span> (*handler)())</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">sigreturn</span><span class="params">(<span class="type">void</span>)</span>;</span><br></pre></td></tr></table></figure>
<h5 id="useruser.pl">user/user.pl</h5>
<ul>
<li>添加入口，辅助生成汇编代码</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">entry(&quot;sigalarm&quot;);</span><br><span class="line">entry(&quot;sigreturn&quot;);</span><br></pre></td></tr></table></figure>
<h5 id="kernelsyscall.h">kernel/syscall.h</h5>
<ul>
<li>添加系统调用号</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> SYS_sigalarm  22</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SYS_sigreturn  23</span></span><br></pre></td></tr></table></figure>
<h5 id="kernelsyscall.c">kernel/syscall.c</h5>
<ul>
<li>添加新系统调用的定义和入口</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">extern</span> uint64 <span class="title function_">sys_sigalarm</span><span class="params">(<span class="type">void</span>)</span>;</span><br><span class="line"><span class="keyword">extern</span> uint64 <span class="title function_">sys_sigreturn</span><span class="params">(<span class="type">void</span>)</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="title function_">uint64</span> <span class="params">(*syscalls[])</span><span class="params">(<span class="type">void</span>)</span> = &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    [SYS_sigalarm]   sys_sigalarm,</span><br><span class="line">    [SYS_sigreturn]   sys_sigreturn,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h5 id="kernelsysproc.c-1">kernel/sysproc.c</h5>
<ul>
<li>添加具体的实现（测试）</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">uint64 <span class="title function_">sys_sigalarm</span><span class="params">(<span class="type">void</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line">uint64 <span class="title function_">sys_sigreturn</span><span class="params">(<span class="type">void</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>做到这里，程序能够编译成功了，但是具体功能还没有实现</li>
</ul>
<h4 id="test0-invoke-handler">test0: invoke handler</h4>
<ul>
<li>实现逻辑
<ul>
<li>在调用 sysalarm 的时候，在进程的数据结构中保存参数
<ul>
<li>handler、多久调用一次 handler、现在已经运行了多少个 ticks（初始化为
0）</li>
</ul></li>
<li>在收到时钟中断信号的时候，判断是否需要调用 handler，如果需要，设置
PC 为 handler</li>
</ul></li>
<li>这个是先破坏了栈帧，因此是有问题的
<ul>
<li>test1/test2 部分解决这个问题</li>
</ul></li>
</ul>
<h5 id="kernelproc.h">kernel/proc.h</h5>
<ul>
<li>添加一些中间变量辅助实现 sys_alarm() 功能</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">proc</span> &#123;</span></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="comment">// 添加几个变量辅助实现 sysalarm()</span></span><br><span class="line">    <span class="type">int</span> ticks_for_alarm;    <span class="comment">// 多久时间调用一次 handler</span></span><br><span class="line">    <span class="type">void</span>(*)(alarm_handler); <span class="comment">// handler</span></span><br><span class="line">    <span class="type">int</span> ticks_used;         <span class="comment">// 已经使用了多少 ticks(对 ticks_for_alarm 取模)</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="kernelproc.c">kernel/proc.c</h5>
<ul>
<li>对于上面那些变量的初始化</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="keyword">struct</span> proc* <span class="title function_">allocproc</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">    <span class="comment">// 最后的部分添加如下修改</span></span><br><span class="line"></span><br><span class="line">    p-&gt;ticks_for_alarm = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// 理论上修改上边一个变量就够了, 但是为了安全, 全都修改了</span></span><br><span class="line">    p-&gt;alarm_handler = <span class="number">0</span>;</span><br><span class="line">    p-&gt;ticks_used = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> p;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 安全起见也改了, 但是不该不影响结果</span></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">freeproc</span><span class="params">(<span class="keyword">struct</span> proc *p)</span> &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    p-&gt;ticks_for_alarm = <span class="number">0</span>;</span><br><span class="line">    p-&gt;alarm_handler = <span class="number">0</span>;</span><br><span class="line">    p-&gt;ticks_used = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="kernelsysproc.c-2">kernel/sysproc.c</h5>
<ul>
<li>设置 proc.h 中的变量</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">uint64 <span class="title function_">sys_sigalarm</span><span class="params">(<span class="type">void</span>)</span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">proc</span> *<span class="title">p</span> =</span> myproc();</span><br><span class="line">    <span class="type">int</span> n;</span><br><span class="line">    uint64 handler;</span><br><span class="line">    <span class="keyword">if</span>(argint(<span class="number">0</span>, &amp;n) &lt; <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">if</span>(argaddr(<span class="number">1</span>, &amp;handler) &lt; <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    p-&gt;alarm_handler = (<span class="type">void</span>(*)()) handler;</span><br><span class="line">    p-&gt;ticks_for_alarm = n;</span><br><span class="line">    p-&gt;ticks_used = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">uint64 <span class="title function_">sys_sigreturn</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="kernelusertrap.c错误实现">kernel/usertrap.c（错误实现）</h5>
<ul>
<li>每次接受到时钟中断的时候，计数器 ticks 自增</li>
<li>在从内核态返回用户态的时候判断 ticks 记录是否超标，如果是，则调用
handler 进行处理</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">usertrap</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">    <span class="keyword">if</span>(which_dev == <span class="number">2</span>)&#123;</span><br><span class="line">        <span class="keyword">if</span>(p-&gt;ticks_for_alarm) &#123;</span><br><span class="line">            ++p-&gt;ticks_used;</span><br><span class="line">        &#125;</span><br><span class="line">        yield();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">usertrapret</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">    <span class="comment">// 原来是 w_sepc(p-&gt;trapframe-&gt;epc);</span></span><br><span class="line">    <span class="comment">// 现在加上一个判断, 将其设置为 handler 的地址</span></span><br><span class="line">    <span class="comment">// 这显然是错误的, 栈帧被破坏了, 但是 test0 是 OK 的</span></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">if</span>(p-&gt;ticks_for_alarm &amp;&amp; p-&gt;ticks_used == p-&gt;ticks_for_alarm) &#123;</span><br><span class="line">        p-&gt;ticks_used = <span class="number">0</span>;</span><br><span class="line">        w_sepc((uint64)p-&gt;alarm_handler);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        w_sepc(p-&gt;trapframe-&gt;epc);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>另外一种简便的实现方式
<ul>
<li>直接修改 epc</li>
<li>但是也是破坏了栈帧</li>
</ul></li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">usertrap</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">    <span class="keyword">if</span>(which_dev == <span class="number">2</span>)&#123;</span><br><span class="line">        <span class="keyword">if</span>(p-&gt;ticks_for_alarm) &#123;</span><br><span class="line">            ++p-&gt;ticks_used;</span><br><span class="line">            <span class="keyword">if</span>(p-&gt;ticks_used == p-&gt;ticks_for_alarm) &#123;</span><br><span class="line">                p-&gt;ticks_used = <span class="number">0</span>;</span><br><span class="line">                p-&gt;trapframe-&gt;epc = (uint64)p-&gt;alarm_handler;</span><br><span class="line">            &#125;</span><br><span class="line">            yield();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="test1-resume-interrupted-code">test1: resume interrupted
code</h4>
<ul>
<li>这一部分的实现除了 usertrap.c，其他部分都是基于 test0
进行修改的</li>
</ul>
<h5 id="kernelusertrap.c正确实现">kernel/usertrap.c（正确实现）</h5>
<ul>
<li>需要保存寄存器状态，通过 sysalarm 和 sigreturn 的配合实现</li>
<li>要求每个 hander 的最后都需要调用 sigreturn 回到内核态</li>
<li>test0 的实现回到用户态之前需要保存当时的寄存器状态，当 sigreturn
回到了内核态是恢复寄存器状态，返回用户态正常执行</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">usertrap</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">if</span>(which_dev == <span class="number">2</span>)&#123;</span><br><span class="line">        <span class="keyword">if</span>(p-&gt;ticks_for_alarm) &#123;</span><br><span class="line">            ++p-&gt;ticks_used;</span><br><span class="line">            <span class="keyword">if</span>(p-&gt;ticks_used == p-&gt;ticks_for_alarm) &#123;</span><br><span class="line">                p-&gt;ticks_used = <span class="number">0</span>;</span><br><span class="line">                <span class="comment">// 保存所有的寄存器状态</span></span><br><span class="line">                memmove(&amp;(p-&gt;trapframe2), p-&gt;trapframe, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> trapframe));</span><br><span class="line">                p-&gt;trapframe-&gt;epc = (uint64)p-&gt;alarm_handler;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        yield();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="kernelproc.h-1">kernel/proc.h</h5>
<ul>
<li>需要在 proc 数据结构中保存寄存器</li>
<li>这里为了方便直接使用 trapframe
的数据结构，实际上有些值是不需要保存恢复的
<ul>
<li>kernel
的相关值不用恢复：kernel_satp、kernel_sp、kernel_trap、kernel_hartid</li>
</ul></li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">proc</span> &#123;</span></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="comment">// 保存 sysalarm 的寄存器状态, kernel 的 4 个不需要, 但是为了方便都写了</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">trapframe</span> <span class="title">trapframe2</span>;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h5 id="kernelsysproc.c-3">kernel/sysproc.c</h5>
<ul>
<li>当调用 sys_sigreturn 的时候恢复寄存器状态</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">uint64 <span class="title function_">sys_sigreturn</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">proc</span> *<span class="title">p</span> =</span> myproc();</span><br><span class="line">    <span class="comment">// 恢复寄存器状态(4 个 kernel 的不需要)</span></span><br><span class="line">    <span class="comment">// 如果是 sigalarm(0, 0) 的话不需要恢复现场</span></span><br><span class="line">    <span class="keyword">if</span>(p-&gt;ticks_for_alarm) &#123;</span><br><span class="line">        memmove(</span><br><span class="line">            ((uint64 *)p-&gt;trapframe) + <span class="number">5</span>,</span><br><span class="line">            ((uint64 *)&amp;(p-&gt;trapframe2)) + <span class="number">5</span>,</span><br><span class="line">            <span class="keyword">sizeof</span>(<span class="keyword">struct</span> trapframe) - <span class="number">5</span>*<span class="keyword">sizeof</span>(uint64)</span><br><span class="line">        );</span><br><span class="line">        p-&gt;trapframe-&gt;epc = p-&gt;trapframe2.epc;</span><br><span class="line">        p-&gt;is_alarm = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>到这里为止，已经能够通过 test2，在不破坏栈帧的情况下实现 sysalarm
的效果</li>
</ul>
<h4 id="test2-prevent-re-entrant-calls">test2(): prevent re-entrant
calls</h4>
<ul>
<li>这一部分的实现基于 test1 进行修改的</li>
</ul>
<h5 id="实现逻辑">实现逻辑</h5>
<ul>
<li>不允许重复调用，当一个 sysalarm 已经存在的时候，没有调用 sigreturn
之前不允许调用新的 sigalarm</li>
<li>这一部分的实现很简单，在 proc 数据结构中添加一个标记变量
<ul>
<li>调用 sigalarm 的时候设置为 1
<ul>
<li>如果调用 sigalarm 的时候已经为 1，则该调用不生效</li>
</ul></li>
<li>调用 sigreturn 的时候设置为 0</li>
</ul></li>
</ul>
<h5 id="kernelproc.h-2">kernel/proc.h</h5>
<ul>
<li>添加一个标记变量</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">proc</span> &#123;</span></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="type">int</span> is_alarm; <span class="comment">// 是否调用 sigalarm</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h5 id="kernelproc.c-1">kernel/proc.c</h5>
<ul>
<li>标记变量的初始化</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="keyword">struct</span> proc* <span class="title function_">allocproc</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    p-&gt;is_alarm = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">return</span> p;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 安全起见也改了, 但是不该不影响结果</span></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">freeproc</span><span class="params">(<span class="keyword">struct</span> proc *p)</span> &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    p-&gt;is_alarm = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="kernelsysproc.c错误实现">kernel/sysproc.c（错误实现）</h5>
<ul>
<li>添加标记变量的判断</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">uint64 <span class="title function_">sys_sigalarm</span><span class="params">(<span class="type">void</span>)</span>&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">if</span>(p-&gt;is_alarm) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span>(handler)&#123;</span><br><span class="line">        <span class="comment">// 注意如果调用的是 sigalarm(0, 0) 的话是不需要调用 sigreturn 的</span></span><br><span class="line">        p-&gt;is_alarm = <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">uint64 <span class="title function_">sys_sigreturn</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    p-&gt;is_alarm = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>这样子实现是错误的，只能阻止新的 sigalarm
的调用，但是不能够实现已经设置的 handler 在 sigreturn
之前的再次调用</li>
<li>输出结果</li>
</ul>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">test2 start</span><br><span class="line">.....alarm!</span><br><span class="line">alarm!</span><br><span class="line">test2 failed: alarm handler called more than once</span><br></pre></td></tr></table></figure>
<h5 id="kernelsysproc.c正确实现">kernel/sysproc.c（正确实现）</h5>
<ul>
<li>此时 is_alarm 的含义变成了是否调用 handler</li>
<li>如果有 handler 调用，禁止新的 sigalarm 调用</li>
<li>恢复当然还是在调用 sigreturn 的时候恢复</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">uint64 <span class="title function_">sys_sigalarm</span><span class="params">(<span class="type">void</span>)</span>&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="comment">// 如果已经调用了一个 handler, 而且没有返回的话</span></span><br><span class="line">    <span class="comment">// 我们禁止这个新的调用(我们的设计不支持递归调用)</span></span><br><span class="line">    <span class="keyword">if</span>(p-&gt;is_alarm) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">uint64 <span class="title function_">sys_sigreturn</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="comment">// 恢复寄存器状态(4 个 kernel 的不需要)</span></span><br><span class="line">    <span class="comment">// 只有保存了寄存器才需要恢复现场</span></span><br><span class="line">    <span class="keyword">if</span>(p-&gt;is_alarm) &#123;</span><br><span class="line">        memmove(</span><br><span class="line">            ((uint64 *)p-&gt;trapframe) + <span class="number">5</span>,</span><br><span class="line">            ((uint64 *)&amp;(p-&gt;trapframe2)) + <span class="number">5</span>,</span><br><span class="line">            <span class="keyword">sizeof</span>(<span class="keyword">struct</span> trapframe) - <span class="number">5</span>*<span class="keyword">sizeof</span>(uint64)</span><br><span class="line">        );</span><br><span class="line">        p-&gt;trapframe-&gt;epc = p-&gt;trapframe2.epc;</span><br><span class="line">    &#125;</span><br><span class="line">    p-&gt;is_alarm = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="kerneltrap.c">kernel/trap.c</h5>
<ul>
<li>正确实现应该是在保存寄存器的时候进行判断
<ul>
<li>因为我们只有一块区域，不能够实现递归调用</li>
<li>也能解决上面的问题</li>
</ul></li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">usertrap</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="comment">// 保存所有的寄存器状态</span></span><br><span class="line">    <span class="keyword">if</span>(!(p-&gt;is_alarm)) &#123;</span><br><span class="line">        p-&gt;is_alarm = <span class="number">1</span>;</span><br><span class="line">        memmove(&amp;(p-&gt;trapframe2), p-&gt;trapframe, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> trapframe));</span><br><span class="line">        p-&gt;trapframe-&gt;epc = (uint64)p-&gt;alarm_handler;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="实验结果">3. 实验结果</h2>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">== Test answers-traps.txt == answers-traps.txt: OK</span><br><span class="line">== Test backtrace <span class="built_in">test</span> ==</span><br><span class="line">$ make qemu-gdb</span><br><span class="line">backtrace <span class="built_in">test</span>: OK (14.9s)</span><br><span class="line">== Test running alarmtest ==</span><br><span class="line">$ make qemu-gdb</span><br><span class="line">(7.0s)</span><br><span class="line">== Test   alarmtest: test0 ==</span><br><span class="line">  alarmtest: test0: OK</span><br><span class="line">== Test   alarmtest: test1 ==</span><br><span class="line">  alarmtest: test1: OK</span><br><span class="line">== Test   alarmtest: test2 ==</span><br><span class="line">  alarmtest: test2: OK</span><br><span class="line">== Test usertests ==</span><br><span class="line">$ make qemu-gdb</span><br><span class="line">usertests: OK (231.3s)</span><br><span class="line">    (Old xv6.out.usertests failure <span class="built_in">log</span> removed)</span><br><span class="line">== Test time ==</span><br><span class="line">time: OK</span><br><span class="line">Score: 85/85</span><br></pre></td></tr></table></figure>
<h2 id="遇到的困难以及收获">4. 遇到的困难以及收获</h2>
<ul>
<li>做完整个 lab 感觉操作系统的设计很巧妙，这里的的 sysalarm
的实际就感觉很有趣，通过两次系统调用解决了一次系统调用很难解决的问题。</li>
<li>具体的解决方法在上面都已经提到了，主要是怎么设置
PC，以及栈帧的保存与恢复问题。</li>
</ul>
<h3 id="一个小问题">一个小问题</h3>
<ul>
<li>在这个 lab 的实现中，在 <code>sigreturn()</code>
未返回时，有两种实现方案
<ul>
<li>不允许 <code>sigalarm()</code> 重新设置 <code>handler</code></li>
<li>允许 <code>sigalarm()</code> 重新设置
<code>handler</code>，但是不允许其有修改保存的寄存器（我们只有一块区域，不支持递归）</li>
</ul></li>
<li>这两种方法都可行，测试都能过</li>
<li>但似乎又都有各自的问题
<ul>
<li>第一种方法不能允许 <code>sigalarm(0, 0)</code>
的调用，这样的调用能够取消 <code>handler()</code></li>
<li>第二种方法会让最终的 <code>handler()</code> 不太可控，可能在
<code>sigreturn()</code> 未返回的时候设置了奇怪的
<code>handler()</code></li>
</ul></li>
<li>我是按照方法 1 实现的</li>
</ul>
<h3 id="sys_alarm-保存的寄存器">sys_alarm 保存的寄存器</h3>
<ul>
<li>epc（需要）</li>
<li>callee-saved（需要）（sig_return 之前可能没有 pop 栈）</li>
<li>caller-saved（不需要）</li>
<li>kernel_sp（不需要）</li>
<li>kernel_hartid（不能）</li>
<li>kernel_stap（不需要）</li>
</ul>
<h2 id="对课程或-lab-的意见和建议">5. 对课程或 lab 的意见和建议</h2>
<ul>
<li>一个建议是最后的 usertests.c
的运行时间太长了，感觉没有必要用那么多的测试，之前已按因为一行代码写反了一直超时，浪费了太多时间。</li>
</ul>
<h2 id="参考文献">6. 参考文献</h2>
<ul>
<li>https://pdos.csail.mit.edu/6.828/2020/reference.html</li>
<li>https://github.com/riscv/riscv-isa-manual/releases/download/draft-20200727-8088ba4/riscv-spec.pdf</li>
<li>https://pdos.csail.mit.edu/6.828/2019/xv6/book-riscv-rev0.pdf</li>
</ul>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/OS/" rel="tag"># OS</a>
              <a href="/tags/xv6/" rel="tag"># xv6</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2021/05/05/DB/CLJ/05/" rel="prev" title="数据库概论.陈立军.05.关系规范化">
                  <i class="fa fa-chevron-left"></i> 数据库概论.陈立军.05.关系规范化
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2021/05/08/OS/xv6-labs/lab4-lazy-allocation/" rel="next" title="xv6-labs-2020.lab4.lazy page allocation">
                  xv6-labs-2020.lab4.lazy page allocation <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 2021 – 
  <span itemprop="copyrightYear">2025</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">banbao(990)</span>
</div>
<div class="busuanzi-count">
    <span class="post-meta-item" id="busuanzi_container_site_uv">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="Total Visitors">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-item" id="busuanzi_container_site_pv">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="Total Views">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" rel="noopener" target="_blank">NexT.Gemini</a>
  </div>


  
    <script src='https://unpkg.com/mermaid/dist/mermaid.min.js'></script>
  
    <script>
      if (window.mermaid) {
        mermaid.initialize({theme: 'forest'});
      }
    </script>

    </div>
  </footer>

  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.1/jquery.min.js" integrity="sha256-o88AwQnZB+VDvE9tvIXrMQaPlFFSUTR+nldQm1LuPXQ=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.js" integrity="sha256-yt2kYMy0w8AbtF89WXb2P1rfjcP/HTHLT7097U8Y5b8=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script>

  
<script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.0/search.js" integrity="sha256-vXZMYLEqsROAXkEw93GGIvaB2ab+QW6w3+1ahD9nXXA=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>


  <script class="next-config" data-name="mermaid" type="application/json">{"enable":true,"theme":{"light":"default","dark":"dark"},"js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/mermaid/9.1.7/mermaid.min.js","integrity":"sha256-G58AID1YoX5YaEtWfXSI0VLrZ6N4kvNvwg0BI8zUFxE="}}</script>
  <script src="/js/third-party/tags/mermaid.js"></script>

  <script src="/js/third-party/fancybox.js"></script>


  
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>




  

  <script class="next-config" data-name="enableMath" type="application/json">false</script><script class="next-config" data-name="mathjax" type="application/json">{"enable":true,"tags":"none","js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.2.2/es5/tex-mml-chtml.js","integrity":"sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI="}}</script>
<script src="/js/third-party/math/mathjax.js"></script>



</body>
</html>
