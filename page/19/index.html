<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>Hexo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta property="og:type" content="website">
<meta property="og:title" content="Hexo">
<meta property="og:url" content="http://example.com/page/19/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="John Doe">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/typeface-source-code-pro@0.0.71/index.min.css">

  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
<meta name="generator" content="Hexo 6.3.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Hexo</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://example.com"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main">
  
    <article id="post-DB/CLJ/04-6" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/05/03/DB/CLJ/04-6/" class="article-date">
  <time class="dt-published" datetime="2021-05-03T13:38:04.000Z" itemprop="datePublished">2021-05-03</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/DB-CLJ/">DB.CLJ</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2021/05/03/DB/CLJ/04-6/">数据库概论.陈立军.04.SQL 完整性</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="在线-SQL"><a href="#在线-SQL" class="headerlink" title="在线 SQL"></a>在线 SQL</h1><ul>
<li><a target="_blank" rel="noopener" href="http://sqlfiddle.com/">http://sqlfiddle.com/</a></li>
<li>MySQL 5.6</li>
</ul>
<h1 id="SQL-完整性"><a href="#SQL-完整性" class="headerlink" title="SQL 完整性"></a>SQL 完整性</h1><h2 id="关系模型中的完整性"><a href="#关系模型中的完整性" class="headerlink" title="关系模型中的完整性"></a>关系模型中的完整性</h2><h3 id="实体完整性"><a href="#实体完整性" class="headerlink" title="实体完整性"></a>实体完整性</h3><ul>
<li>关系的主码中的属性值不能为空值</li>
<li>实体是相互可区分的</li>
</ul>
<h3 id="参照完整性"><a href="#参照完整性" class="headerlink" title="参照完整性"></a>参照完整性</h3><ul>
<li>外码必须和某个参照的属性相同</li>
<li>必须与客观存在的实体发生联系</li>
</ul>
<h3 id="用户定义的完整性"><a href="#用户定义的完整性" class="headerlink" title="用户定义的完整性"></a>用户定义的完整性</h3><ul>
<li>用户针对具体应用环境定义的完整性约束条件</li>
<li>例如一些具体的限定<ul>
<li>sno要求是8位整数，首位是0或1</li>
<li>飞行员的飞行里程与星级评定</li>
<li>选课人数不能少于10人，多于100人</li>
<li>在本地纳税记录超过5年才有购房资格</li>
<li>婚姻登记必须购买百年好合保险</li>
</ul>
</li>
</ul>
<h3 id="比较"><a href="#比较" class="headerlink" title="比较"></a>比较</h3><ul>
<li>实体完整性和参照完整性由系统自动支持</li>
<li>系统提供定义和检验用户定义的完整性的机制</li>
</ul>
<h2 id="约束类型"><a href="#约束类型" class="headerlink" title="约束类型"></a>约束类型</h2><ul>
<li>列级约束<ul>
<li>列值范围</li>
<li>例子<ul>
<li>取值范围</li>
</ul>
</li>
</ul>
</li>
<li>行级约束<ul>
<li>同一行各列之间</li>
<li>例子<ul>
<li>飞行员的等级和他的飞行里程有关</li>
<li>主码约束</li>
</ul>
</li>
</ul>
</li>
<li>表级约束<ul>
<li>行间、表上、表间</li>
<li>例子<ul>
<li>外码约束</li>
</ul>
</li>
</ul>
</li>
<li>查看约束：sp_helpconstraint</li>
<li>SQL<ul>
<li>primarykey</li>
<li>unique</li>
<li>foreignkey</li>
<li>check</li>
<li>default</li>
</ul>
</li>
</ul>
<h2 id="约束系统表"><a href="#约束系统表" class="headerlink" title="约束系统表"></a>约束系统表</h2><ul>
<li>Sysconstraints 系统表</li>
</ul>
<table>
<thead>
<tr>
<th align="center">列名</th>
<th align="center">数据类型</th>
<th align="center">描述</th>
</tr>
</thead>
<tbody><tr>
<td align="center">constid</td>
<td align="center">int</td>
<td align="center">约束号</td>
</tr>
<tr>
<td align="center">id</td>
<td align="center">int</td>
<td align="center">拥有该约束的表ID</td>
</tr>
<tr>
<td align="center">colid</td>
<td align="center">smallint</td>
<td align="center">在其上定义约束的列ID，如果是表约束则为0</td>
</tr>
<tr>
<td align="center">status</td>
<td align="center">int</td>
<td align="center">位图指示状态。可能的值包括：<br/>1 &#x3D; PRIMARY KEY 约束<br />2 &#x3D; UNIQUE KEY 约束<br/>3 &#x3D; FOREIGN KEY 约束<br/>4 &#x3D; CHECK 约束<br />5 &#x3D; DEFAULT 约束<br />16 &#x3D; 列级约束<br/>32 &#x3D; 表级约束</td>
</tr>
</tbody></table>
<h2 id="primary-key-与-unique"><a href="#primary-key-与-unique" class="headerlink" title="primary key 与 unique"></a>primary key 与 unique</h2><ul>
<li>都是通过<strong>唯一性索引</strong>来支持</li>
<li>区别<ul>
<li>primary key 不能为空值，unique 可以为空值</li>
<li><strong>unique 列只能有一个 null</strong></li>
</ul>
</li>
<li>unique 可以定义在多个列上，此时可以出现多个 null</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> t1 (</span><br><span class="line">    col1 intunique,</span><br><span class="line">    col2 <span class="type">int</span>,</span><br><span class="line">    col3 <span class="type">int</span>,</span><br><span class="line">    <span class="keyword">unique</span>(col2,col3)</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th align="center">Col1</th>
<th align="center">Col2</th>
<th align="center">Col3</th>
</tr>
</thead>
<tbody><tr>
<td align="center">1</td>
<td align="center">3</td>
<td align="center">4</td>
</tr>
<tr>
<td align="center">2</td>
<td align="center">5</td>
<td align="center">null</td>
</tr>
<tr>
<td align="center">null</td>
<td align="center">6</td>
<td align="center">null</td>
</tr>
</tbody></table>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> t1 (</span><br><span class="line">    col1 <span class="type">int</span> <span class="keyword">unique</span>,</span><br><span class="line">    col2 <span class="type">int</span>,</span><br><span class="line">    col3 <span class="type">int</span>,</span><br><span class="line">    <span class="keyword">unique</span>(col2,col3)</span><br><span class="line">);</span><br><span class="line"><span class="keyword">insert</span> t1 <span class="keyword">values</span>(<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>);</span><br><span class="line"><span class="comment">/* insert t1 values(1,2,2);*/</span>     <span class="comment">/* ERROR */</span></span><br><span class="line"><span class="keyword">insert</span> t1 <span class="keyword">values</span>(<span class="number">2</span>,<span class="number">1</span>,<span class="keyword">null</span>);</span><br><span class="line"><span class="keyword">insert</span> t1 <span class="keyword">values</span>(<span class="number">3</span>,<span class="number">1</span>,<span class="keyword">null</span>);       <span class="comment">/* OK */</span></span><br><span class="line"><span class="keyword">insert</span> t1 <span class="keyword">values</span>(<span class="number">4</span>,<span class="number">1</span>,<span class="keyword">null</span>);       <span class="comment">/* OK */</span></span><br><span class="line"><span class="comment">/* insert t1 values(5,1,1);*/</span>     <span class="comment">/* ERROR */</span></span><br></pre></td></tr></table></figure>



<h3 id="primary-key-与-unique-的背后"><a href="#primary-key-与-unique-的背后" class="headerlink" title="primary key 与 unique 的背后"></a>primary key 与 unique 的背后</h3><ul>
<li>系统自动生成一张约束系统表</li>
</ul>
<img src="04-6/image-20210504225355792.png" style="zoom:55%;" />



<h2 id="foreign-key"><a href="#foreign-key" class="headerlink" title="foreign key"></a>foreign key</h2><ul>
<li><strong>基本关系</strong>：主码所在的关系</li>
<li><strong>依赖关系</strong>：外码所在的关系</li>
<li>参照完整性<ul>
<li>当外码所在的表需要插入一个记录的时候，需要检查外码的值再主码中存在</li>
<li>当主码所在的表删除一个记录的时候，可能也会影响参照完整性</li>
</ul>
</li>
</ul>
<h3 id="foreign-key-的三种定义方式"><a href="#foreign-key-的三种定义方式" class="headerlink" title="foreign key 的三种定义方式"></a>foreign key 的三种定义方式</h3><h4 id="RESTRICT-方式"><a href="#RESTRICT-方式" class="headerlink" title="RESTRICT 方式"></a>RESTRICT 方式</h4><ul>
<li>只有当依赖关系中<strong>没有一个外码值</strong>与要删除（更新）的基本关系的主码值相对应时，才可以删除（更新）该行（的主码），否则系统<strong>拒绝此删除操作</strong></li>
</ul>
<h4 id="CASCADE方式"><a href="#CASCADE方式" class="headerlink" title="CASCADE方式"></a>CASCADE方式</h4><ul>
<li>将<strong>依赖关系</strong>中所有外码值与基本关系中要删除的主码值所对应的行<strong>一起删除</strong>（将依赖关系中所有与基本关系中要修改的主码值所对应的外码值一起修改为新值）</li>
</ul>
<h4 id="SET-NULL方式"><a href="#SET-NULL方式" class="headerlink" title="SET NULL方式"></a>SET NULL方式</h4><ul>
<li>删除（更新）基本关系中的行时，将<strong>依赖关系</strong>中与基本关系中被删（更新）主码值相对应的<strong>外码值置为空值</strong></li>
</ul>
<h2 id="表级约束"><a href="#表级约束" class="headerlink" title="表级约束"></a>表级约束</h2><ul>
<li>涉及多行或多表之间的联系</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> SC (</span><br><span class="line">    sno <span class="type">char</span>(<span class="number">8</span>),</span><br><span class="line">    cno <span class="type">char</span>(<span class="number">10</span>),</span><br><span class="line">    grade <span class="type">smallint</span>,</span><br><span class="line">    primay key(sno,cno),</span><br><span class="line">    <span class="keyword">check</span>(sno <span class="keyword">in</span>(<span class="keyword">select</span> sno <span class="keyword">from</span> S)),</span><br><span class="line">    <span class="keyword">check</span>(cno <span class="keyword">in</span>(<span class="keyword">select</span> cno <span class="keyword">from</span> C))</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<ul>
<li>好像是在声明外码约束，有一些细节上的区别<ul>
<li><strong>check 定义在 SC 中，当修改 S 表或 C 表的时候是不会有检查的</strong></li>
</ul>
</li>
</ul>
<h2 id="约束命名及其定义"><a href="#约束命名及其定义" class="headerlink" title="约束命名及其定义"></a>约束命名及其定义</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">constraint</span> 约束名<span class="operator">&lt;</span>约束条件<span class="operator">&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>撤销与添加约束</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> ... <span class="keyword">drop</span> <span class="keyword">constraint</span> ...</span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> ... <span class="keyword">add</span> <span class="keyword">constraint</span> ...</span><br></pre></td></tr></table></figure>

<ul>
<li>例子</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> S (</span><br><span class="line">    sno <span class="type">char</span>(<span class="number">8</span>) <span class="keyword">constraint</span> S_PK <span class="keyword">primary</span> key</span><br><span class="line">)</span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> S <span class="keyword">drop</span> <span class="keyword">constraint</span> S_PK</span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> SC <span class="keyword">add</span> <span class="keyword">constraint</span> SC_CHECK</span><br><span class="line">    <span class="keyword">check</span>(sno <span class="keyword">in</span>(<span class="keyword">select</span> sno <span class="keyword">from</span> S))</span><br></pre></td></tr></table></figure>



<h2 id="约束检查"><a href="#约束检查" class="headerlink" title="约束检查"></a>约束检查</h2><ul>
<li><strong>相互参照的表</strong>，如何插入行</li>
</ul>
<img src="04-6/image-20210504232355476.png" style="zoom:50%;" />

<ul>
<li>同样的问题，<strong>自参照的表</strong></li>
</ul>
<img src="04-6/image-20210504232541030.png" style="zoom:50%;" />

<ul>
<li>先 drop constraint，在插入之后再 add constraint<ul>
<li><strong>不可行的，可能会有不满足约束条件的数据混入，不安全</strong></li>
</ul>
</li>
<li>可以先整理成一个树形的结构，然后从根部开始插入数据</li>
</ul>
<h2 id="延迟约束"><a href="#延迟约束" class="headerlink" title="延迟约束"></a>延迟约束</h2><ul>
<li>deferred constraints<ul>
<li>将<strong>多个更新操作语句放入一个事务</strong>，在提交时才检查约束</li>
</ul>
</li>
<li>如何设置延迟约束</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* 在约束创建时 */</span></span><br><span class="line">[<span class="keyword">not</span>] deferrable</span><br><span class="line">initially deferred [immediate]</span><br><span class="line"><span class="comment">/* 对现有约束 */</span></span><br><span class="line"><span class="keyword">set</span> <span class="keyword">constraint</span> 约束名 deferried</span><br></pre></td></tr></table></figure>

<ul>
<li>例子</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> emp(</span><br><span class="line">    eno     <span class="type">char</span>(<span class="number">10</span>) <span class="keyword">primary</span> key,</span><br><span class="line">    ename   <span class="type">char</span>(<span class="number">20</span>),</span><br><span class="line">    mgr     <span class="type">char</span>(<span class="number">10</span>) <span class="keyword">constraint</span> FK_Constraint   <span class="keyword">foreign</span> key</span><br><span class="line">                    <span class="keyword">references</span>  emp(eno)</span><br><span class="line">                    deferrable initially immediate <span class="comment">/* 初始的时候立即检查 */</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 在导入数据的时候,设置延迟约束 */</span></span><br><span class="line"><span class="keyword">set</span> <span class="keyword">constraint</span> FK_Constraint deferried</span><br></pre></td></tr></table></figure>



<h3 id="SQL-Server-的约束开关"><a href="#SQL-Server-的约束开关" class="headerlink" title="SQL Server 的约束开关"></a>SQL Server 的约束开关</h3><ul>
<li>with nocheck</li>
<li>暂时关闭约束开关</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> t1(col_a <span class="type">INT</span>)</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> t1 <span class="keyword">values</span>(<span class="number">-1</span>)</span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> t1 <span class="keyword">with</span> nocheck</span><br><span class="line"><span class="keyword">add</span> <span class="keyword">constraint</span> skip_check <span class="keyword">check</span>(col_a <span class="operator">&gt;</span> <span class="number">1</span>)</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> t1 <span class="keyword">values</span>(<span class="number">-2</span>) <span class="comment">/* 可以执行 */</span></span><br></pre></td></tr></table></figure>

<ul>
<li><strong>禁用</strong>并<strong>重新启用</strong>一个约束(nocheck)</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> t1 nocheck <span class="keyword">constraint</span> skip_check</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> t1 <span class="keyword">VALUES</span>(<span class="number">-2</span>)</span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> t1 <span class="keyword">check</span> <span class="keyword">constraint</span> skip_check</span><br></pre></td></tr></table></figure>

<ul>
<li>上面的操作很危险，可能混入不满足约束条件的记录</li>
<li>SQL Server 提供了一个补救措施</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* 列出不满足条件的行记忆他们不满足哪一个约束条件 */</span></span><br><span class="line">dbcc checkconstraints</span><br></pre></td></tr></table></figure>



<h2 id="函数约束"><a href="#函数约束" class="headerlink" title="函数约束"></a>函数约束</h2><ul>
<li>约束条件非常复杂，简单的 check 无法实现</li>
</ul>
<h3 id="例子-1"><a href="#例子-1" class="headerlink" title="例子 1"></a>例子 1</h3><ul>
<li>当插入一个新行的时候，使用的值是当前没有使用的最小值</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* 创建表 */</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> noGap(</span><br><span class="line">    <span class="keyword">no</span> <span class="type">int</span> <span class="keyword">primary</span> key,</span><br><span class="line">    name <span class="type">varchar</span>(<span class="number">10</span>)</span><br><span class="line">)</span><br><span class="line"><span class="comment">/* 函数约束 */</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">function</span> fn_noGap_minUnusedKey()</span><br><span class="line"><span class="keyword">returns</span> <span class="type">int</span> <span class="keyword">as</span></span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">    <span class="comment">/* 尚未申请则返回 1 */</span></span><br><span class="line">    if(<span class="keyword">not</span> <span class="keyword">exists</span>(<span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> noGap <span class="keyword">where</span> <span class="keyword">no</span> <span class="operator">=</span> <span class="number">1</span>)) <span class="keyword">return</span> <span class="number">1</span></span><br><span class="line">    <span class="keyword">declare</span> <span class="variable">@min</span>_unused_no <span class="type">int</span></span><br><span class="line">    <span class="keyword">select</span> <span class="variable">@min</span>_unused_no <span class="operator">=</span> <span class="built_in">min</span>(<span class="keyword">no</span> <span class="operator">+</span> <span class="number">1</span>)</span><br><span class="line">    <span class="keyword">from</span> noGap NO1</span><br><span class="line">    <span class="keyword">where</span> <span class="keyword">not</span> <span class="keyword">exists</span>(</span><br><span class="line">        <span class="keyword">select</span> <span class="operator">*</span></span><br><span class="line">        <span class="keyword">from</span> noGap NO2</span><br><span class="line">        <span class="keyword">where</span> NO2.no <span class="operator">=</span> NO1.no <span class="operator">+</span> <span class="number">1</span></span><br><span class="line">    )</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">@min</span>_unused_no</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* 使用约束 */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> noGap</span><br><span class="line">      <span class="keyword">add</span> <span class="keyword">constraint</span> DF_no <span class="keyword">default</span>(fn_noGap_minUnusedKey())<span class="keyword">for</span> <span class="keyword">no</span></span><br></pre></td></tr></table></figure>

<h3 id="例子-2"><a href="#例子-2" class="headerlink" title="例子 2"></a>例子 2</h3><ul>
<li>选课人数不能超过 100</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">function</span> fn_registerCount(<span class="variable">@cno</span> <span class="type">varchar</span> )</span><br><span class="line"><span class="keyword">returns</span> <span class="type">int</span> <span class="keyword">as</span></span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">        selectcount(<span class="operator">*</span>)</span><br><span class="line">        <span class="keyword">from</span> sc</span><br><span class="line">        <span class="keyword">where</span> cno<span class="operator">=</span> <span class="variable">@cno</span></span><br><span class="line">    )</span><br><span class="line"><span class="keyword">End</span></span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> sc</span><br><span class="line">      <span class="keyword">add</span> <span class="keyword">constraint</span> CK_registerCount <span class="keyword">check</span>(fn_registerCount(cno) <span class="operator">&lt;=</span> <span class="number">100</span>)</span><br></pre></td></tr></table></figure>



<h2 id="assertion"><a href="#assertion" class="headerlink" title="assertion"></a>assertion</h2><ul>
<li>实际数据库不支持</li>
<li>检查开销太大了</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* AtoB 只能有一条路径 */</span></span><br><span class="line"><span class="keyword">create</span> assertion AtoB <span class="keyword">check</span> (</span><br><span class="line">    <span class="keyword">not</span> <span class="keyword">exists</span> (</span><br><span class="line">        <span class="keyword">select</span> A</span><br><span class="line">        <span class="keyword">from</span> R</span><br><span class="line">        <span class="keyword">group</span> <span class="keyword">by</span> A</span><br><span class="line">        <span class="keyword">having</span> <span class="built_in">count</span>(<span class="keyword">distinct</span> B) <span class="operator">&gt;</span> <span class="number">1</span></span><br><span class="line">    )</span><br><span class="line">)</span><br></pre></td></tr></table></figure>


      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/05/03/DB/CLJ/04-6/" data-id="cl9lj74au00f664tzhkdbexa5" data-title="数据库概论.陈立军.04.SQL 完整性" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/DB/" rel="tag">DB</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-OS/xv6-labs/lab6-multi-threading" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/05/02/OS/xv6-labs/lab6-multi-threading/" class="article-date">
  <time class="dt-published" datetime="2021-05-02T04:00:00.000Z" itemprop="datePublished">2021-05-02</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/OS-xv6-labs/">OS.xv6-labs</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2021/05/02/OS/xv6-labs/lab6-multi-threading/">xv6-labs-2020.lab6.Multi threading</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="lab6-Multi-threading"><a href="#lab6-Multi-threading" class="headerlink" title="lab6 Multi-threading"></a>lab6 Multi-threading</h1><h2 id="1-作业链接"><a href="#1-作业链接" class="headerlink" title="1.作业链接"></a>1.作业链接</h2><ul>
<li><a target="_blank" rel="noopener" href="https://pdos.csail.mit.edu/6.828/2020/labs/thread.html">https://pdos.csail.mit.edu/6.828/2020/labs/thread.html</a></li>
</ul>
<h2 id="2-实习内容"><a href="#2-实习内容" class="headerlink" title="2. 实习内容"></a>2. 实习内容</h2><h3 id="Uthread-switching-between-threads"><a href="#Uthread-switching-between-threads" class="headerlink" title="Uthread: switching between threads"></a>Uthread: switching between threads</h3><ul>
<li>实现用户态的线程调度</li>
<li>这一部分主要是是实现在线程切换的时候的寄存器的保存与恢复</li>
<li>具体要做的是修改如下代码，实现上述功能<ul>
<li><code>user/uthread.c</code> 中的 <code>thread_create()</code> 、<code>thread_schedule()</code></li>
<li><code>user/uthread_switch.S</code> 中的 <code>thread_switch</code></li>
</ul>
</li>
<li>具体功能<ul>
<li>当 <code>thread_schedule()</code> 调度到一个线程，而且这个线程是第一次被调度时，这个线程应该转向 <code>thread_create()</code>，而且需要在它自己的栈上执行</li>
<li><code>thread_swtich()</code> 实现寄存器的保存与恢复<ul>
<li>可以保存在 <code>struct thread</code> 中</li>
<li>在 <code>thread_schedule()</code> 中调用 <code>thread_switch()</code></li>
</ul>
</li>
</ul>
</li>
<li>注意这里的线程调度实现：<code>user/uthread</code><ul>
<li>事先准备好线程的所有线程的上下文，然后再进行调度，因此 <code>thread_schedule()</code> 只需要设置好具体执行上下文的内容，而不需要修改寄存器的值</li>
</ul>
</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> *argv[])</span> &#123;</span><br><span class="line">    a_started = b_started = c_started = <span class="number">0</span>;</span><br><span class="line">    a_n = b_n = c_n = <span class="number">0</span>;</span><br><span class="line">    thread_init();</span><br><span class="line">    <span class="comment">// 先准备好线程, 最后再开始调度</span></span><br><span class="line">    thread_create(thread_a);</span><br><span class="line">    thread_create(thread_b);</span><br><span class="line">    thread_create(thread_c);</span><br><span class="line">    thread_schedule();</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<h4 id="1-user-x2F-uthread-c"><a href="#1-user-x2F-uthread-c" class="headerlink" title="(1) user&#x2F;uthread.c"></a>(1) user&#x2F;uthread.c</h4><ul>
<li>这一部分的实现可以参考 <code>kernel/swtch.S</code>、<code>kernel/proc.h</code></li>
</ul>
<h5 id="struct-thread"><a href="#struct-thread" class="headerlink" title="struct thread"></a>struct thread</h5><ul>
<li>修改数据结构 <code>struct thread</code></li>
<li>开辟一块区域，用于切换线程的时候的寄存器保存<ul>
<li>只需要保存 <code>callee-save</code>  寄存器，因为 <code>caller-saved</code> 寄存器在调用函数之前就被保存在栈上了，而每一个线程的栈是独立的，不会修改其他线程的栈，到时候执行权回到该线程的时候，可以直接通过栈恢复 <code>caller-saved</code> 寄存器</li>
</ul>
</li>
<li>RISC-V 中的寄存器如下</li>
</ul>
<img src="lab6-multithreading/image-20210410115522565.png" style="zoom: 67%;" />

<ul>
<li>数据结构修改如下</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 需要保存的寄存器</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">thread_frame</span> &#123;</span></span><br><span class="line">    <span class="comment">// 通过记录这些寄存器实现切换</span></span><br><span class="line">    <span class="comment">// uint64 tp; 好像不会用到这个寄存器</span></span><br><span class="line">    uint64 ra;</span><br><span class="line">    uint64 sp;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// callee-saved</span></span><br><span class="line">    uint64 s0;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    uint64 s11;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">thread</span> &#123;</span></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="comment">// 需要保存的寄存器</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">thread_frame</span> <span class="title">tf</span>;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<ul>
<li>定义函数 <code>thread_switch(&amp;old, &amp;new)</code> 的作用如下<ul>
<li>将当前的寄存器状态保存到 <code>old</code> 地址中</li>
<li>使用 <code>new</code> 地址中的寄存器代替当前的寄存器状态</li>
</ul>
</li>
</ul>
<h5 id="thread-schedule"><a href="#thread-schedule" class="headerlink" title="thread_schedule()"></a>thread_schedule()</h5><ul>
<li>添加切换线程的函数</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">thread_schedule</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">if</span> (current_thread != next_thread) &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">        <span class="comment">// 注意之前修改了变量指向</span></span><br><span class="line">        thread_switch((uint64)&amp;t-&gt;tf, (uint64)&amp;current_thread-&gt;tf);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h5 id="thread-create"><a href="#thread-create" class="headerlink" title="thread_create()"></a>thread_create()</h5><ul>
<li>在新建一个线程的时候需要从数组中找一个状态为 <code>FREE</code> 的线程，将其用于调用<ul>
<li>这里没有做新建线程时已经没有状态为 <code>FREE</code> 的情况的判断</li>
</ul>
</li>
<li>做完之后将返回值设置为他自己的栈结构</li>
<li>修改上面 <code>strcut threadframe</code> 中的变量 <code>ra</code>、<code>sp</code></li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">thread_create</span><span class="params">(<span class="type">void</span> (*func)())</span> &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    t-&gt;tf.ra = (uint64)func;</span><br><span class="line">    <span class="comment">// 指向栈底(上往下增长)</span></span><br><span class="line">    t-&gt;tf.sp = (uint64)&amp;t-&gt;<span class="built_in">stack</span> + STACK_SIZE;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<h4 id="2-user-x2F-thread-switch-S"><a href="#2-user-x2F-thread-switch-S" class="headerlink" title="(2) user&#x2F;thread_switch.S"></a>(2) user&#x2F;thread_switch.S</h4><ul>
<li>根据 <code>thread_switch(&amp;old, &amp;new)</code>  的含义确定如何操作寄存器</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">.text</span><br><span class="line"># 将当前的寄存器状态保存到 a0 地址中</span><br><span class="line"># 使用 a1 地址中的寄存器代替当前的寄存器状态</span><br><span class="line">.globl thread_switch</span><br><span class="line">thread_switch:</span><br><span class="line">    sd ra, 0(a0)</span><br><span class="line">    sd sp, 8(a0)</span><br><span class="line">    sd s0, 16(a0)</span><br><span class="line">    /* ... */</span><br><span class="line">    sd s11, 104(a0)</span><br><span class="line"></span><br><span class="line">    ld ra, 0(a1)</span><br><span class="line">    ld sp, 8(a1)</span><br><span class="line">    ld s0, 16(a1)</span><br><span class="line">    /* ... */</span><br><span class="line">    ld s11, 104(a1)</span><br><span class="line">    ret</span><br></pre></td></tr></table></figure>



<h3 id="Using-threads"><a href="#Using-threads" class="headerlink" title="Using threads"></a>Using threads</h3><ul>
<li>使用 pthreads 库进行多线程编程</li>
<li>在真正的 Linux 机器上跑代码</li>
</ul>
<h4 id="1-问题"><a href="#1-问题" class="headerlink" title="(1) 问题"></a>(1) 问题</h4><ul>
<li>Why are there missing keys with 2 threads, but not with 1 thread? Identify a sequence of events with 2 threads that can lead to a key being missing.</li>
<li>当线程1在插入一个键值对的时候，此时另外一个线程同时读取了未插入的状态开始执行，此时两个线程的插入实际上是只是插入了一个元素<ul>
<li>具体分析看如下代码</li>
</ul>
</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">put</span><span class="params">(<span class="type">int</span> key, <span class="type">int</span> value)</span> &#123;</span><br><span class="line">    <span class="type">int</span> i = key % NBUCKET;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">entry</span> *<span class="title">e</span> =</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (e = table[i]; e != <span class="number">0</span>; e = e-&gt;next) &#123;</span><br><span class="line">        <span class="keyword">if</span> (e-&gt;key == key)</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 此时线程1运行到这里,同时线程2开始执行 put() 函数</span></span><br><span class="line">    <span class="comment">// 然后在线程1执行到 insert() 之前运行到了这里</span></span><br><span class="line">    <span class="comment">// 那么线程2和线程1插入的位置是同一个, 也就是说最终只插入了一个元素</span></span><br><span class="line">    <span class="keyword">if</span>(e)&#123;</span><br><span class="line">        e-&gt;value = value;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        insert(key, value, &amp;table[i], table[i]);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="2-notxv6-x2F-ph-c"><a href="#2-notxv6-x2F-ph-c" class="headerlink" title="(2) notxv6&#x2F;ph.c"></a>(2) notxv6&#x2F;ph.c</h4><ul>
<li>使用 lock 解决，要求总时间（各线程耗时之和）不能超过原来的 1.25 倍</li>
<li>只有 <code>put()</code> 函数需要加锁</li>
<li>看完提示就 OK 了</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">pthread_mutex_t</span> lock;            <span class="comment">// declare a lock</span></span><br><span class="line">pthread_mutex_init(&amp;lock, <span class="literal">NULL</span>); <span class="comment">// initialize the lock</span></span><br><span class="line">pthread_mutex_lock(&amp;lock);       <span class="comment">// acquire lock</span></span><br><span class="line">pthread_mutex_unlock(&amp;lock);     <span class="comment">// release lock</span></span><br></pre></td></tr></table></figure>



<h5 id="解法-1"><a href="#解法-1" class="headerlink" title="解法 1"></a>解法 1</h5><ul>
<li>只加一个锁</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">put</span><span class="params">(<span class="type">int</span> key, <span class="type">int</span> value)</span> &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    pthread_mutex_lock(&amp;lock);       <span class="comment">// acquire lock</span></span><br><span class="line">    <span class="keyword">for</span> (e = table[i]; e != <span class="number">0</span>; e = e-&gt;next) &#123;</span><br><span class="line">        <span class="keyword">if</span> (e-&gt;key == key)</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(e)&#123;</span><br><span class="line">        e-&gt;value = value;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// the new is new.</span></span><br><span class="line">        insert(key, value, &amp;table[i], table[i]);</span><br><span class="line">    &#125;</span><br><span class="line">    pthread_mutex_unlock(&amp;lock);     <span class="comment">// release lock</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>过不了测试</li>
</ul>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ph_safe: OK (37.1s)</span><br><span class="line">ph_fast: FAIL (76.1s)</span><br></pre></td></tr></table></figure>



<h5 id="解法2"><a href="#解法2" class="headerlink" title="解法2"></a>解法2</h5><ul>
<li>为每一个 bucket 加一个锁</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">put</span><span class="params">(<span class="type">int</span> key, <span class="type">int</span> value)</span> &#123;</span><br><span class="line">    <span class="type">int</span> i = key % NBUCKET;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">entry</span> *<span class="title">e</span> =</span> <span class="number">0</span>;</span><br><span class="line">    pthread_mutex_lock(&amp;lock[i]);       <span class="comment">// acquire lock</span></span><br><span class="line">    <span class="keyword">for</span> (e = table[i]; e != <span class="number">0</span>; e = e-&gt;next) &#123;</span><br><span class="line">        <span class="keyword">if</span> (e-&gt;key == key)</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(e)&#123;</span><br><span class="line">        e-&gt;value = value;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        insert(key, value, &amp;table[i], table[i]);</span><br><span class="line">    &#125;</span><br><span class="line">    pthread_mutex_unlock(&amp;lock[i]);     <span class="comment">// release lock</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ph_safe: OK (29.2s)</span><br><span class="line">ph_fast: OK (62.3s)</span><br></pre></td></tr></table></figure>



<h3 id="Barrier"><a href="#Barrier" class="headerlink" title="Barrier"></a>Barrier</h3><ul>
<li>要求<ul>
<li>实现一个 barrier（应用程序中的一个点），所有参与线程必须在该点等待，直到所有其他参与线程也都到达该点</li>
<li>Linux 条件变量实现</li>
</ul>
</li>
<li>需要在真正的 Linux 机器上跑代码</li>
<li>看提示<ul>
<li><code>pthread_cond_wait</code> releases the <code>mutex</code> when called, and re-acquires the <code>mutex</code> before returning.</li>
</ul>
</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pthread_cond_wait(&amp;cond, &amp;mutex);  <span class="comment">// go to sleep on cond, releasing lock mutex, acquiring upon wake up</span></span><br><span class="line">pthread_cond_broadcast(&amp;cond);     <span class="comment">// wake up every thread sleeping on cond</span></span><br></pre></td></tr></table></figure>

<ul>
<li>实现 <code>notxv6/barrier.c</code> 中的 <code>barrier()</code> 函数即可</li>
<li>同时需要实现支持多次 barrier，每一轮将记录变量 round + 1</li>
</ul>
<h4 id="1-notxv6-x2F-barrier-c"><a href="#1-notxv6-x2F-barrier-c" class="headerlink" title="(1) notxv6&#x2F;barrier.c"></a>(1) notxv6&#x2F;barrier.c</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">barrier</span><span class="params">()</span> &#123;</span><br><span class="line">    pthread_mutex_lock(&amp;bstate.barrier_mutex);</span><br><span class="line">    ++bstate.nthread;</span><br><span class="line">    <span class="keyword">if</span>(bstate.nthread != nthread) &#123;</span><br><span class="line">        pthread_cond_wait(&amp;bstate.barrier_cond, &amp;bstate.barrier_mutex);</span><br><span class="line">        <span class="comment">// 注意调用这个函数的时候会释放锁, 凡是返回到这个函数的时候会重新等待获得锁</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        ++bstate.round;</span><br><span class="line">        bstate.nthread = <span class="number">0</span>;</span><br><span class="line">        pthread_cond_broadcast(&amp;bstate.barrier_cond);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 所以得释放</span></span><br><span class="line">    pthread_mutex_unlock(&amp;bstate.barrier_mutex);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="3-实验结果"><a href="#3-实验结果" class="headerlink" title="3. 实验结果"></a>3. 实验结果</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">$ make qemu-gdb</span><br><span class="line">uthread: OK (13.4s)</span><br><span class="line">== Test answers-thread.txt == answers-thread.txt: OK</span><br><span class="line">== Test ph_safe == make[1]: Entering directory <span class="string">&#x27;/home/banbao990/xv6-labs-2020&#x27;</span></span><br><span class="line">make[1]: <span class="string">&#x27;ph&#x27;</span> is up to <span class="built_in">date</span>.</span><br><span class="line">make[1]: Leaving directory <span class="string">&#x27;/home/banbao990/xv6-labs-2020&#x27;</span></span><br><span class="line">ph_safe: OK (27.3s)</span><br><span class="line">== Test ph_fast == make[1]: Entering directory <span class="string">&#x27;/home/banbao990/xv6-labs-2020&#x27;</span></span><br><span class="line">make[1]: <span class="string">&#x27;ph&#x27;</span> is up to <span class="built_in">date</span>.</span><br><span class="line">make[1]: Leaving directory <span class="string">&#x27;/home/banbao990/xv6-labs-2020&#x27;</span></span><br><span class="line">ph_fast: OK (63.8s)</span><br><span class="line">== Test barrier == make[1]: Entering directory <span class="string">&#x27;/home/banbao990/xv6-labs-2020&#x27;</span></span><br><span class="line">make[1]: <span class="string">&#x27;barrier&#x27;</span> is up to <span class="built_in">date</span>.</span><br><span class="line">make[1]: Leaving directory <span class="string">&#x27;/home/banbao990/xv6-labs-2020&#x27;</span></span><br><span class="line">barrier: OK (12.8s)</span><br><span class="line">== Test time ==</span><br><span class="line">time: OK</span><br><span class="line">Score: 60/60</span><br></pre></td></tr></table></figure>



<h2 id="4-遇到的困难以及收获"><a href="#4-遇到的困难以及收获" class="headerlink" title="4. 遇到的困难以及收获"></a>4. 遇到的困难以及收获</h2><ul>
<li>这个 lab 相对比较简单</li>
<li>第一部分就是简单的仿造内核的 <code>swtch.S</code> 以及 <code>proc.h</code> 编写代码即可</li>
<li>后面两个部分就是使用 pthread 库进行多线程代码的编写</li>
<li>锁加的位置对整体的性能可能会有较大影响，需要仔细考虑</li>
</ul>
<h2 id="5-对课程或-lab-的意见和建议"><a href="#5-对课程或-lab-的意见和建议" class="headerlink" title="5. 对课程或 lab 的意见和建议"></a>5. 对课程或 lab 的意见和建议</h2><ul>
<li>暂时没有建议</li>
</ul>
<h2 id="6-参考文献"><a href="#6-参考文献" class="headerlink" title="6. 参考文献"></a>6. 参考文献</h2><ul>
<li><a target="_blank" rel="noopener" href="https://pdos.csail.mit.edu/6.828/2019/xv6/book-riscv-rev0.pdf">https://pdos.csail.mit.edu/6.828/2019/xv6/book-riscv-rev0.pdf</a></li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/05/02/OS/xv6-labs/lab6-multi-threading/" data-id="cl9lj74bd00ix64tzd6qe5ota" data-title="xv6-labs-2020.lab6.Multi threading" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/OS/" rel="tag">OS</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/xv6/" rel="tag">xv6</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-CG/YLQ-GAMES202/08" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/04/29/CG/YLQ-GAMES202/08/" class="article-date">
  <time class="dt-published" datetime="2021-04-29T06:11:31.000Z" itemprop="datePublished">2021-04-29</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/CG-GAMES202/">CG.GAMES202</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2021/04/29/CG/YLQ-GAMES202/08/">GAMES202.闫令琪.08.实时全局光照(屏幕空间)(SSAO/SSDO)</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <ul>
<li><a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1YK4y1T7yY">https://www.bilibili.com/video/BV1YK4y1T7yY</a></li>
</ul>
<h1 id="屏幕空间全局光照"><a href="#屏幕空间全局光照" class="headerlink" title="屏幕空间全局光照"></a>屏幕空间全局光照</h1><h2 id="屏幕空间"><a href="#屏幕空间" class="headerlink" title="屏幕空间"></a>屏幕空间</h2><ul>
<li>所有拿到的信息都是在屏幕上的</li>
<li>之后使用的信息只能是直接光照形成的结果</li>
<li>相当于是对得到的二维图像进行一个后处理</li>
</ul>
<h2 id="SSAO"><a href="#SSAO" class="headerlink" title="SSAO"></a>SSAO</h2><ul>
<li>Screen Space Ambient Occlusion</li>
<li>屏幕空间环境光遮蔽</li>
<li>AO 的结果：contact shadow<ul>
<li>物体接触的地方会有阴影</li>
</ul>
</li>
<li>SSAO：对于全局光照的一个近似<ul>
<li>屏幕空间内的信息进行计算</li>
</ul>
</li>
</ul>
<h3 id="关键假设"><a href="#关键假设" class="headerlink" title="关键假设"></a>关键假设</h3><ul>
<li>我们不知道入射光的方向</li>
<li>我们可以假设，对于所有的 shading point，所有的入射方向，光照都是一个常数<ul>
<li>环境光</li>
</ul>
</li>
<li>但是不同地方接受到的环境光的强度应该是不一样的，通过某种方式对于环境光的强度进行估计</li>
</ul>
<img src="08/image-20210429164516719.png" style="zoom:50%;" />

<ul>
<li>同时我们假设所有的物体都是 diffuse 的</li>
</ul>
<img src="08/image-20210429164733058.png" style="zoom:50%;" />



<h3 id="理论基础-环境光"><a href="#理论基础-环境光" class="headerlink" title="理论基础(环境光)"></a>理论基础(环境光)</h3><ul>
<li>渲染方程</li>
</ul>
<p>$$<br>L_o(p,\omega_o)&#x3D;<br>\int_{\Omega^+}L_i(p,\omega_i)f_r(p,\omega_i,\omega_o) V(p,\omega_i)\cos\theta_i,\mathrm{d}\omega_i<br>$$</p>
<ul>
<li>利用之前的经典不等式<ul>
<li>$g(x)$：smooth &#x2F; small support</li>
</ul>
</li>
</ul>
<p>$$<br>\int_\Omega f(x)g(x),\mathrm{d}x\approx \dfrac{\int_\Omega f(x),\mathrm{d}x}{\int_\Omega ,\mathrm{d}x}\cdot {\int_\Omega g(x),\mathrm{d}x}<br>$$</p>
<ul>
<li>近似结果<ul>
<li><strong>多了一项 $\cos\theta_i$，后面会解释</strong></li>
<li>可以把 $\cos\theta_i,\mathrm{d}\omega_i$ 整个看成是一项 $\mathrm{d}x_{\perp}$</li>
</ul>
</li>
</ul>
<p>$$<br>L_o(p,\omega_o)\approx<br>{\color{blue}\dfrac{\int_{\Omega^+}V(p,\omega_i)\cos\theta_i,\mathrm{d}\omega_i}{\int_{\Omega^+}\cos\theta_i,\mathrm{d}\omega_i}}<br>\cdot<br>{\color{red}\int_{\Omega^+}L_i(p,\omega_i)f_r(p,\omega_i,\omega_o)\cos\theta_i,\mathrm{d}\omega_i}<br>$$</p>
<ul>
<li><span style="color:blue">蓝色</span>部分<ul>
<li>平均可见性</li>
</ul>
</li>
</ul>
<p>$$<br>{\color{blue}k_A}&#x3D;\dfrac{\int_{\Omega^+}V(p,\omega_i)\cos\theta_i,\mathrm{d}\omega_i}{\pi}<br>$$</p>
<ul>
<li><span style="color:red">红色</span>部分<ul>
<li>diffuse，BRDF 是常数</li>
<li>光照为 constant，L 为常数</li>
<li>都可以随便指定</li>
</ul>
</li>
</ul>
<p>$$<br>L_{i}^{indir}(p)\cdot\dfrac{\rho}{\pi}\cdot\pi&#x3D;L_{i}^{indir}(p)\cdot\rho<br>$$</p>
<ul>
<li>AO 可以理解为<ul>
<li>平均的 visibility x 你给定的一个数</li>
</ul>
</li>
</ul>
<h4 id="一种理解"><a href="#一种理解" class="headerlink" title="一种理解"></a>一种理解</h4><p>$$<br>\int_\Omega f(x)g(x),\mathrm{d}x\approx \dfrac{\int_\Omega f(x),\mathrm{d}x}{\int_\Omega ,\mathrm{d}x}\cdot {\int_\Omega g(x),\mathrm{d}x}&#x3D;\overline{f(x)}\int_\Omega g(x),\mathrm{d}x<br>$$</p>
<ul>
<li>我们可以认为，是在求一个 $f(x)$ 在 $g(x)$ 的定义域 $\Omega$ 上求一个平均值</li>
</ul>
<h4 id="准确的条件"><a href="#准确的条件" class="headerlink" title="准确的条件"></a>准确的条件</h4><ul>
<li>$g(x)$：smooth &#x2F; small support</li>
<li>所以 AO 的拆分是准确的<ul>
<li>$G$ 是常数</li>
</ul>
</li>
</ul>
<h4 id="另一种理解"><a href="#另一种理解" class="headerlink" title="另一种理解"></a>另一种理解</h4><ul>
<li><strong>拆分后为什么多了一项 $\cos\theta_i$</strong></li>
</ul>
<img src="08/image-20210429193728599.png" style="zoom:50%;" />

<ul>
<li>$\mathrm{d}x_{\perp}&#x3D;\cos\theta_i,\mathrm{d}\omega_i$ 刚好是立体角投影到平面上的结果</li>
<li>所以我们可以把 $\cos\theta_i,\mathrm{d}\omega_i$ 整个看成是一项 $\mathrm{d}x_{\perp}$</li>
</ul>
<h3 id="SSAO-的简单理解"><a href="#SSAO-的简单理解" class="headerlink" title="SSAO 的简单理解"></a>SSAO 的简单理解</h3><ul>
<li>光照为常数，BRDF 为常数</li>
<li>可以从积分项中拿出来</li>
</ul>
<p>$$<br>\begin{aligned}<br>L_o(p,\omega_o)&amp;&#x3D;<br>\int_{\Omega^+}L_i(p,\omega_i)f_r(p,\omega_i,\omega_o) V(p,\omega_i)\cos\theta_i,\mathrm{d}\omega_i\<br>&amp;&#x3D;\dfrac{\rho}{\pi}\cdot L_i(p)\cdot\int_{\Omega^+}V(p,\omega_i)\cos\theta_i,\mathrm{d}\omega_i<br>\end{aligned}<br>$$</p>
<h3 id="怎么求解可见性-屏幕空间"><a href="#怎么求解可见性-屏幕空间" class="headerlink" title="怎么求解可见性(屏幕空间)"></a>怎么求解可见性(屏幕空间)</h3><ul>
<li>对于某一个 shading point，我们对其法相半球进行采样，求平均可见性</li>
<li>发出 trace 光线，光线距离R，进行可见性判断</li>
</ul>
<img src="08/image-20210429195523419.png" style="zoom:50%;" />

<ul>
<li>选取一个指定的半径 R<ul>
<li>R 不能太大，否则最终都会被挡住（想象一个封闭的屋子）</li>
<li>R 不能太小，否则会忽略一些来自于更远的反射光</li>
<li>trade off</li>
</ul>
</li>
</ul>
<h3 id="实际求解可见性的方法"><a href="#实际求解可见性的方法" class="headerlink" title="实际求解可见性的方法"></a>实际求解可见性的方法</h3><ul>
<li>利用 z-buffer</li>
<li>直接去 trace 光线很难做</li>
</ul>
<img src="08/image-20210429195932778.png" style="zoom:67%;" />

<ul>
<li>对于任何一个 shading point，我们对其周围半径 R 内的球体内进行采样</li>
<li>利用深度图（正常光栅化渲染管线渲染都会生成一张深度图）</li>
<li>对每一个采样点，我们将其和深度图中记录的深度作比较<ul>
<li>采样点经过投影变换得到的深度值如果比深度图中记录的要大，说明被挡住了</li>
</ul>
</li>
<li>但是这样子是有可能出错的，毕竟记录的是一个 2D 的信息<ul>
<li>中间那幅图的红色虚线右边的点</li>
<li>它在物体外部，但是根据 SM 的出来的值是在物体内部</li>
<li>SM 中无法记录复杂的几何信息</li>
<li>这样子的小错误在工业界是可以容忍的</li>
</ul>
</li>
<li>早期使用的是整个球体的采样，而不是法向半球采样，实际上我们使用法相半球采样才是正确的<ul>
<li>因为早期渲染管线，在最后无法保留法线的值，于是只能用整个球体的采样</li>
<li>早期的解决方案<ul>
<li><strong>只有在红点个数（被遮挡的点个数）过半的情况下，才开始考虑 AO</strong></li>
</ul>
</li>
</ul>
</li>
<li>现在我们直接使用法向半球采样</li>
</ul>
<h3 id="SSAO-的问题"><a href="#SSAO-的问题" class="headerlink" title="SSAO 的问题"></a>SSAO 的问题</h3><img src="08/image-20210429201816674.png" style="zoom:57%;" />

<ul>
<li>可能会出现一些虚假的 AO（false occlusion）</li>
<li>如右图中，石凳和地面应该没有接触，因此不应该有 AO 的效果，但是我们在之前简单的考虑遮挡，就会产生这样的现象</li>
<li>工业界的解决方案，使用一个半径 R，大于半径 R，我们认为不遮挡</li>
<li>采样点越多，AO 的效果越好<ul>
<li>怎么在采样点少的情况下获得噪声比较小的结果</li>
<li>先做 AO，然后做一个高斯模糊（去噪）</li>
</ul>
</li>
</ul>
<h2 id="HBAO"><a href="#HBAO" class="headerlink" title="HBAO"></a>HBAO</h2><ul>
<li>Horizon based ambient occlusion</li>
<li>SSAO 的改进<ul>
<li>在<strong>法向半球</strong>内采样</li>
<li>考虑半径 <strong>R</strong></li>
</ul>
</li>
</ul>
<h2 id="SSDO"><a href="#SSDO" class="headerlink" title="SSDO"></a>SSDO</h2><ul>
<li>对 SSAO 的提高</li>
<li>对于间接光照，我们没必要假设所有方向来的光是一样的</li>
<li>我们在一定程度上是能够知道间接光照的<ul>
<li>从屏幕空间中来</li>
</ul>
</li>
</ul>
<p><img src="/08/image-20210505102400590.png"></p>
<ul>
<li>SSAO 只能产生变亮变暗的效果，但是不能模拟颜色的变化</li>
<li>做法和 path tracing 很像<ul>
<li>从 shading point 随机打出射线</li>
<li>如果射线击中了某个物体，产生间接光照</li>
<li>如果涉嫌没有击中物体，直接光照</li>
</ul>
</li>
</ul>
<h3 id="AO-与-DO"><a href="#AO-与-DO" class="headerlink" title="AO 与 DO"></a>AO 与 DO</h3><ul>
<li>AO 与 DO 的假设是完全相反的<ul>
<li>AO 假设间接光照来自于非常远的地方</li>
<li>DO 假设间接光照来自于周围相近的地方</li>
</ul>
</li>
<li>红色圈内的射线<ul>
<li>AO 认为有间接光照（没有被物体挡住）</li>
<li>DO 认为没有间接光照（没有击中次级光源&#x2F;物体）</li>
</ul>
</li>
<li>黄色圈内的射线<ul>
<li>AO 认为没有间接光照（被物体挡住了）</li>
<li>DO 认为有间接光照（接种了次级光源&#x2F;物体）</li>
</ul>
</li>
</ul>
<img src="08/image-20210505102850841.png" style="zoom:50%;" />



<h3 id="SSDO-的实现"><a href="#SSDO-的实现" class="headerlink" title="SSDO 的实现"></a>SSDO 的实现</h3><ul>
<li>如果没有击中物体，没有间接光照（可能是环境光或者是直接光照）</li>
</ul>
<p>$$<br>L_o^{dir}(p,\omega_o)&#x3D;<br>\int_{\Omega^+;V&#x3D;1}L_i^{dir}(p,\omega_i)f_r(p,\omega_i,\omega_o) \cos\theta_i,\mathrm{d}\omega_i<br>$$</p>
<ul>
<li>击中其他物体，则需要计算间接光照</li>
</ul>
<p>$$<br>L_o^{indir}(p,\omega_o)&#x3D;<br>\int_{\Omega^+;V&#x3D;0}L_i^{indir}(p,\omega_i)f_r(p,\omega_i,\omega_o) \cos\theta_i,\mathrm{d}\omega_i<br>$$</p>
<h3 id="判断一个点是否可见"><a href="#判断一个点是否可见" class="headerlink" title="判断一个点是否可见"></a>判断一个点是否可见</h3><img src="08/image-20210505103954288.png" style="zoom:50%;" />

<ul>
<li>和 HBAO 一样</li>
<li>判断某个点是否可见，和 HBAO 同样的判断<ul>
<li>深度与深度图中的记录相比较</li>
<li>限制半径 R</li>
</ul>
</li>
<li>上图中<ul>
<li>C 点没有被挡住，因此可以计算环境光照（我们不太关心这一点）</li>
<li>A、B、D 点被挡住了，因此我们需要计算这 3 个点对 shading point 的贡献 <ul>
<li>深度图中的点都是记录了 flux 等信息的（defered shading 的思想）</li>
</ul>
</li>
</ul>
</li>
<li>我们判断一个点是否对 P 点可见，使用其深度和深度图中记录值相比较，这是有问题的，例如下图中<ul>
<li>A 点对 P 点可见，但是我们判断为不可见</li>
<li>B 点对视点可见，但是 PB 这个方向会被其他物体挡住</li>
</ul>
</li>
</ul>
<img src="08/image-20210505103954299.png" style="zoom:50%;" />



<h3 id="SSDO-评价"><a href="#SSDO-评价" class="headerlink" title="SSDO 评价"></a>SSDO 评价</h3><h4 id="Pros"><a href="#Pros" class="headerlink" title="Pros"></a>Pros</h4><ul>
<li>质量不错</li>
<li>轻量级计算</li>
</ul>
<h4 id="Cons"><a href="#Cons" class="headerlink" title="Cons"></a>Cons</h4><ul>
<li>可见性（考虑得比较少）</li>
<li>Screen space 丢失了信息<ul>
<li>例如下图，我们将物体旋转之后，由于视点看不到背面，结果导致地上的反光没了</li>
</ul>
</li>
</ul>
<p><img src="/08/image-20210505105216389.png"></p>
<ul>
<li>SSDO 只能做到近处的贡献（只考虑了小范围内的贡献）</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/04/29/CG/YLQ-GAMES202/08/" data-id="cl9lj749u008n64tz4r8qgj3m" data-title="GAMES202.闫令琪.08.实时全局光照(屏幕空间)(SSAO/SSDO)" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/CG/" rel="tag">CG</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/YLQ/" rel="tag">YLQ</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-DB/CLJ/04-5" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/04/27/DB/CLJ/04-5/" class="article-date">
  <time class="dt-published" datetime="2021-04-27T09:13:12.000Z" itemprop="datePublished">2021-04-27</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/DB-CLJ/">DB.CLJ</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2021/04/27/DB/CLJ/04-5/">数据库概论.陈立军.04. 数据更新</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="数据更新"><a href="#数据更新" class="headerlink" title="数据更新"></a>数据更新</h1><ul>
<li>Insert</li>
<li>Delete</li>
<li>Truncate</li>
<li>Update</li>
<li>Output</li>
<li>Merge</li>
</ul>
<h2 id="全局变量"><a href="#全局变量" class="headerlink" title="全局变量"></a>全局变量</h2><h3 id="row-count"><a href="#row-count" class="headerlink" title="row_count()"></a>row_count()</h3><ul>
<li>返回<strong>受上一语句影响的行数</strong></li>
<li>任何不返回行的语句将这一变量设置为 0</li>
<li>例子：删除了多少行</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">delete</span> <span class="keyword">from</span> S</span><br><span class="line"><span class="keyword">select</span> row_count()</span><br></pre></td></tr></table></figure>





<h2 id="Insert"><a href="#Insert" class="headerlink" title="Insert"></a>Insert</h2><ul>
<li>形式</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* 插入一条指定好值的行 */</span></span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> 表名[(列名[, 列名]...)] <span class="keyword">values</span> (值[,值],...,)</span><br><span class="line"><span class="comment">/* 插入子查询结果中的若干行 */</span></span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> 表名[(列名[, 列名]...](子查询)</span><br></pre></td></tr></table></figure>



<h3 id="插入显式行"><a href="#插入显式行" class="headerlink" title="插入显式行"></a>插入显式行</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> PROF <span class="keyword">values</span></span><br><span class="line">    (P123,<span class="string">&#x27;王明&#x27;</span>,<span class="number">35</span>,D08,<span class="number">498</span>),</span><br><span class="line">    (P124,<span class="string">&#x27;李明&#x27;</span>,<span class="number">38</span>,D01,<span class="number">698</span>)</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> PROF(pno, pname, dno) <span class="keyword">values</span></span><br><span class="line">    <span class="type">row</span>(P123, <span class="string">&#x27;王明&#x27;</span>, D08),</span><br><span class="line">    <span class="type">row</span>(P125, <span class="string">&#x27;李明&#x27;</span>, D08)</span><br></pre></td></tr></table></figure>



<h3 id="插入子查询"><a href="#插入子查询" class="headerlink" title="插入子查询"></a>插入子查询</h3><ul>
<li>将平均成绩大于 90 的学生加入到 EXCELLENT 中</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> EXCELLENT (sno, grade)</span><br><span class="line"><span class="keyword">select</span> sno,<span class="built_in">avg</span>(grade)</span><br><span class="line"><span class="keyword">from</span> SC</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span>(sno)</span><br><span class="line"><span class="keyword">having</span> <span class="built_in">avg</span>(grade) <span class="operator">&gt;</span> <span class="number">90</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> sno, <span class="built_in">avg</span>(grade)</span><br><span class="line"><span class="keyword">into</span> EXCELLENT (sno, grade)</span><br><span class="line"><span class="keyword">from</span> SC</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span>(sno)</span><br><span class="line"><span class="keyword">having</span> <span class="built_in">avg</span>(grade) <span class="operator">&gt;</span> <span class="number">90</span></span><br></pre></td></tr></table></figure>



<h3 id="replace-into"><a href="#replace-into" class="headerlink" title="replace into"></a>replace into</h3><ul>
<li>替换原有的数据行</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> test_replace(</span><br><span class="line">    id <span class="type">int</span> auto_increment <span class="keyword">primary</span> key,</span><br><span class="line">    name <span class="type">char</span>(<span class="number">10</span>),</span><br><span class="line">    cur_time datetime</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> test_replace (name,cur_time)</span><br><span class="line"><span class="keyword">values</span>(<span class="string">&#x27;A&#x27;</span>,now()),(<span class="string">&#x27;B&#x27;</span>,now())</span><br><span class="line"></span><br><span class="line">replace test_replace <span class="keyword">values</span>(<span class="number">1</span>,<span class="string">&#x27;AA&#x27;</span>,now())</span><br></pre></td></tr></table></figure>



<h2 id="Delete"><a href="#Delete" class="headerlink" title="Delete"></a>Delete</h2><ul>
<li>从表中删除符合条件的元组</li>
<li><strong>如果没有 where 语句，则删除所有元组</strong></li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">delete</span> <span class="keyword">from</span> 表名 [<span class="keyword">where</span> 条件表达式]</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* 清除所有选课记录 */</span></span><br><span class="line"><span class="keyword">delete</span> <span class="keyword">from</span> SC</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 删除王明老师所有的任课记录 */</span></span><br><span class="line"><span class="keyword">delete</span> <span class="keyword">from</span> PC</span><br><span class="line"><span class="keyword">where</span> pno <span class="keyword">in</span> (</span><br><span class="line">    <span class="keyword">select</span> pno</span><br><span class="line">    <span class="keyword">from</span> PROF</span><br><span class="line">    <span class="keyword">where</span> pname<span class="operator">=</span><span class="string">&#x27;王明&#x27;</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<ul>
<li>删除的时候，用 in 而不是 &#x3D;<ul>
<li>可能有两个人都叫王明，使用 &#x3D; 会报错</li>
<li>运行时错误</li>
</ul>
</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> delA(a <span class="type">int</span>);</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> delB(b <span class="type">int</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> delA <span class="keyword">values</span>(<span class="number">1</span>),(<span class="number">3</span>),(<span class="number">4</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> delB <span class="keyword">values</span>(<span class="number">3</span>),(<span class="number">4</span>),(<span class="number">5</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">/* =/in */</span></span><br><span class="line"><span class="keyword">delete</span> <span class="keyword">from</span> delA <span class="keyword">where</span> a<span class="operator">=</span>(<span class="keyword">select</span> b <span class="keyword">from</span> delB <span class="keyword">where</span> b<span class="operator">&lt;</span><span class="number">4</span>);</span><br><span class="line"><span class="keyword">delete</span> <span class="keyword">from</span> delA <span class="keyword">where</span> a<span class="operator">=</span>(<span class="keyword">select</span> b <span class="keyword">from</span> delB <span class="keyword">where</span> b<span class="operator">&gt;</span><span class="number">3</span>);</span><br><span class="line"><span class="comment">/* ERROR 1242(21000):Subquery returns more than 1 row */</span></span><br></pre></td></tr></table></figure>

<ul>
<li>可以使用 <code>limit 1</code> 限制只输出一行</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">delete</span> <span class="keyword">from</span> delB</span><br><span class="line"><span class="keyword">where</span> b<span class="operator">&lt;</span><span class="number">5</span></span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> b <span class="keyword">desc</span></span><br><span class="line">limit <span class="number">1</span></span><br></pre></td></tr></table></figure>



<h3 id="多表删除操作"><a href="#多表删除操作" class="headerlink" title="多表删除操作"></a>多表删除操作</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">delete</span> t1,t2 <span class="keyword">from</span> t1 <span class="keyword">inner</span> <span class="keyword">join</span> t2 <span class="keyword">inner</span> <span class="keyword">join</span> t3</span><br><span class="line"><span class="keyword">where</span> t1.id<span class="operator">=</span>t2.id <span class="keyword">and</span> t2.id<span class="operator">=</span>t3.id</span><br><span class="line"></span><br><span class="line"><span class="keyword">delete</span> <span class="keyword">from</span> t1,t2 <span class="keyword">using</span> t1 <span class="keyword">inner</span> <span class="keyword">join</span> t2 <span class="keyword">inner</span> <span class="keyword">join</span> t3</span><br><span class="line"><span class="keyword">where</span> t1.id<span class="operator">=</span>t2.id <span class="keyword">and</span> t2.id<span class="operator">=</span>t3.id</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">delete</span> PC <span class="keyword">from</span> PROF <span class="keyword">inner</span> <span class="keyword">join</span> PC</span><br><span class="line"><span class="keyword">where</span> pname<span class="operator">=</span><span class="string">&#x27;王明&#x27;</span> <span class="keyword">and</span> PROF.pno<span class="operator">=</span>PC.pno</span><br></pre></td></tr></table></figure>



<h3 id="删除操作"><a href="#删除操作" class="headerlink" title="删除操作"></a>删除操作</h3><h3 id="例子"><a href="#例子" class="headerlink" title="例子"></a>例子</h3><ul>
<li>删除低于平均工资的老师记录</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* 这样的语句是错误的 */</span></span><br><span class="line"><span class="keyword">delete</span> <span class="keyword">from</span> PROF</span><br><span class="line"><span class="keyword">where</span> salary <span class="operator">&lt;</span> (</span><br><span class="line">    <span class="keyword">select</span> <span class="built_in">avg</span>(salary)</span><br><span class="line">    <span class="keyword">from</span> PROF</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<ul>
<li>思考：是先找到所有符合条件的行，一并删除，还是找到一个删除一个<ul>
<li>应该是先找到，然后会一并删除</li>
<li>删除的时候会加锁，一并删除可以保持对外的一致性</li>
</ul>
</li>
<li><strong>MySQL 不允许从子查询中出现的表中删除数据</strong></li>
<li>解决方法，先找出平均工资，然后再删除</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* 生成临时视图 */</span></span><br><span class="line"><span class="keyword">with</span> tmp <span class="keyword">as</span>(</span><br><span class="line">    <span class="keyword">select</span> <span class="built_in">avg</span>(val) <span class="keyword">as</span> A</span><br><span class="line">    <span class="keyword">from</span> test_del</span><br><span class="line">)</span><br><span class="line"><span class="keyword">delete</span> test_del <span class="keyword">from</span> test_del <span class="keyword">inner</span> <span class="keyword">join</span> tmp <span class="keyword">where</span> val <span class="operator">&gt;</span> A;</span><br></pre></td></tr></table></figure>



<h2 id="Truncate"><a href="#Truncate" class="headerlink" title="Truncate"></a>Truncate</h2><ul>
<li>清空表</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">truncate</span> <span class="keyword">table</span></span><br></pre></td></tr></table></figure>

<ul>
<li>删除表中的所有行，而不记录单个行删除操作<ul>
<li>相对于用 delete 语句删除整个表而言，更加高效</li>
<li>数据库一般都有<strong>日志记录</strong>，用于恢复数据库<ul>
<li>delete 删除一个表会产生行级的记录</li>
<li>truncate 删除整个表只会产生页级的记录</li>
</ul>
</li>
</ul>
</li>
<li>truncate table 在功能上与不带 where 子句的 delete 语句相同<ul>
<li>但 truncate table 比 delete 速度快，且使用的系统和事务日志资源少</li>
<li>auto_increment 计数器重置为种子值</li>
</ul>
</li>
</ul>
<h2 id="Update"><a href="#Update" class="headerlink" title="Update"></a>Update</h2><ul>
<li>更新操作的命令格式</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">update</span> 表名</span><br><span class="line"><span class="keyword">set</span> 列名 <span class="operator">=</span> 表达式<span class="operator">|</span>子查询</span><br><span class="line">    列名 <span class="operator">=</span> [,表达式<span class="operator">|</span>子查询]</span><br><span class="line">    ...</span><br><span class="line">[<span class="keyword">where</span> 条件表达式]</span><br></pre></td></tr></table></figure>

<ul>
<li>指定对哪些列进行更新，以及更新后的值是什么</li>
</ul>
<h3 id="例子-1"><a href="#例子-1" class="headerlink" title="例子 1"></a>例子 1</h3><ul>
<li>老师工资上调 5%</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">update</span> PROF</span><br><span class="line"><span class="keyword">set</span> salary <span class="operator">=</span> salary<span class="operator">*</span><span class="number">1.05</span></span><br></pre></td></tr></table></figure>

<ul>
<li>将 D01系系主任的工资改为该系的平均工资</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* SQL 语句无效 */</span></span><br><span class="line"><span class="comment">/* 和删除一样, MySQL 不允许从子查询中出现的表中更新数据 */</span></span><br><span class="line"><span class="keyword">update</span> PROF</span><br><span class="line"><span class="keyword">set</span> salary <span class="operator">=</span> (</span><br><span class="line">    <span class="keyword">select</span> <span class="built_in">avg</span>(salary)</span><br><span class="line">    <span class="keyword">from</span> PROF</span><br><span class="line">    <span class="keyword">where</span> dno<span class="operator">=</span>D01</span><br><span class="line">)</span><br><span class="line"><span class="keyword">where</span> pno<span class="operator">=</span> (</span><br><span class="line">    selectdean</span><br><span class="line">    <span class="keyword">from</span> DEPT</span><br><span class="line">    <span class="keyword">where</span> dno<span class="operator">=</span>D01</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<ul>
<li>解决方法是一致的，临时视图</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> tmp <span class="keyword">as</span>(<span class="keyword">select</span> <span class="built_in">avg</span>(salary) avgsal <span class="keyword">from</span> PROF <span class="keyword">where</span> dno<span class="operator">=</span>D01)</span><br><span class="line"><span class="keyword">update</span> PROF,tmp</span><br><span class="line"><span class="keyword">set</span> salary <span class="operator">=</span> tmp.avgsal</span><br></pre></td></tr></table></figure>



<h3 id="例子-2"><a href="#例子-2" class="headerlink" title="例子 2"></a>例子 2</h3><ul>
<li>当 C1 课程的成绩小于该课程的平均成绩时，将其提高 5%</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> tmp <span class="keyword">as</span>(<span class="keyword">select</span> <span class="built_in">avg</span>(grade) avggrade <span class="keyword">from</span> SC <span class="keyword">where</span> cno<span class="operator">=</span>C1)</span><br><span class="line"><span class="keyword">update</span> SC,tmp</span><br><span class="line"><span class="keyword">set</span> grade <span class="operator">=</span> grade<span class="operator">*</span><span class="number">1.05</span> <span class="keyword">where</span> cno<span class="operator">=</span>C1 <span class="keyword">and</span> grade<span class="operator">&lt;</span>tmp.avggrade</span><br></pre></td></tr></table></figure>

<ul>
<li>对所有的课程，满足上述条件的都进行修改</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> tmp <span class="keyword">as</span>(</span><br><span class="line">    <span class="keyword">select</span> cno, <span class="built_in">avg</span>(grade) avggrade</span><br><span class="line">    <span class="keyword">from</span> SC</span><br><span class="line">    <span class="keyword">group</span> <span class="keyword">by</span> cno</span><br><span class="line">)</span><br><span class="line"><span class="keyword">update</span> SC,tmp</span><br><span class="line"><span class="keyword">where</span> SC.cno<span class="operator">=</span>tmp.cno</span><br><span class="line"><span class="keyword">set</span> grade <span class="operator">=</span> grade<span class="operator">*</span><span class="number">1.05</span> <span class="keyword">where</span> grade<span class="operator">&lt;</span>tmp.avggrade</span><br></pre></td></tr></table></figure>



<h3 id="例子-3-case-when"><a href="#例子-3-case-when" class="headerlink" title="例子 3 (case when)"></a>例子 3 (case when)</h3><ul>
<li>工资超过 2000 的缴纳 10% 所得税，其余的缴纳 5% 所得税</li>
<li>如果写成两个 SQL，需要考虑执行顺序<ul>
<li>这里需要先写 5% 的征税（工资小于等于2000），再写 10% 的征税（工资大于2000）</li>
<li><strong>写成多个 SQL 是不好的习惯</strong></li>
</ul>
</li>
<li>最好写成一个 SQL<ul>
<li><code>case when</code></li>
</ul>
</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">update</span> PROF</span><br><span class="line"><span class="keyword">set</span> SAL <span class="operator">=</span></span><br><span class="line">    <span class="keyword">case</span> SAL</span><br><span class="line">        <span class="keyword">when</span> SAL <span class="operator">&gt;</span> <span class="number">2000</span> <span class="keyword">then</span> SAL <span class="operator">*</span> <span class="number">0.9</span></span><br><span class="line">        <span class="keyword">when</span> SAL <span class="operator">&lt;=</span> <span class="number">2000</span> <span class="keyword">then</span> SAL <span class="operator">*</span> <span class="number">0.95</span></span><br></pre></td></tr></table></figure>





<h2 id="Merge"><a href="#Merge" class="headerlink" title="Merge"></a>Merge</h2><h3 id="行拷贝"><a href="#行拷贝" class="headerlink" title="行拷贝"></a>行拷贝</h3><ul>
<li>R(ID, A, B), S(ID, A, B)</li>
<li>使用 S 相同 ID 的记录覆盖 R 中相同 ID 的记录</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* 错误的写法 */</span></span><br><span class="line"><span class="keyword">update</span> R</span><br><span class="line"><span class="keyword">set</span></span><br><span class="line">    A <span class="operator">=</span> (<span class="keyword">select</span> S.A <span class="keyword">from</span> S <span class="keyword">where</span> R.ID<span class="operator">=</span>S.ID),</span><br><span class="line">    B <span class="operator">=</span> (<span class="keyword">select</span> S.B <span class="keyword">from</span> S <span class="keyword">where</span> R.ID<span class="operator">=</span>S.ID)</span><br></pre></td></tr></table></figure>

<ul>
<li><strong>怎么处理呢？</strong><ul>
<li><strong>表同步问题</strong></li>
</ul>
</li>
</ul>
<h3 id="表同步-UPSERT"><a href="#表同步-UPSERT" class="headerlink" title="表同步: UPSERT"></a>表同步: UPSERT</h3><ul>
<li>UPSERT：表同步</li>
<li>在把一组记录加载到表中时，一个经典的挑战是如何识别和处理目标表中已有的记录</li>
<li>常用的方法如下<ul>
<li>如果某记录不存在，就将它插入</li>
<li>如果存在，就用源表中的数据更新该记录</li>
</ul>
</li>
<li>需要定义复杂的存储过程来完成一系列 INSERT 或 UPDATE 命令，这个技术通常被称为 UPSERT</li>
<li>应用场景<ul>
<li>业务表不能够一直增大，否则会拖慢系统的性能，因此需要定时保存到历史表中</li>
</ul>
</li>
</ul>
<h3 id="Merge-命令"><a href="#Merge-命令" class="headerlink" title="Merge 命令"></a>Merge 命令</h3><ul>
<li>merge 子句指定作为插入、更新或删除操作目标的表</li>
<li>using 子句指定要与目标联接的数据源</li>
<li>on 子句指定决定目标与源的匹配位置的联接条件</li>
<li>when 子句基于 on 子句的结果指定所要采取的操作<ul>
<li>when matched</li>
<li>when not matched by target</li>
<li>when not matched by source</li>
</ul>
</li>
</ul>
<h3 id="表同步一个典型的应用场景"><a href="#表同步一个典型的应用场景" class="headerlink" title="表同步一个典型的应用场景"></a>表同步一个典型的应用场景</h3><ul>
<li>数据仓库中的 FactBuyingHabits 表跟踪客户购买产品的最后日期，事务数据库每周都会生成一个包括该周采购情况的PurchaseRecords 表</li>
<li>需要定期将 PurchaseRecords 表中的信息合并到 FactBuyingHabits 表中<ul>
<li>对于不存在的产品-客户对，插入新行</li>
<li>对于已存在的产品-客户对，更新最近的购买日期</li>
</ul>
</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* 指定目标表 */</span></span><br><span class="line"><span class="keyword">merge</span> dbo.FactBuyingHabits <span class="keyword">as</span> target</span><br><span class="line"><span class="comment">/* 指定源表(可以是表或子查询) */</span></span><br><span class="line"><span class="keyword">using</span> (</span><br><span class="line">    <span class="keyword">select</span> CustomerID, ProductID, PurchaseDate</span><br><span class="line">    <span class="keyword">from</span> dbo.Purchases</span><br><span class="line">) <span class="keyword">as</span> source</span><br><span class="line"><span class="comment">/* 指定行匹配(连接条件) */</span></span><br><span class="line"><span class="keyword">on</span>(</span><br><span class="line">    Target.ProductID <span class="operator">=</span> Source.ProductID</span><br><span class="line">    <span class="keyword">and</span> Target.CustomerID <span class="operator">=</span> Source.CustomerID</span><br><span class="line">)</span><br><span class="line"><span class="comment">/* 不同情况的操作 */</span></span><br><span class="line"><span class="comment">/* 匹配上 */</span></span><br><span class="line"><span class="keyword">when</span> matched <span class="keyword">then</span></span><br><span class="line">    <span class="keyword">update</span> setTarget.LastPurchaseDate <span class="operator">=</span> Source.PurchaseDate</span><br><span class="line"><span class="comment">/* 目标表中没有 */</span></span><br><span class="line"><span class="keyword">when</span> <span class="keyword">not</span> matched <span class="keyword">by</span> target <span class="keyword">then</span></span><br><span class="line">    <span class="keyword">insert</span>(CustomerID, ProductID, LastPurchaseDate)</span><br><span class="line">    <span class="keyword">values</span>(Source.CustomerID, Source.ProductID, Source.PurchaseDate)</span><br></pre></td></tr></table></figure>

<ul>
<li>Merge 命令的产生是源于本是据数据仓库的发展</li>
<li>更新操作对于数据库而言是很关键的，一般会有记录（谁更新了什么）<ul>
<li>审计</li>
</ul>
</li>
</ul>
<h2 id="Output"><a href="#Output" class="headerlink" title="Output"></a>Output</h2><ul>
<li>Output：记录更新历史</li>
<li>执行修改操作只返回影响了多少行的信息，无从获知到底影响到了哪些行</li>
<li>如果在修改操作语句中带上output，就可以输出具体的影响信息</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">output&#123; deleted<span class="operator">|</span>inserted&#125;.&#123; <span class="operator">*</span> <span class="operator">|</span> column_name&#125;</span><br><span class="line">[<span class="keyword">into</span> table_name]</span><br></pre></td></tr></table></figure>

<ul>
<li>deleted 和 inserted 是两个虚表，deleted 里面存放修改之前的值，inserted 里面存放的是修改之后的值</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">declare</span> <span class="variable">@recordChange</span> <span class="keyword">table</span>(</span><br><span class="line">    beforeGrade <span class="type">int</span>,</span><br><span class="line">    afterGrade  <span class="type">int</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">update</span> sc</span><br><span class="line"><span class="keyword">set</span> grade<span class="operator">=</span>grade<span class="operator">*</span><span class="number">1.05</span></span><br><span class="line">output deleted.grade,inserted.gradeinto <span class="variable">@recordChange</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">delete</span> <span class="keyword">from</span> sc</span><br><span class="line">output deleted.<span class="operator">*</span> <span class="keyword">into</span> delHistory</span><br></pre></td></tr></table></figure>


      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/04/27/DB/CLJ/04-5/" data-id="cl9lj74at00f064tz2rx51g46" data-title="数据库概论.陈立军.04. 数据更新" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/DB/" rel="tag">DB</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-DB/CLJ/04-4" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/04/27/DB/CLJ/04-4/" class="article-date">
  <time class="dt-published" datetime="2021-04-27T08:12:24.000Z" itemprop="datePublished">2021-04-27</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/DB-CLJ/">DB.CLJ</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2021/04/27/DB/CLJ/04-4/">数据库概论.陈立军.04.SQL 数据查询(3)</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="SQL-数据查询"><a href="#SQL-数据查询" class="headerlink" title="SQL 数据查询"></a>SQL 数据查询</h1><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Select</span> ...</span><br><span class="line"><span class="keyword">From</span> ...</span><br><span class="line"><span class="keyword">Where</span> ...</span><br><span class="line"><span class="keyword">Group</span> <span class="keyword">by</span> ...</span><br><span class="line"><span class="keyword">Having</span> ...</span><br><span class="line"><span class="keyword">Union</span> ...</span><br><span class="line"><span class="keyword">Order</span> <span class="keyword">by</span> ...</span><br><span class="line">Limit ...</span><br></pre></td></tr></table></figure>



<h2 id="在线资源"><a href="#在线资源" class="headerlink" title="在线资源"></a>在线资源</h2><ul>
<li><a target="_blank" rel="noopener" href="http://sqlfiddle.com/">http://sqlfiddle.com</a></li>
</ul>
<h2 id="字符串操作"><a href="#字符串操作" class="headerlink" title="字符串操作"></a>字符串操作</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">列名 [<span class="keyword">not</span>] <span class="keyword">like</span> <span class="string">&#x27;字符串&#x27;</span></span><br></pre></td></tr></table></figure>

<h3 id="匹配规则"><a href="#匹配规则" class="headerlink" title="匹配规则"></a>匹配规则</h3><figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">%       匹配零个或多个字符</span><br><span class="line">_       匹配任意单个字符</span><br><span class="line">[]      任何在指定范围内的字符, [a-f], [abcdef]</span><br><span class="line">[^]     任何不在指定范围内的字符, [^a-f], [^abcdef]</span><br></pre></td></tr></table></figure>



<h3 id="转义字符"><a href="#转义字符" class="headerlink" title="转义字符"></a>转义字符</h3><ul>
<li><strong>用 escape 定义转义字符</strong>，以去掉特殊字符的特定含义，使其被作为普通字符看待<ul>
<li>如 escape <code>\</code>，定义 <code>\</code> 作为转义字符</li>
<li>则可用 <code>\%</code> 去匹配 <code>%</code>，用 <code>\_</code>去匹配 <code>_</code></li>
<li>用什么去匹配 <code>\</code>：<code>\\</code></li>
</ul>
</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> my_tb</span><br><span class="line"><span class="keyword">where</span> col1 <span class="keyword">like</span> <span class="string">&#x27;x%%x__xx&#x27;</span> <span class="keyword">escape</span> <span class="string">&#x27;x&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">x%x_x    (x)</span></span><br><span class="line"><span class="comment">%xx_x    (x)</span></span><br><span class="line"><span class="comment">%xx_xx   (v)</span></span><br><span class="line"><span class="comment">%__x     (v)</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>



<h3 id="例子"><a href="#例子" class="headerlink" title="例子"></a>例子</h3><ul>
<li>列出姓名以“张”打头的教师的所有信息</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span></span><br><span class="line"><span class="keyword">from</span> PROF</span><br><span class="line"><span class="keyword">where</span> pname <span class="keyword">like</span> <span class="string">&#x27;张%&#x27;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>列出名称中含有3个以上字符，且倒数第三个是d，倒数第二个是 <code>_</code> 的课程</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span></span><br><span class="line"><span class="keyword">from</span> C</span><br><span class="line"><span class="keyword">where</span> cname <span class="keyword">like</span> <span class="string">&#x27;%_d\__&#x27;</span> <span class="keyword">escape</span> <span class="string">&#x27;\&#x27;</span></span><br></pre></td></tr></table></figure>



<h3 id="索引"><a href="#索引" class="headerlink" title="索引"></a>索引</h3><ul>
<li>在 cname 上建有索引 cname_idx，观察下面查询的执行计划，看谁用到了该索引</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* 放弃使用索引 */</span></span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> C <span class="keyword">where</span> cname <span class="keyword">like</span> <span class="string">&#x27;%d&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* 使用索引 */</span></span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> C <span class="keyword">where</span> cname <span class="keyword">like</span> <span class="string">&#x27;d%&#x27;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>like 作用有限，如何增强数据库的文本处理能力<ul>
<li><strong>全文检索</strong> + <strong>正则表达式</strong></li>
</ul>
</li>
</ul>
<h2 id="正则表达式"><a href="#正则表达式" class="headerlink" title="正则表达式"></a>正则表达式</h2><ul>
<li>Regular Expression</li>
<li>一些例子</li>
</ul>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">用户名</span><br><span class="line">/^[a-z0-9_-]&#123;3,16&#125;$/</span><br><span class="line"></span><br><span class="line">密码</span><br><span class="line">/^[a-z0-9_-]&#123;6,18&#125;$/</span><br><span class="line"></span><br><span class="line">电子邮箱</span><br><span class="line">/^([a-z0-9_\.-]+)@([\da-z\.-]+)\.([a-z\.]&#123;2,6&#125;)$/</span><br><span class="line"></span><br><span class="line">IP地址</span><br><span class="line">/^(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.)&#123;3&#125;(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$/</span><br><span class="line"></span><br><span class="line">HTML标签</span><br><span class="line">/^&lt;([a-z]+)([^&lt;]+)*(?:&gt;(.*)&lt;\/\1&gt;|\s+\/&gt;)$/</span><br></pre></td></tr></table></figure>

<ul>
<li>如果数据库本身不支持正则表达式，那么一切都会变得很麻烦<ul>
<li><strong>现在的数据库都是直接支持的</strong></li>
</ul>
</li>
<li>用 check 约束表达正则表达式</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> IP_Address(ip <span class="type">char</span>(<span class="number">15</span>) <span class="keyword">primary</span> key)</span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> IP_Address <span class="keyword">add</span> <span class="keyword">constraint</span> CHK_IP_Valid <span class="keyword">check</span>(</span><br><span class="line">    ip <span class="keyword">like</span> <span class="string">&#x27;_%._%._%._%&#x27;</span></span><br><span class="line">    <span class="keyword">and</span> ip <span class="keyword">not</span> <span class="keyword">like</span> <span class="string">&#x27;%.%.%.%.%&#x27;</span></span><br><span class="line">    <span class="keyword">and</span> ip <span class="keyword">not</span> <span class="keyword">like</span> <span class="string">&#x27;%[^0-9.]%&#x27;</span></span><br><span class="line">    <span class="keyword">and</span> ip <span class="keyword">not</span> <span class="keyword">like</span> <span class="string">&#x27;%[0-9][0-9][0-9][0-9]%&#x27;</span></span><br><span class="line">    <span class="keyword">and</span> ip <span class="keyword">not</span> <span class="keyword">like</span> <span class="string">&#x27;%[3-9][0-9][0-9]%&#x27;</span></span><br><span class="line">    <span class="keyword">and</span> ip <span class="keyword">not</span> <span class="keyword">like</span> <span class="string">&#x27;%2[6-9][0-9]%&#x27;</span></span><br><span class="line">    <span class="keyword">and</span> ip <span class="keyword">not</span> <span class="keyword">like</span> <span class="string">&#x27;%25[6-9]%&#x27;</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<ul>
<li>数据库中的正则表达式<ul>
<li>按照 PPT 中，好像是含有正则表示式项即可</li>
</ul>
</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> name <span class="keyword">from</span> my_name</span><br><span class="line"><span class="keyword">where</span> name regexp <span class="string">&#x27;^吴&#x27;</span> <span class="comment">/* 名字以 &#x27;吴&#x27; 开头 */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> name <span class="keyword">from</span> my_name</span><br><span class="line"><span class="keyword">where</span> name regexp <span class="string">&#x27;吴&#x27;</span> <span class="comment">/* 名字中含有 &#x27;吴&#x27; */</span></span><br></pre></td></tr></table></figure>



<h3 id="Oracle"><a href="#Oracle" class="headerlink" title="Oracle"></a>Oracle</h3><ul>
<li>在表定义的时候，可以在添加 constraint 的时候使用正则表达式<ul>
<li>MySQL 和 SQL Server 好像都没有</li>
</ul>
</li>
</ul>
<table>
<thead>
<tr>
<th align="center">函数名</th>
<th align="center">说明</th>
</tr>
</thead>
<tbody><tr>
<td align="center">REGEXP_LIKE</td>
<td align="center">类似于LIKE 运算符，但执行正则表达式匹配而不是简单的模式匹配</td>
</tr>
<tr>
<td align="center">REGEXP_INSTR</td>
<td align="center">在给定字符串中搜索某个正则表达式模式，并返回匹配项的位置</td>
</tr>
<tr>
<td align="center">REGEXP_REPLACE</td>
<td align="center">搜索某个正则表达式模式并使用替换字符串替换它</td>
</tr>
<tr>
<td align="center">REGEXP_SUBSTR</td>
<td align="center">在给定字符串中搜索某个正则表达式模式并返回匹配的子字符串</td>
</tr>
</tbody></table>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Alter</span> <span class="keyword">table</span> students</span><br><span class="line"><span class="keyword">add</span> <span class="keyword">constraint</span> stud_ssn_ck</span><br><span class="line"><span class="keyword">check</span> (</span><br><span class="line">    REGEXP_LIKE(</span><br><span class="line">        ssn,</span><br><span class="line">        <span class="string">&#x27;^([[:digit:]]&#123;3&#125;-[[:digit:]]&#123;2&#125;-[[:digit:]]&#123;4&#125;|[[:digit:]]&#123;9&#125;)$&#x27;</span></span><br><span class="line">    )</span><br><span class="line">)</span><br></pre></td></tr></table></figure>



<h3 id="标准-SQL"><a href="#标准-SQL" class="headerlink" title="标准 SQL"></a>标准 SQL</h3><ul>
<li>similar to</li>
</ul>
<h2 id="全文检索"><a href="#全文检索" class="headerlink" title="全文检索"></a>全文检索</h2><ul>
<li>大量文档不适用于用 like 查询</li>
</ul>
<h3 id="倒排索引"><a href="#倒排索引" class="headerlink" title="倒排索引"></a>倒排索引</h3><img src="04-4/image-20210427164844348.png" style="zoom:60%;" />



<h3 id="SQL-Server-中的全文索引"><a href="#SQL-Server-中的全文索引" class="headerlink" title="SQL Server 中的全文索引"></a>SQL Server 中的全文索引</h3><h4 id="创建全文索引"><a href="#创建全文索引" class="headerlink" title="创建全文索引"></a>创建全文索引</h4><ul>
<li>key index 指定 table_name 上唯一码索引的名称, 最好是聚簇索引</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> fulltext catalog catalog_name</span><br><span class="line"><span class="keyword">create</span> fulltext index <span class="keyword">on</span></span><br><span class="line">    table_name[(column_name]</span><br><span class="line">key index index_name</span><br><span class="line"><span class="keyword">on</span> catalog_name</span><br></pre></td></tr></table></figure>



<h4 id="全文索引的使用"><a href="#全文索引的使用" class="headerlink" title="全文索引的使用"></a>全文索引的使用</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Contains</span>(属性列<span class="operator">|</span><span class="operator">*</span>, 查找条件)</span><br><span class="line">freetext(属性列<span class="operator">|</span><span class="operator">*</span>, 查找文本)</span><br></pre></td></tr></table></figure>

<ul>
<li>使用 freetext 时，全文查询引擎内部将查找文本拆分为若干个搜索词，并赋予每个词以不同的加权，然后查找匹配</li>
</ul>
<h4 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">doc(doc_id,title,author,abstract,content)</span><br><span class="line"><span class="comment">/* 聚簇索引 */</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">unique</span> clustered index doc_idxondoc(doc_id)</span><br><span class="line"><span class="comment">/* 建立全文索引 */</span></span><br><span class="line"><span class="keyword">create</span> fulltext catalog doc_fulltext_catalog</span><br><span class="line"><span class="keyword">create</span> fulltext index <span class="keyword">on</span> doc(title,author,abstract,content)</span><br><span class="line">key index doc_idx</span><br><span class="line"><span class="keyword">on</span> doc_fulltext_catalog</span><br><span class="line"><span class="comment">/* 使用 */</span></span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span></span><br><span class="line"><span class="keyword">from</span> doc</span><br><span class="line"><span class="keyword">where</span> <span class="keyword">contains</span>(author,<span class="string">&#x27;Tom and Jerry&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span></span><br><span class="line"><span class="keyword">from</span> doc</span><br><span class="line"><span class="keyword">where</span> <span class="keyword">contains</span>(<span class="operator">*</span>, <span class="string">&#x27;database and not dataspace&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span></span><br><span class="line"><span class="keyword">from</span> doc</span><br><span class="line"><span class="keyword">where</span> freetext(content, <span class="string">&#x27;DeepLearning&#x27;</span>)</span><br></pre></td></tr></table></figure>



<h3 id="MySQL全文索引"><a href="#MySQL全文索引" class="headerlink" title="MySQL全文索引"></a>MySQL全文索引</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> fulltextindex ft_indx_nameontb_name(col_name,...)</span><br><span class="line"><span class="keyword">match</span> (col_name,...) against(search_expr[search_modifier])</span><br></pre></td></tr></table></figure>

<ul>
<li>search_modifier:<ul>
<li>in natural language mode</li>
<li>in natural language mode with query expansion</li>
<li>in booleanmode</li>
<li>with query expansion</li>
</ul>
</li>
<li>例子</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> myDoc(</span><br><span class="line">    id <span class="type">int</span> auto_increment <span class="keyword">primary</span> key,</span><br><span class="line">    title <span class="type">varchar</span>(<span class="number">100</span>),</span><br><span class="line">    content text,</span><br><span class="line">    fulltext(title,content)</span><br><span class="line">)</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> myDoc(title,content) <span class="keyword">values</span></span><br><span class="line">    (<span class="string">&#x27;MySQL Tutorial&#x27;</span>,<span class="string">&#x27;DBMSstands for DataBase...&#x27;</span>),</span><br><span class="line">    (<span class="string">&#x27;How To Use MySQL Well&#x27;</span>,<span class="string">&#x27;Afteryou went through a ...&#x27;</span>),</span><br><span class="line">    (<span class="string">&#x27;Optimizing MySQL&#x27;</span>,<span class="string">&#x27;Inthis tutorial we will show ...&#x27;</span>),</span><br><span class="line">    (<span class="string">&#x27;1001 MySQL Tricks&#x27;</span>,<span class="string">&#x27;1. Never run mysqldas root. 2. ...&#x27;</span>),</span><br><span class="line">    (<span class="string">&#x27;MySQL vs. YourSQL&#x27;</span>,<span class="string">&#x27;In the following database comparison ...&#x27;</span>),</span><br><span class="line">    (<span class="string">&#x27;MySQL Security&#x27;</span>,<span class="string">&#x27;Whenconfigured properly, MySQL ...&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span></span><br><span class="line"><span class="keyword">from</span> myDoc</span><br><span class="line"><span class="keyword">where</span> <span class="keyword">match</span>(title,content)</span><br><span class="line">against(<span class="string">&#x27;database&#x27;</span> <span class="keyword">in</span> <span class="keyword">natural</span> <span class="keyword">language</span> mode)</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> id,<span class="keyword">match</span>(title,content)</span><br><span class="line">against(<span class="string">&#x27;database&#x27;</span>) <span class="keyword">as</span> score <span class="comment">/* 匹配分 */</span></span><br><span class="line"><span class="keyword">from</span> myDoc</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">match</span>(title,content) against(<span class="string">&#x27;+MySQL -YourSQL&#x27;</span><span class="keyword">in</span> <span class="type">boolean</span> mode)</span><br><span class="line"><span class="keyword">match</span>(title,content) against(<span class="string">&#x27;+MySQL +YourSQL&#x27;</span><span class="keyword">in</span> <span class="type">boolean</span> mode) <span class="comment">/* 且 */</span></span><br><span class="line"><span class="keyword">match</span>(title,content) against(<span class="string">&#x27;+MySQL YourSQL&#x27;</span><span class="keyword">in</span> <span class="type">boolean</span> mode)  <span class="comment">/* 或 */</span></span><br></pre></td></tr></table></figure>



<h2 id="字符串函数"><a href="#字符串函数" class="headerlink" title="字符串函数"></a>字符串函数</h2><img src="04-4/image-20210427170647485.png"  />

<p><img src="/04-4/image-20210427170713249.png"></p>
<p><img src="/04-4/image-20210427170725681.png"></p>
<p><img src="/04-4/image-20210427170740562.png"></p>
<h3 id="例子-1"><a href="#例子-1" class="headerlink" title="例子"></a>例子</h3><ul>
<li>计算字符 a 出现次数</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> len(<span class="string">&#x27;databases&#x27;</span>) − len(replace(<span class="string">&#x27;databases&#x27;</span>,<span class="string">&#x27;a&#x27;</span>,<span class="string">&#x27;&#x27;</span>))</span><br></pre></td></tr></table></figure>

<ul>
<li>如果是检索多个字符出现次数的话，还要除以相应的字符个数</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> len(<span class="string">&#x27;databases&#x27;</span>) − len(replace(<span class="string">&#x27;databases&#x27;</span>,<span class="string">&#x27;ta&#x27;</span>,<span class="string">&#x27;&#x27;</span>))<span class="operator">/</span>len(<span class="string">&#x27;ta&#x27;</span>)</span><br></pre></td></tr></table></figure>


      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/04/27/DB/CLJ/04-4/" data-id="cl9lj74at00ex64tzfv599sbl" data-title="数据库概论.陈立军.04.SQL 数据查询(3)" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/DB/" rel="tag">DB</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-CG/mitsuba/methodsCompare" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/04/26/CG/mitsuba/methodsCompare/" class="article-date">
  <time class="dt-published" datetime="2021-04-26T06:37:20.000Z" itemprop="datePublished">2021-04-26</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/mitsuba/">mitsuba</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2021/04/26/CG/mitsuba/methodsCompare/">mitsuba.不同渲染方法在不同场景上的对比</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="不同渲染方法在不同场景上的对比"><a href="#不同渲染方法在不同场景上的对比" class="headerlink" title="不同渲染方法在不同场景上的对比"></a>不同渲染方法在不同场景上的对比</h1><h1 id="mitsuba-0-6"><a href="#mitsuba-0-6" class="headerlink" title="mitsuba 0.6"></a>mitsuba 0.6</h1><h2 id="说明"><a href="#说明" class="headerlink" title="说明"></a>说明</h2><h3 id="使用环境"><a href="#使用环境" class="headerlink" title="使用环境"></a>使用环境</h3><ul>
<li>Ubuntu</li>
<li>mitsuba 0.6</li>
</ul>
<h3 id="场景文件"><a href="#场景文件" class="headerlink" title="场景文件"></a>场景文件</h3><ul>
<li><a target="_blank" rel="noopener" href="https://github.com/bacTlink/mitsuba-CPPM-scenes">https://github.com/bacTlink/mitsuba-CPPM-scenes</a></li>
</ul>
<h3 id="一些问题"><a href="#一些问题" class="headerlink" title="一些问题"></a>一些问题</h3><ul>
<li>没有 sudo 权限运行时指定动态库加载位置</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> LD_LIBRARY_PATH=~/mitsuba-VCM/dist/</span><br></pre></td></tr></table></figure>

<ul>
<li>上传文件</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">scp -i rsa -P portNum -r localDir xx@xx.xx.xx.xx:serverDir</span><br></pre></td></tr></table></figure>



<h2 id="结果对比"><a href="#结果对比" class="headerlink" title="结果对比"></a>结果对比</h2><ul>
<li>mitsuba 是通过修改 integrator 来修改具体的配置的</li>
</ul>
<h3 id="artware-场景"><a href="#artware-场景" class="headerlink" title="artware 场景"></a>artware 场景</h3><h4 id="path"><a href="#path" class="headerlink" title="path"></a>path</h4><ul>
<li>路径追踪</li>
<li>Path tracer</li>
<li>mitsuba 的参数</li>
</ul>
<table>
<thead>
<tr>
<th align="center">参数</th>
<th align="center">类型</th>
<th align="center">作用</th>
</tr>
</thead>
<tbody><tr>
<td align="center">maxDepth</td>
<td align="center">integer</td>
<td align="center">最大路径长度</td>
</tr>
<tr>
<td align="center">rrDepth</td>
<td align="center">integer</td>
<td align="center">大于设定值之后，采用俄罗斯轮盘赌的方式以一定概率停止（5）</td>
</tr>
<tr>
<td align="center">strictNormals</td>
<td align="center">boolean</td>
<td align="center">严格法线（false）</td>
</tr>
<tr>
<td align="center">hideEmitters</td>
<td align="center">boolean</td>
<td align="center">隐藏直接光源（false）</td>
</tr>
</tbody></table>
<ul>
<li>严格法线：法线插值带来的问题，可能出现这样子的情况<ul>
<li>根据插值法线，光线是从物体外面击中物体，但是根据实际的几何法线，光线是从物体里面击中的<ul>
<li>漏光效果</li>
</ul>
</li>
<li>设置为 true 会将这些光线去除</li>
<li>They can lead to paradoxical situations where a light ray impinges on an object from a direction that is classified as “outside” according to the shading normal, and “inside” according to the true geometric normal.</li>
</ul>
</li>
<li>配置文件</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">integrator</span> <span class="attr">type</span>=<span class="string">&quot;path&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">integer</span> <span class="attr">name</span>=<span class="string">&quot;maxDepth&quot;</span> <span class="attr">value</span>=<span class="string">&quot;5&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">integrator</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>运行渲染器</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~/mitsuba-VCM/dist/mitsuba -o artware_PATH_maxdepth=5 artware_SPPM.xml</span><br></pre></td></tr></table></figure>

<ul>
<li>将导出的 exr 格式的图片转化为 png 格式</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~/mitsuba-VCM/dist/mtsutil tonemap -f png -t artware_PATH_maxdepth=5.exr</span><br></pre></td></tr></table></figure>

<ul>
<li>运行时间很短，效果如下，整个场景很暗，直接找到的有效路径很少</li>
</ul>
<img src="methodsCompare/artware_PATH_maxdepth=5.png" alt="artware_BDPT_maxdepth=5" style="zoom: 50%;" />

<ul>
<li>将最大深度修改为 <code>33</code>（和 SPPM 一致），效果如下<ul>
<li>虽然场景亮了一些，效果还是不太好，还是找不到有效的路径</li>
</ul>
</li>
</ul>
<img src="methodsCompare/artware_PATH_maxdepth=33.png" alt="artware_BDPT_maxdepth=5" style="zoom: 50%;" />



<h4 id="bdpt"><a href="#bdpt" class="headerlink" title="bdpt"></a>bdpt</h4><ul>
<li>双向路径追踪</li>
<li>Bidirectional path tracer</li>
<li>mitsuba 的参数</li>
</ul>
<table>
<thead>
<tr>
<th align="center">参数</th>
<th align="center">类型</th>
<th align="center">作用</th>
</tr>
</thead>
<tbody><tr>
<td align="center">maxDepth</td>
<td align="center">integer</td>
<td align="center">最大路径长度</td>
</tr>
<tr>
<td align="center">rrDepth</td>
<td align="center">integer</td>
<td align="center">大于设定值之后，采用俄罗斯轮盘赌的方式以一定概率停止（5）</td>
</tr>
<tr>
<td align="center">lightImage</td>
<td align="center">boolean</td>
<td align="center">每条从 camera 除法的 subpath 是否直接对光源采样（true）</td>
</tr>
<tr>
<td align="center">sampleDirect</td>
<td align="center">boolean</td>
<td align="center">是否采用直接采样策略（true）</td>
</tr>
</tbody></table>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">integrator</span> <span class="attr">type</span>=<span class="string">&quot;bdpt&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">integer</span> <span class="attr">name</span>=<span class="string">&quot;maxDepth&quot;</span> <span class="attr">value</span>=<span class="string">&quot;33&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">integrator</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">~/mitsuba-VCM/dist/mitsuba -o artware_BDPT_maxdepth=33 artware_use.xml</span><br><span class="line">~/mitsuba-VCM/dist/mtsutil tonemap -f png -t artware_BDPT_maxdepth=33.exr</span><br></pre></td></tr></table></figure>

<ul>
<li>效果如下，和 path tracing 相比而言，能够获得更好的效果，简单体现在整体亮度更亮</li>
<li>而且能够较好的模拟焦散的现象，对于手电筒的发光也能较好的模拟</li>
</ul>
<img src="methodsCompare/artware_BDPT_maxdepth=33.png" style="zoom: 50%;" />

<ul>
<li>修改一些参数我们看看结果</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">integrator</span> <span class="attr">type</span>=<span class="string">&quot;bdpt&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">integer</span> <span class="attr">name</span>=<span class="string">&quot;maxDepth&quot;</span> <span class="attr">value</span>=<span class="string">&quot;33&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">boolean</span> <span class="attr">name</span>=<span class="string">&quot;lightImage&quot;</span> <span class="attr">value</span>=<span class="string">&quot;false&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">integrator</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">~/mitsuba-VCM/dist/mitsuba -o artware_BDPT_maxdepth=33_lightImage_false artware_use.xml</span><br><span class="line">~/mitsuba-VCM/dist/mtsutil tonemap -f png -t artware_BDPT_maxdepth=33_lightImage_false.exr</span><br></pre></td></tr></table></figure>

<ul>
<li>结果如下，我们去除了路径对光源的直接采样，最终的结果没有这么亮，相当于能够采样到光源的路径变少了<ul>
<li>但是为什么焦散现象也变少了，这个应该是 SDS 路径</li>
</ul>
</li>
</ul>
<img src="methodsCompare/artware_BDPT_maxdepth=33_lightImage_false.png" style="zoom: 50%;" />

<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">integrator</span> <span class="attr">type</span>=<span class="string">&quot;bdpt&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">integer</span> <span class="attr">name</span>=<span class="string">&quot;maxDepth&quot;</span> <span class="attr">value</span>=<span class="string">&quot;33&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">boolean</span> <span class="attr">name</span>=<span class="string">&quot;sampleDirect&quot;</span> <span class="attr">value</span>=<span class="string">&quot;false&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">integrator</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">~/mitsuba-VCM/dist/mitsuba -o artware_BDPT_maxdepth=33_sampleDirect_false artware_use.xml</span><br><span class="line">~/mitsuba-VCM/dist/mtsutil tonemap -f png -t artware_BDPT_maxdepth=33_sampleDirect_false.exr</span><br></pre></td></tr></table></figure>

<ul>
<li>感觉没多大区别</li>
</ul>
<img src="methodsCompare/artware_BDPT_maxdepth=33_sampleDirect_false.png" style="zoom:50%;" />



<h4 id="photonmapper"><a href="#photonmapper" class="headerlink" title="photonmapper"></a>photonmapper</h4><ul>
<li>photon mapping</li>
<li>简单使用默认参数设置</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">integrator</span> <span class="attr">type</span>=<span class="string">&quot;photonmapper&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">integer</span> <span class="attr">name</span>=<span class="string">&quot;maxDepth&quot;</span> <span class="attr">value</span>=<span class="string">&quot;33&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">integrator</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">~/mitsuba-VCM/dist/mitsuba -o artware_pm_maxdepth=33 artware_use.xml</span><br><span class="line">~/mitsuba-VCM/dist/mtsutil tonemap -f png -t artware_pm_maxdepth=33.exr</span><br></pre></td></tr></table></figure>

<ul>
<li>结果如下，PM 算法<ul>
<li>PM 作为一种无偏的算法，最大的问题就是会产生一种糊的感觉</li>
<li>但是由于加入了对于焦散的优化查找，最终也能模拟焦散的结果</li>
</ul>
</li>
</ul>
<img src="methodsCompare/artware_pm_maxdepth=33.png" style="zoom:50%;" />

<ul>
<li>传统的 PM 算法是模拟不了 焦散的现象的，参数如下</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">integrator</span> <span class="attr">type</span>=<span class="string">&quot;photonmapper&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">integer</span> <span class="attr">name</span>=<span class="string">&quot;maxDepth&quot;</span> <span class="attr">value</span>=<span class="string">&quot;33&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">float</span> <span class="attr">name</span>=<span class="string">&quot;causticLookupRadius&quot;</span> <span class="attr">value</span>=<span class="string">&quot;0.0&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">integrator</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">~/mitsuba-VCM/dist/mitsuba -o artware_pm_maxdepth=33_no_caustic artware_use.xml</span><br><span class="line">~/mitsuba-VCM/dist/mtsutil tonemap -f png -t artware_pm_maxdepth=33_no_caustic.exr</span><br></pre></td></tr></table></figure>

<img src="methodsCompare/artware_pm_maxdepth=33_no_caustic.png" style="zoom:50%;" />



<h4 id="ppm"><a href="#ppm" class="headerlink" title="ppm"></a>ppm</h4><ul>
<li>Progressive photon mapping integrator</li>
<li>渐进式光子映射</li>
<li>多次累计，一起估计</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">integrator</span> <span class="attr">type</span>=<span class="string">&quot;ppm&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">integer</span> <span class="attr">name</span>=<span class="string">&quot;maxDepth&quot;</span> <span class="attr">value</span>=<span class="string">&quot;33&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">integer</span> <span class="attr">name</span>=<span class="string">&quot;maxPasses&quot;</span> <span class="attr">value</span>=<span class="string">&quot;100&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">integrator</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">~/mitsuba-VCM/dist/mitsuba -o artware_PMM_maxPasses=100 artware_use.xml</span><br><span class="line">~/mitsuba-VCM/dist/mtsutil tonemap -f png -t artware_PMM_maxPasses=100.exr</span><br></pre></td></tr></table></figure>

<ul>
<li>运行速度比 SPPM 慢很多，初始的建立以及每个 pass 都比较慢</li>
<li>效果如下<ul>
<li>比 PM 的效果更好，而且不会导致内存爆炸的问题，运行速度比 PM 慢</li>
<li>噪点比较多，收敛的问题</li>
</ul>
</li>
</ul>
<img src="methodsCompare/artware_PMM_maxPasses=100.png" style="zoom: 50%;" />





<h4 id="sppm"><a href="#sppm" class="headerlink" title="sppm"></a>sppm</h4><ul>
<li>Stochastic progressive photon mapping integrator</li>
<li>随机渐进式光子映射</li>
<li>分批生成，分批估计</li>
<li>服务器上给的参数直接尝试运行时间太久了，我们把 pass 修改为 100</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">integrator</span> <span class="attr">type</span>=<span class="string">&quot;sppm&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">integer</span> <span class="attr">name</span>=<span class="string">&quot;maxDepth&quot;</span> <span class="attr">value</span>=<span class="string">&quot;33&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">boolean</span> <span class="attr">name</span>=<span class="string">&quot;strictNormals&quot;</span> <span class="attr">value</span>=<span class="string">&quot;true&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">integer</span> <span class="attr">name</span>=<span class="string">&quot;kNN&quot;</span> <span class="attr">value</span>=<span class="string">&quot;10&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">integer</span> <span class="attr">name</span>=<span class="string">&quot;maxPasses&quot;</span> <span class="attr">value</span>=<span class="string">&quot;100&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">integer</span> <span class="attr">name</span>=<span class="string">&quot;stepSnapshot&quot;</span> <span class="attr">value</span>=<span class="string">&quot;10000&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">integer</span> <span class="attr">name</span>=<span class="string">&quot;photonCount&quot;</span> <span class="attr">value</span>=<span class="string">&quot;655360&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">float</span> <span class="attr">name</span>=<span class="string">&quot;k&quot;</span> <span class="attr">value</span>=<span class="string">&quot;0.8&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">float</span> <span class="attr">name</span>=<span class="string">&quot;beta&quot;</span> <span class="attr">value</span>=<span class="string">&quot;1.2&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">integrator</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">~/mitsuba-VCM/dist/mitsuba -o artware_SPMM_maxPasses=100 artware_use.xml</span><br><span class="line">~/mitsuba-VCM/dist/mtsutil tonemap -f png -t artware_SPMM_maxPasses=100.exr</span><br></pre></td></tr></table></figure>

<ul>
<li>运行时间相对较长，效果如下<ul>
<li>SPPM 算法达到收敛需要比较长的时间，我们只是使用了 100 pass，因此图上还是出现了一些模糊的现象（有偏导致的）</li>
</ul>
</li>
</ul>
<img src="methodsCompare/artware_SPMM_maxPasses=100.png" style="zoom: 50%;" />

<ul>
<li>增大 maxPasses &#x3D; 1000，效果如下<ul>
<li>我们可以看到整体而言，模糊程度比 100 小了好多，这是因为 PM 是一致的<ul>
<li>当采样数足够多的时候，$\Delta S$ 足够小，此时是正确的</li>
</ul>
</li>
<li>但是出现了一些白色的亮点，这是由于高贡献路径采样概率小导致的，需要更多的采样数直至收敛才能解决</li>
</ul>
</li>
</ul>
<img src="methodsCompare/artware_SPMM_maxPasses=1000.png" style="zoom: 50%;" />



<h4 id="mlt"><a href="#mlt" class="headerlink" title="mlt"></a>mlt</h4><ul>
<li>Path SpaceMetropolis Light Transport</li>
<li>利用 MCMC 算法能够比较快的从一条有效路径找到其他有效路径</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">integrator</span> <span class="attr">type</span>=<span class="string">&quot;mlt&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">integer</span> <span class="attr">name</span>=<span class="string">&quot;maxDepth&quot;</span> <span class="attr">value</span>=<span class="string">&quot;33&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">boolean</span> <span class="attr">name</span>=<span class="string">&quot;twoStage&quot;</span> <span class="attr">value</span>=<span class="string">&quot;false&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">integrator</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">~/mitsuba-VCM/dist/mitsuba -o artware_MLT_not_2stage artware_use.xml</span><br><span class="line">~/mitsuba-VCM/dist/mtsutil tonemap -f png -t artware_MLT_not_2stage.exr</span><br></pre></td></tr></table></figure>

<ul>
<li>运行很快</li>
<li>能够采样到一些概率较低的路径，但是整体而言效果并不是很好，可能需要其他算法的初始路径作为根据</li>
</ul>
<img src="methodsCompare/artware_MLT_not_2stage.png" style="zoom: 50%;" />

<ul>
<li>2stage：第一遍得到一张低分辨率的图（用于估计分布），第二遍开始真正的渲染</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">integrator</span> <span class="attr">type</span>=<span class="string">&quot;mlt&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">integer</span> <span class="attr">name</span>=<span class="string">&quot;maxDepth&quot;</span> <span class="attr">value</span>=<span class="string">&quot;33&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">boolean</span> <span class="attr">name</span>=<span class="string">&quot;twoStage&quot;</span> <span class="attr">value</span>=<span class="string">&quot;true&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">integrator</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">~/mitsuba-VCM/dist/mitsuba -o artware_MLT_2stage artware_use.xml</span><br><span class="line">~/mitsuba-VCM/dist/mtsutil tonemap -f png -t artware_MLT_2stage.exr</span><br></pre></td></tr></table></figure>

<ul>
<li>效果如下，感觉不是太懂为什么是这样的，似乎光源都没了</li>
</ul>
<img src="methodsCompare/artware_MLT_2stage.png" style="zoom: 50%;" />





<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><ul>
<li><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/115244695">ssh&#x2F;scp</a></li>
<li><a target="_blank" rel="noopener" href="http://mitsuba-renderer.org/docs.html">mitsuba 0.5 官方文档</a></li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/04/26/CG/mitsuba/methodsCompare/" data-id="cl9lj749y009f64tz0l17cb59" data-title="mitsuba.不同渲染方法在不同场景上的对比" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/CG/" rel="tag">CG</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/mitsuba/" rel="tag">mitsuba</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-CG/mitsuba/mitsuba-0-6-installation" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/04/26/CG/mitsuba/mitsuba-0-6-installation/" class="article-date">
  <time class="dt-published" datetime="2021-04-26T06:36:12.000Z" itemprop="datePublished">2021-04-26</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/installation/">installation</a>►<a class="article-category-link" href="/categories/mitsuba/">mitsuba</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2021/04/26/CG/mitsuba/mitsuba-0-6-installation/">mitsuba 0.6 在 Win10 上的环境配置</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="mitsuba0-6-配置"><a href="#mitsuba0-6-配置" class="headerlink" title="mitsuba0.6 配置"></a>mitsuba0.6 配置</h1><h2 id="环境"><a href="#环境" class="headerlink" title="环境"></a>环境</h2><ul>
<li>Win10</li>
<li>VS2017</li>
<li>mitsuba 0.6</li>
</ul>
<h2 id="下载源代码"><a href="#下载源代码" class="headerlink" title="下载源代码"></a>下载源代码</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git clone --recursive https://github.com/mitsuba-renderer/mitsuba.git</span><br></pre></td></tr></table></figure>



<h2 id="说明"><a href="#说明" class="headerlink" title="说明"></a>说明</h2><ul>
<li>使用 <code>mitsuba-msvc2017.sln</code><ul>
<li>也没问题，需要在环境变量中把  python 的路径修改为下面配置的 2.7，同时把 scons 加入环境变量</li>
<li>重启 <code>mitsuba-msvc2017.sln</code> 即可</li>
</ul>
</li>
<li><strong>最终使用了命令行编译</strong>，但是使用了 MSVC 的工具<ul>
<li>需要配置一些 <code>msvc</code> 的环境变量，如果你没有配置的话</li>
</ul>
</li>
</ul>
<h2 id="required-build-dependency"><a href="#required-build-dependency" class="headerlink" title="required build dependency"></a>required build dependency</h2><ul>
<li>需要下载一些依赖库<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/mitsuba-renderer/dependencies_win64">下载链接</a></li>
</ul>
</li>
<li>解压到 <code>mitsuba</code> 文件夹下，重命名为 <code>dependencies</code></li>
</ul>
<h2 id="configuration"><a href="#configuration" class="headerlink" title="configuration"></a>configuration</h2><ul>
<li>把 build 文件夹下的 <code>config-win64-msvc2017.py</code> 复制到 mitsuba 根目录下，重命名为 <code>config.py</code></li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">copy build\config-win64-msvc2017.py .\config.py</span><br></pre></td></tr></table></figure>



<h2 id="安装一个-python2-7-的环境"><a href="#安装一个-python2-7-的环境" class="headerlink" title="安装一个 python2.7 的环境"></a>安装一个 python2.7 的环境</h2><ul>
<li><code>config.py</code> 中使用的是 2.7 的语法<ul>
<li><code>print</code> 语法</li>
</ul>
</li>
<li>利用 anaconda 创建一个 2.7 的环境</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">conda create -n py27 python=2.7</span><br></pre></td></tr></table></figure>



<h2 id="安装-scons"><a href="#安装-scons" class="headerlink" title="安装 scons"></a>安装 scons</h2><ul>
<li>利用提供的 scons 2.5.1<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/mitsuba-renderer/dependencies_win64">https://github.com/mitsuba-renderer/dependencies_win64</a></li>
</ul>
</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">activate py27</span><br><span class="line">python setup.py install</span><br></pre></td></tr></table></figure>



<h2 id="UnicodeDecodeError"><a href="#UnicodeDecodeError" class="headerlink" title="UnicodeDecodeError"></a>UnicodeDecodeError</h2><ul>
<li>UnicodeDecodeError: ‘ascii’ codec can’t decode byte 0xc9 in position 9: ordinal not in range(128):</li>
<li><code>scons</code> 在编译时候会检查所有的环境变量（不仅仅是 path），如果环境变量中含有非 ascii 码的字符就会报错退出</li>
<li>暂时的解决方案是把环境变量中的中文部分做一个修改（或者临时备份，到时候再改回去）</li>
</ul>
<h2 id="运行编译程序"><a href="#运行编译程序" class="headerlink" title="运行编译程序"></a>运行编译程序</h2><ul>
<li>在 mitsuba 根目录下运行如下命令即可顺利编译<ul>
<li>需要配置好 MSVC 的环境变量</li>
</ul>
</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">activate py27</span><br><span class="line">scons -j20</span><br></pre></td></tr></table></figure>

<ul>
<li>或者配置好 py27&#x2F;scons 的环境变量使用 <code>mitsuba-msvc2017.sln</code> 编译</li>
</ul>
<h2 id="Qt"><a href="#Qt" class="headerlink" title="Qt"></a>Qt</h2><ul>
<li>到此为止应该能够运行 <code>mitsuba.exe</code> 了，但是还是不能运行 <code>misgui.exe</code><ul>
<li>dist 目录下</li>
</ul>
</li>
<li>可以从 <code>dependencies\include\QtCore</code> 中看到 Qt 的版本是 <code>5.9.1</code> ，去官网下载对应版本</li>
<li><a target="_blank" rel="noopener" href="https://download.qt.io/archive/qt/5.9/5.9.1/">https://download.qt.io/archive/qt/5.9/5.9.1/</a></li>
<li>安装的时候除了默认选项之外，我把所有的 <code>VS2017</code> 相关的都加上了</li>
<li>安装完之后把安装目录下的 <code>platforms/qwindows.dll</code> 复制到 <code>dist/platforms/qwindows.dll</code><ul>
<li>可以在安装目录下搜索 <code>qwindows.dll</code></li>
</ul>
</li>
<li>由于版本问题，需要用 <code>Qt</code> 安装目录下的同名文件覆盖 <code>mtsgui.exe</code> 同目录下的如下文件</li>
</ul>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Qt5Core.dll</span><br><span class="line">Qt5Gui.dll</span><br><span class="line">Qt5Network.dll</span><br><span class="line">Qt5OpenGL.dll</span><br><span class="line">Qt5Widgets.dll</span><br><span class="line">Qt5Xml.dll</span><br><span class="line">Qt5XmlPatterns.dll</span><br></pre></td></tr></table></figure>



<h2 id="大功告成"><a href="#大功告成" class="headerlink" title="大功告成"></a>大功告成</h2><h2 id="安装过程中踩的坑"><a href="#安装过程中踩的坑" class="headerlink" title="安装过程中踩的坑"></a>安装过程中踩的坑</h2><h3 id="1-安装-scons-不能这么安装-版本太高"><a href="#1-安装-scons-不能这么安装-版本太高" class="headerlink" title="(1) 安装 scons(不能这么安装, 版本太高)"></a>(1) 安装 scons(不能这么安装, 版本太高)</h3><ul>
<li><span style="color:red;font-weight:bold">不能这么安装, 版本太高</span><ul>
<li>4.1</li>
</ul>
</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python -m pip install scons</span><br></pre></td></tr></table></figure>

<ul>
<li>注意需要把 <code>python</code> 安装的 <code>Scripts</code> 添加到环境变量 <code>PATH</code> 中</li>
<li>例如</li>
</ul>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">d:\installed application\python\scripts\</span><br></pre></td></tr></table></figure>



<h3 id="2-scons-2-5-1-只支持-python2-x"><a href="#2-scons-2-5-1-只支持-python2-x" class="headerlink" title="(2) scons 2.5.1 只支持 python2.x"></a>(2) scons 2.5.1 只支持 python2.x</h3><ul>
<li>修改 python 为 3.x 失败</li>
</ul>
<h4 id="之前的修改方式"><a href="#之前的修改方式" class="headerlink" title="之前的修改方式"></a>之前的修改方式</h4><ul>
<li>利用正则表达式修改为 <code>py3</code> 语法<ul>
<li>notepad++</li>
<li>注意原来的 L175 是多行的，需要手动改一下</li>
</ul>
</li>
</ul>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">print([^\n\r]*)</span><br><span class="line">-&gt;</span><br><span class="line">print\(\1\)</span><br></pre></td></tr></table></figure>



<h3 id="3-一个问题"><a href="#3-一个问题" class="headerlink" title="(3) 一个问题"></a>(3) 一个问题</h3><ul>
<li>如果通过 <code>mitsuba-msvc2017.sln</code> 安装的话，需要临时修改环境变量<ul>
<li>scons 安装在了环境 py27 下</li>
<li>于是 VS2017 调用的应该也是这个环境，而不是我们之前的环境</li>
<li>暂时的解决方案是把环境变量暂时设置为 py27 的环境</li>
</ul>
</li>
</ul>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">d:\installed application\python\scripts\</span><br><span class="line">D:\installed application\python</span><br></pre></td></tr></table></figure>

<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">D:\installed-application\Anaconda3\envs\py27\Scripts</span><br><span class="line">D:\installed-application\Anaconda3\envs\py27</span><br></pre></td></tr></table></figure>



<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><ul>
<li><a target="_blank" rel="noopener" href="https://github.com/mitsuba-renderer/mitsuba/issues/">https://github.com/mitsuba-renderer/mitsuba/issues/</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/mitsuba-renderer/mitsuba/issues/52#issuecomment-356929115">https://github.com/mitsuba-renderer/mitsuba/issues/52#issuecomment-356929115</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/mitsuba-renderer/mitsuba/issues/143">https://github.com/mitsuba-renderer/mitsuba/issues/143</a></li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/04/26/CG/mitsuba/mitsuba-0-6-installation/" data-id="cl9lj749z009j64tzdsob7hi1" data-title="mitsuba 0.6 在 Win10 上的环境配置" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/CG/" rel="tag">CG</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/installation/" rel="tag">installation</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/mitsuba/" rel="tag">mitsuba</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-CG/YLQ-GAMES202/07" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/04/24/CG/YLQ-GAMES202/07/" class="article-date">
  <time class="dt-published" datetime="2021-04-24T05:36:43.000Z" itemprop="datePublished">2021-04-24</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/CG-GAMES202/">CG.GAMES202</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2021/04/24/CG/YLQ-GAMES202/07/">GAMES202.闫令琪.07.实时全局光照(3D空间)</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <ul>
<li><a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1YK4y1T7yY">https://www.bilibili.com/video/BV1YK4y1T7yY</a></li>
</ul>
<h1 id="3D空间实时全局光照"><a href="#3D空间实时全局光照" class="headerlink" title="3D空间实时全局光照"></a>3D空间实时全局光照</h1><ul>
<li>Global Illumination (GI) is important but complex<ul>
<li><strong>GI</strong>：Global Illumination</li>
</ul>
</li>
</ul>
<img src="07/image-20210424222703305.png" style="zoom:40%;" />



<h2 id="one-bounce"><a href="#one-bounce" class="headerlink" title="one-bounce"></a>one-bounce</h2><ul>
<li>实时渲染中，我们主要解决的全局光照之的主要是 <strong>one-bounce</strong> 的间接光照</li>
<li>one-bounce</li>
</ul>
<img src="07/image-20210424222841739.png" style="zoom:70%;" />

<ul>
<li>一切被光源直接照亮的物体，都可以作为<strong>次级光源</strong>去照亮其他物体<ul>
<li>原始的光源：primary light source</li>
</ul>
</li>
</ul>
<h2 id="分类"><a href="#分类" class="headerlink" title="分类"></a>分类</h2><ul>
<li>3D 空间的方法<ul>
<li>RSM</li>
<li>VXGI</li>
</ul>
</li>
<li>图像空间<ul>
<li>SSAO</li>
<li>SSDO</li>
<li>SSR</li>
</ul>
</li>
</ul>
<h2 id="RSM"><a href="#RSM" class="headerlink" title="RSM"></a>RSM</h2><ul>
<li>Reflective Shadow Mapping</li>
</ul>
<h3 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h3><ul>
<li>那些部分可以被作为次级光源<ul>
<li>Shadow Mapping</li>
</ul>
</li>
<li>每个次级光源对 shading point 的贡献是多少<ul>
<li>把每一小区域都当做是面光源</li>
<li>采样方法</li>
</ul>
</li>
</ul>
<h3 id="次级光源"><a href="#次级光源" class="headerlink" title="次级光源"></a>次级光源</h3><ul>
<li>使用 shadow map 解决</li>
<li>对于 SM 而言，认为每一个像素对应一个小片</li>
<li>同样的理解，我们可以把这些小片对应的区域都作为次级光源</li>
<li>计算量很大：<strong>采样</strong></li>
<li>产生了一个问题，我们在计算次级光源 shading 的时候，我们是在 light 的位置去观察的，我们不知道这些次级光源之后用于渲染其他物体的时候的入射方向是什么（次级光源的出射方向不知道）</li>
<li>怎么让结果不依赖于出射方向呢？<ul>
<li><strong>经典假设</strong>：所有反射物（次级光源）都是 diffuse 的</li>
</ul>
</li>
</ul>
<h3 id="怎么用次级光源去照亮"><a href="#怎么用次级光源去照亮" class="headerlink" title="怎么用次级光源去照亮"></a>怎么用次级光源去照亮</h3><img src="07/image-20210424224344549.png" style="zoom: 50%;" />

<ul>
<li>对（次级）光源采样</li>
</ul>
<p>$$<br>\begin{aligned}<br>L_o(p,\omega_o)<br>&amp;&#x3D;\int_{\Omega_{patch}}L_i(p,\omega_i)V(p,\omega_i)f_r(p,\omega_i,\omega_o)\cos\theta_i d\omega_i\<br>&amp;&#x3D;\int_{A_{patch}} L_{i}(q\to p) V(q\to p)f_{r}(p, q\to p, \omega_{o})\dfrac{\cos\theta_p\cos\theta_q}{||p-q||^2}dA\<br>\end{aligned}<br>$$</p>
<ul>
<li>如果 patch 的数量比较少，可以直接求和</li>
<li>对于次级光源，diffuse<ul>
<li>BRDF：$f_r’&#x3D;\dfrac{\rho}{\pi}$<ul>
<li>注意不是上面渲染方程里的，而是针对次级光源 p 处的，上面的是 q 处的</li>
</ul>
</li>
<li>$L_i&#x3D;f_r’\dfrac{\Phi}{dA}$<ul>
<li>$\Phi$：入射的 flux</li>
<li>BRDF 的定义</li>
<li>带入渲染方程，发现不需要知道 patch 对应的大小（消掉了）</li>
<li>只需要知道 $\Phi$ 即可</li>
</ul>
</li>
</ul>
</li>
<li>可见性检测，V 很难做<ul>
<li><strong>不好算就不算了</strong></li>
</ul>
</li>
<li>论文中的系数<ul>
<li>4 次方</li>
<li><span style="color:red;font-weight:bold">和我们推导的是一致的</span></li>
<li>分子中 $x-x_p$ 没有归一化，归一化之后是一样的</li>
</ul>
</li>
</ul>
<img src="07/image-20210424233936824.png" style="zoom:50%;" />



<h3 id="一些细节"><a href="#一些细节" class="headerlink" title="一些细节"></a>一些细节</h3><ul>
<li>不是所有的次级光源都会对 shading point 有贡献<ul>
<li>可见性（很难）</li>
<li>距离</li>
<li>朝向<ul>
<li>例如桌子上的点不会照亮 x 点</li>
</ul>
</li>
</ul>
</li>
</ul>
<img src="07/image-20210424234651564.png" style="zoom:50%;" />

<ul>
<li>只需要找离 shading point 比较近的点采样<ul>
<li>平方衰减</li>
</ul>
</li>
<li>论文大胆的假设，在 SM 中离得比较近，表示在世界坐标系中离得比较近<ul>
<li>加速采样</li>
</ul>
</li>
<li>具体采样方法<ul>
<li>近的点贡献大，多采样一点</li>
<li>远的点少采样一点，但是把面积做大一点</li>
<li>400 个 sample 效果就不错</li>
</ul>
</li>
</ul>
<img src="07/image-20210424234745199.png" style="zoom:50%;" />

<ul>
<li>存储开销<ul>
<li>shadow map（depth）</li>
<li>flux</li>
<li>世界坐标系法向</li>
<li>世界坐标系位置</li>
</ul>
</li>
<li><strong>RSM 对手电筒的模拟效果非常好</strong></li>
</ul>
<h3 id="评价"><a href="#评价" class="headerlink" title="评价"></a>评价</h3><ul>
<li>pros<ul>
<li>很容易实现：基于 shadow map 算法</li>
</ul>
</li>
<li>cons<ul>
<li>直接光源个数有多少个，就需要做多少个 SM（SM 原生问题）</li>
<li>次级光源照亮物体时没考虑可见性</li>
<li>很多假设：计算在次级光源处的 shading 的时候做了 diffuse 的假设</li>
<li>深度图之间的距离代替世界坐标系的距离</li>
<li>采样率和效率之间的 trade off</li>
</ul>
</li>
</ul>
<h3 id="其他想法"><a href="#其他想法" class="headerlink" title="其他想法"></a>其他想法</h3><ul>
<li>RSM 中的次级光源和离线渲染中的 VPL 非常接近<ul>
<li>virtual point light</li>
</ul>
</li>
<li>认为 RSM 还是属于 3D 的方法，而不是图像空间的方法<ul>
<li>因为准确记录了信息，而且第二个 pass 的时候还是在 3D 空间中计算的</li>
</ul>
</li>
</ul>
<h2 id="LPV"><a href="#LPV" class="headerlink" title="LPV"></a>LPV</h2><ul>
<li>Light Propagation Volumes (LPV)</li>
<li>最早在 CryEngine3 中被提出<ul>
<li>Crisis 游戏</li>
</ul>
</li>
<li>关键问题<ul>
<li>对于每一个 shading point 能够很快的获得来自各个方向的 radiance</li>
</ul>
</li>
<li>LPV 的关键想法：radiance 直线传播，传播过程中是不变的</li>
<li>把场景划分为 3D 的网格<ul>
<li>Voxel 体素</li>
</ul>
</li>
</ul>
<img src="07/image-20210429151639562.png" style="zoom:50%;" />

<ul>
<li>问题抽象（上图是一个 2D 的例子）<ul>
<li>蓝色：直接光源</li>
<li>红色：被光源直接照亮的物体</li>
<li>黄色：询问来自各个方向的 radiance</li>
</ul>
</li>
</ul>
<h3 id="算法步骤"><a href="#算法步骤" class="headerlink" title="算法步骤"></a>算法步骤</h3><ul>
<li>Generation of radiance point set scene representation<ul>
<li>确定哪一些点会发出间接光照（次级光源）</li>
</ul>
</li>
<li>Injection of point cloud of virtual light sources into radiance volume<ul>
<li>把次级光源放到场景的网格中</li>
</ul>
</li>
<li>Volumetric radiance propagation<ul>
<li>将 radiance 在网格中进行传播</li>
</ul>
</li>
<li>Scene lighting with final light propagation volume<ul>
<li>直接利用这些 radiance 进行光照计算</li>
</ul>
</li>
</ul>
<h4 id="Step-1-Generation"><a href="#Step-1-Generation" class="headerlink" title="Step 1: Generation"></a>Step 1: Generation</h4><ul>
<li>找到次级光源<ul>
<li>可以简单地通过 RSM 找到</li>
</ul>
</li>
<li>不一定需要使用所有的次级光源，可以对其进行一些采样</li>
</ul>
<h4 id="Step-2-Injection"><a href="#Step-2-Injection" class="headerlink" title="Step 2: Injection"></a>Step 2: Injection</h4><ul>
<li>首先将场景划分为 3D 的网格</li>
<li>对于每一个网格，我们找到网格内的次级光源<ul>
<li>对于每个方向的 radiance 进行求和</li>
<li>使用 SH 进行压缩（2阶就够了）<ul>
<li>使用 SH 压缩，于是只能得到一些相对低阶的项，因此对于 diffuse 场景支持较好</li>
</ul>
</li>
</ul>
</li>
</ul>
<img src="07/image-20210429153000429.png" style="zoom:50%;" />



<h4 id="Step3-Propagation"><a href="#Step3-Propagation" class="headerlink" title="Step3: Propagation"></a>Step3: Propagation</h4><ul>
<li>对于每一个网格，考虑它周围的 6 个邻接的网格传播过来的 radiance<ul>
<li>求和，然后使用 SH 进行压缩</li>
<li>实际操作可能是对每个点向周围 6 个面的传播</li>
</ul>
</li>
<li>最终迭代至不动点<ul>
<li>一般迭代四五次就能够稳定下来</li>
</ul>
</li>
<li><strong>在传播的过程中，我们不考虑可见性</strong></li>
</ul>
<img src="07/image-20210429153128762.png" style="zoom:50%;" />



<h4 id="Step-4-Rendering"><a href="#Step-4-Rendering" class="headerlink" title="Step 4: Rendering"></a>Step 4: Rendering</h4><ul>
<li>对于任意的 shading point，我们找到它位于哪一个具体的网格中，通过记录的不同方向的 radiance 进行计算</li>
</ul>
<h3 id="问题-1"><a href="#问题-1" class="headerlink" title="问题"></a>问题</h3><ul>
<li>如下图，我们将一个网格内的点的 radiance 都认为是一样的，但是实际上 p 点不会照亮对应网格中的蓝色点<ul>
<li>造成 light leaking 的问题</li>
</ul>
</li>
</ul>
<img src="07/image-20210429153458743.png" style="zoom:50%;" />

<ul>
<li>LPV 和 对比图</li>
</ul>
<p><img src="/07/image-20210429153707871.png"></p>
<ul>
<li>根本原因：网格的精度问题，如果存在某个场景中的几何粒度比网格要小，这样就可能会导致上面的现象</li>
<li>增大精度<ul>
<li>存储开销变大</li>
<li>propagation 不容易稳定，计算开销变大</li>
</ul>
</li>
<li>工业界的实现会使用不同精度层次的网格<ul>
<li>学术界叫法：multi-scale</li>
<li>工业界叫法：cascaded</li>
</ul>
</li>
<li>对于每一个光源，都需要用一次 RSM 算法<ul>
<li>注入之后的传播只需要一次</li>
</ul>
</li>
<li>LPV 是实时计算的，而不是预计算</li>
</ul>
<h2 id="VXGI"><a href="#VXGI" class="headerlink" title="VXGI"></a>VXGI</h2><ul>
<li>Voxel Global Illumination (VXGI)</li>
<li>two-pass 的算法</li>
</ul>
<h3 id="和-RSM-的区别"><a href="#和-RSM-的区别" class="headerlink" title="和 RSM 的区别"></a>和 RSM 的区别</h3><ul>
<li>RSM 的光源是每个像素表示的微小表面</li>
<li>VXGI 将整个场景离散成很多个格子<ul>
<li>例如八叉树的方式组织整个场景</li>
</ul>
</li>
</ul>
<img src="07/image-20210429154900906.png" style="zoom: 50%;" />

<ul>
<li>渲染的时候从相机出发，对每个像素发出 eye ray，对于场景中碰到的点进行 cone tracing<ul>
<li>glossy 物体的反射叶是一个锥形的区域</li>
</ul>
</li>
</ul>
<h3 id="具体步骤"><a href="#具体步骤" class="headerlink" title="具体步骤"></a>具体步骤</h3><p><img src="/07/image-20210429155540446.png"></p>
<h4 id="pass-1-from-the-light"><a href="#pass-1-from-the-light" class="headerlink" title="pass 1: from the light"></a>pass 1: from the light</h4><ul>
<li>首先我们需要对整个场景体素化，建立一个层次结构<ul>
<li>需要在层次结构中更新</li>
<li>更多的情况，高层结构是将低层结构收集起来（合并）</li>
</ul>
</li>
<li>在每1个体素中记录法线的分布、光源入射方向的分布</li>
</ul>
<h4 id="pass-2-from-the-camera"><a href="#pass-2-from-the-camera" class="headerlink" title="pass 2: from the camera"></a>pass 2: from the camera</h4><h5 id="glossy-物体"><a href="#glossy-物体" class="headerlink" title="glossy 物体"></a>glossy 物体</h5><ul>
<li>对于 glossy 的物体，反射叶就是一个锥形</li>
<li>一种最简单的方法，从 shading point 连出一个圆锥，逐体素是否和圆锥相交，如果相交，则计算整个体素对于 shading point 的贡献值<ul>
<li>加速：圆锥的大小在传播过程中是越来越大的，因此我们可以通过距离估计出范围大小，然后在八叉树的对应层次结构中对应的一块即可</li>
</ul>
</li>
</ul>
<img src="07/image-20210429155927647.png" style="zoom:50%;" />

<img src="07/image-20210429160538316.png" style="zoom:50%;" />



<h5 id="diffuse-物体"><a href="#diffuse-物体" class="headerlink" title="diffuse 物体"></a>diffuse 物体</h5><ul>
<li>可以使用若干圆锥近似<ul>
<li>圆锥之间有缝，但是这对于 diffuse 物体是可以接受的</li>
</ul>
</li>
</ul>
<img src="07/image-20210429160555277.png" style="zoom:50%;" />



<h2 id="评价-1"><a href="#评价-1" class="headerlink" title="评价"></a>评价</h2><ul>
<li>在当时的情况下，算是比较好的一种方法<ul>
<li>很像我们在离线渲染中做的 photon mapping 的操作</li>
</ul>
</li>
<li>存在一些他自己的问题<ul>
<li>由于开销较大，应用比较少</li>
<li>场景的体素化是很麻烦的，可能需要预计算<ul>
<li>对于动态场景而言更是如此，每一帧可能都得重建</li>
</ul>
</li>
</ul>
</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/04/24/CG/YLQ-GAMES202/07/" data-id="cl9lj749u008k64tzct2kbdtr" data-title="GAMES202.闫令琪.07.实时全局光照(3D空间)" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/CG/" rel="tag">CG</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/YLQ/" rel="tag">YLQ</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-DB/CLJ/04-3" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/04/24/DB/CLJ/04-3/" class="article-date">
  <time class="dt-published" datetime="2021-04-24T01:43:14.000Z" itemprop="datePublished">2021-04-24</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/DB-CLJ/">DB.CLJ</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2021/04/24/DB/CLJ/04-3/">数据库概论.陈立军.04.SQL 数据查询(2)</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="SQL-数据查询"><a href="#SQL-数据查询" class="headerlink" title="SQL 数据查询"></a>SQL 数据查询</h1><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Select</span> ...</span><br><span class="line"><span class="keyword">From</span> ...</span><br><span class="line"><span class="keyword">Where</span> ...</span><br><span class="line"><span class="keyword">Group</span> <span class="keyword">by</span> ...</span><br><span class="line"><span class="keyword">Having</span> ...</span><br><span class="line"><span class="keyword">Union</span> ...</span><br><span class="line"><span class="keyword">Order</span> <span class="keyword">by</span> ...</span><br><span class="line">Limit ...</span><br></pre></td></tr></table></figure>

<h2 id="在线资源"><a href="#在线资源" class="headerlink" title="在线资源"></a>在线资源</h2><ul>
<li><a target="_blank" rel="noopener" href="http://sqlfiddle.com/">http://sqlfiddle.com</a></li>
</ul>
<h2 id="分组"><a href="#分组" class="headerlink" title="分组"></a>分组</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> 列名 [ <span class="keyword">having</span> 条件表达式 ]</span><br></pre></td></tr></table></figure>

<ul>
<li>group by 将表中行按指定列上值相等的原则分组，然后在每一分组上使用聚集函数，得到单一值</li>
<li>having 对<strong>分组</strong>进行选择，只将聚集函数作用到<strong>满足条件的分组</strong>上</li>
</ul>
<h3 id="需求"><a href="#需求" class="headerlink" title="需求"></a>需求</h3><ul>
<li>统计每个同学的平均成绩</li>
<li>统计每个课程的平均成绩</li>
</ul>
<h3 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h3><ul>
<li><strong>目标列必须是分组属性</strong></li>
<li>select 语句后面的列必须是 group by 后面的列<ul>
<li>因为在 group by 之后，对每一个 group 会输出一条记录，使用其他的属性会导致每一个属性有多个值，不满足原子性<ul>
<li>MySQL 测试好像是可以的，不过只输出第一条记录</li>
</ul>
</li>
</ul>
</li>
<li><strong>如果其他属性使用的是聚集函数，那么是可以的</strong></li>
<li>列出每个学生的最高、最低、平均成绩</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> sno, <span class="built_in">max</span>(grade), <span class="built_in">min</span>(grade), <span class="built_in">avg</span>(grade)</span><br><span class="line"><span class="keyword">from</span> SC</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> sno</span><br></pre></td></tr></table></figure>

<ul>
<li>having 是对分组进行过滤</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* 列出没有挂科经历同学的平均成绩 */</span></span><br><span class="line"><span class="keyword">select</span> sno, <span class="built_in">avg</span>(grade)</span><br><span class="line"><span class="keyword">from</span> SC</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> sno</span><br><span class="line"><span class="keyword">having</span> <span class="built_in">min</span>(grade)<span class="operator">&gt;=</span><span class="number">60</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* 列出所有同学及格课程的平均成绩 */</span></span><br><span class="line"><span class="keyword">select</span> sno, <span class="built_in">avg</span>(grade)</span><br><span class="line"><span class="keyword">from</span> SC</span><br><span class="line"><span class="keyword">where</span> grade<span class="operator">&gt;=</span><span class="number">60</span></span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> sno</span><br></pre></td></tr></table></figure>



<h3 id="分组查询中各子句的顺序"><a href="#分组查询中各子句的顺序" class="headerlink" title="分组查询中各子句的顺序"></a>分组查询中各子句的顺序</h3><ul>
<li>列出每一年龄组中男学生（超过50人）的人数</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> age, <span class="built_in">count</span>(sno)</span><br><span class="line"><span class="keyword">from</span> S</span><br><span class="line"><span class="keyword">where</span> sex<span class="operator">=</span><span class="string">&#x27;M&#x27;</span></span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> age</span><br><span class="line"><span class="keyword">having</span> <span class="built_in">count</span>(<span class="operator">*</span>)<span class="operator">&gt;</span><span class="number">50</span></span><br></pre></td></tr></table></figure>

<ul>
<li>执行顺序<ul>
<li>where、group by、having</li>
<li>先过滤、再分组、在对分组进行选择</li>
</ul>
</li>
</ul>
<h3 id="group-concat"><a href="#group-concat" class="headerlink" title="group_concat"></a>group_concat</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> dname,</span><br><span class="line">    group_concat(sname)</span><br><span class="line"><span class="keyword">from</span> ds</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> dname</span><br></pre></td></tr></table></figure>

<ul>
<li>串接字符串的功能</li>
<li>例如上面的 select 之中的列如果不是 group by 中的属性列，把 group_concat 当作一个聚集函数，作用是把这一组内的所有数据用 <code>,</code> 拼接成字符串</li>
</ul>
<h3 id="cube"><a href="#cube" class="headerlink" title="cube"></a>cube</h3><ul>
<li>对 group by 的扩展</li>
<li>所有的 group by 进行一个预先计算，把结果保存起来，这样在之后机型 group by 的操作的时候，很快就可以得到结果</li>
</ul>
<p>$$<br>\mathrm{Cube}&#x3D;\bigcup_{A_i\in A}\mathrm{group\ by} A_{i}<br>$$</p>
<ul>
<li>n 个属性的 group by，一共有 $2^n$ 个</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> Model,<span class="keyword">Year</span>,Color,<span class="built_in">sum</span>(Sales)</span><br><span class="line"><span class="keyword">from</span> car_sales</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> Model,<span class="keyword">Year</span>,Color <span class="keyword">with</span> <span class="keyword">cube</span></span><br></pre></td></tr></table></figure>

<ul>
<li><strong>行数计算</strong><ul>
<li>(model值个数+1) x (year值个数+1) x (color值个数+1)</li>
</ul>
</li>
</ul>
<img src="04-3/image-20210425233923278.png" style="zoom:50%;" />

<ul>
<li>cube 在实际过程中并不是生成 All，而是为每条记录生成一个 null<ul>
<li>问题来了，怎么区分原来的 null 和生成的 null（我们需要处理成 All）</li>
<li><strong>grouping</strong></li>
</ul>
</li>
</ul>
<h4 id="grouping"><a href="#grouping" class="headerlink" title="grouping"></a>grouping</h4><ul>
<li>grouping 是一个聚合函数</li>
<li>它产生一个附加的列，当用 cube 或 rollup 运算符添加行时，附加的列输出值为 1，否则为 0</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="string">&#x27;TotleSold&#x27;</span> <span class="operator">=</span> <span class="built_in">sum</span>(sales),</span><br><span class="line">    <span class="keyword">case</span> <span class="keyword">when</span>(<span class="keyword">grouping</span>(model)<span class="operator">=</span><span class="number">1</span>) <span class="keyword">then</span> <span class="string">&#x27;ALL&#x27;</span></span><br><span class="line">        <span class="keyword">else</span> isnull(model, <span class="string">&#x27;????&#x27;</span>)</span><br><span class="line">    <span class="keyword">end</span> model,</span><br><span class="line">    <span class="keyword">case</span> <span class="keyword">when</span>(<span class="keyword">grouping</span>(<span class="keyword">year</span>)<span class="operator">=</span><span class="number">1</span>) <span class="keyword">then</span> <span class="string">&#x27;ALL&#x27;</span></span><br><span class="line">        <span class="keyword">else</span> isnull(<span class="keyword">year</span>, <span class="string">&#x27;????&#x27;</span>)</span><br><span class="line">    <span class="keyword">end</span> <span class="keyword">year</span>,</span><br><span class="line">    <span class="keyword">case</span> <span class="keyword">when</span>(<span class="keyword">grouping</span>(color)<span class="operator">=</span><span class="number">1</span>) <span class="keyword">then</span> <span class="string">&#x27;ALL&#x27;</span></span><br><span class="line">        <span class="keyword">else</span> isnull(color, <span class="string">&#x27;????&#x27;</span>)</span><br><span class="line">    <span class="keyword">end</span> color</span><br><span class="line"><span class="keyword">from</span> my_cube</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> model, theyear, color <span class="keyword">with</span> <span class="keyword">cube</span></span><br></pre></td></tr></table></figure>



<h3 id="rollup"><a href="#rollup" class="headerlink" title="rollup"></a>rollup</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> Model,<span class="keyword">Year</span>,Color <span class="keyword">with</span> <span class="keyword">rollup</span></span><br></pre></td></tr></table></figure>



<img src="04-3/image-20210427140108269.png" style="zoom:50%;" />

<ul>
<li>顺序不一样，结果就不一样</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> A, B, C <span class="keyword">with</span> <span class="keyword">rollup</span></span><br><span class="line"><span class="comment">/* 效果上等价于 */</span></span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> A,B,C</span><br><span class="line"><span class="keyword">union</span></span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> A,B</span><br><span class="line"><span class="keyword">union</span></span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> A</span><br><span class="line"><span class="keyword">union</span></span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> &#123;&#125;</span><br></pre></td></tr></table></figure>





<h4 id="行数计算"><a href="#行数计算" class="headerlink" title="行数计算"></a>行数计算</h4><ul>
<li>$|colA|&#x3D;a,|colB|&#x3D;b,|colC|&#x3D;c$</li>
<li>求 <code>group by colA, colB, colC with rollup</code> 的行数是多少</li>
<li>$a*(b*(c+1)+1)+1$</li>
<li><strong>相当于每一个属性增加了一个 All</strong></li>
<li>一个例子</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> color,model, <span class="built_in">sum</span>(amount)</span><br><span class="line"><span class="keyword">from</span> sales</span><br><span class="line"><span class="keyword">group</span> bycolor, model <span class="keyword">with</span> <span class="keyword">rollup</span></span><br></pre></td></tr></table></figure>

<p><img src="/04-3/image-20210427140905325.png"></p>
<h3 id="如何生成多个分组语句的合并报表"><a href="#如何生成多个分组语句的合并报表" class="headerlink" title="如何生成多个分组语句的合并报表"></a>如何生成多个分组语句的合并报表</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> model, <span class="keyword">year</span>, <span class="keyword">null</span> <span class="keyword">as</span> color, <span class="built_in">sum</span>( sales)</span><br><span class="line"><span class="keyword">from</span> car_sales</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> model, <span class="keyword">year</span></span><br><span class="line"><span class="keyword">union</span> <span class="keyword">all</span></span><br><span class="line"><span class="keyword">select</span> model, <span class="keyword">null</span> <span class="keyword">as</span> <span class="keyword">year</span>, color, <span class="built_in">sum</span>(sales)</span><br><span class="line"><span class="keyword">from</span> car_sales</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> model, color</span><br><span class="line"><span class="keyword">union</span> <span class="keyword">all</span></span><br><span class="line"><span class="keyword">select</span> <span class="keyword">null</span> <span class="keyword">as</span> model, <span class="keyword">year</span>, color, <span class="built_in">sum</span>(sales)</span><br><span class="line"><span class="keyword">from</span> car_sales</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> <span class="keyword">year</span>, color</span><br><span class="line"><span class="keyword">union</span> <span class="keyword">all</span></span><br><span class="line"><span class="keyword">select</span> <span class="keyword">null</span> <span class="keyword">as</span> model, <span class="keyword">null</span> <span class="keyword">as</span> <span class="keyword">year</span>, <span class="keyword">null</span> <span class="keyword">as</span> color, <span class="built_in">sum</span>(sales)</span><br><span class="line">fromcar_sales</span><br></pre></td></tr></table></figure>

<ul>
<li>繁琐<ul>
<li>代码繁琐</li>
</ul>
</li>
<li>低效<ul>
<li>car_sale 访问 4 遍</li>
<li>如果 group by 之间有包含关系的话，可以在另外一个基础上进行操作<ul>
<li>例如 <code>group by A</code> 在 <code>group by A, B</code> 的基础上进行</li>
</ul>
</li>
</ul>
</li>
</ul>
<h4 id="分组属性集"><a href="#分组属性集" class="headerlink" title="分组属性集"></a>分组属性集</h4><ul>
<li>grouping sets</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> <span class="keyword">grouping</span> sets ((分组属性集<span class="number">1</span>), (分组属性集<span class="number">2</span>), ..., (分组属性集n))</span><br></pre></td></tr></table></figure>

<ul>
<li>系统可以只扫描一次，如果包含包含关系的话系统可以更加高效的执行</li>
<li>例子</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> model,<span class="keyword">year</span>,color,<span class="built_in">sum</span>(sales)</span><br><span class="line"><span class="keyword">from</span> car_sales</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> <span class="keyword">grouping</span> sets (</span><br><span class="line">    (model,theyear),</span><br><span class="line">    (model,color),</span><br><span class="line">    (theyear,color),</span><br><span class="line">    ()</span><br><span class="line">)</span><br></pre></td></tr></table></figure>



<h4 id="产生分组属性集的代数操作"><a href="#产生分组属性集的代数操作" class="headerlink" title="产生分组属性集的代数操作"></a>产生分组属性集的代数操作</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">cube</span>(a,b) <span class="operator">=</span> <span class="keyword">grouping</span> sets(</span><br><span class="line">    (a,b),</span><br><span class="line">    (a),</span><br><span class="line">    (b),</span><br><span class="line">    ()</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">rollup</span>(x, y, z) <span class="operator">=</span> <span class="keyword">grouping</span> sets(</span><br><span class="line">    (x, y, z),</span><br><span class="line">    (x, y),</span><br><span class="line">    (x),</span><br><span class="line">    ()</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> <span class="keyword">cube</span>(a,b),<span class="keyword">rollup</span>(x,y,z)</span><br><span class="line"><span class="operator">=</span> <span class="keyword">group</span> <span class="keyword">by</span> groupingsets((a,b),(a),(b),()), groupingsets((x,y,z),(x,y),(x),())</span><br><span class="line"><span class="operator">=</span> <span class="keyword">group</span> <span class="keyword">by</span> groupingsets(</span><br><span class="line">    (a,b,x,y,z),(a,b,x,y),(a,b,x),(a,b),</span><br><span class="line">    (a,x,y,z),(a,x,y),(a,x),(a),</span><br><span class="line">    (b,x,y,z),(b,x,y),(b,x),(b),</span><br><span class="line">    (x,y,z),(x,y),(x),()</span><br><span class="line">)</span><br></pre></td></tr></table></figure>



<h3 id="如何标识合并报表中行的分组归属"><a href="#如何标识合并报表中行的分组归属" class="headerlink" title="如何标识合并报表中行的分组归属"></a>如何标识合并报表中行的分组归属</h3><ul>
<li>grouping_id() 函数可以标示每一行到底和哪个 group by 相关联</li>
<li>这是通过为不同的分组分配不同的整数来做到的（<strong>二进制位表示</strong>）</li>
<li>例子</li>
<li>对于grouping_id(A, B, C, D)<ul>
<li>分组 (A,B,C,D) 的标识为 $8\ast0+4\ast0+2\ast0+1\ast0＝0$</li>
<li>分组 (C) 的标识为 $8\ast1+4\ast1+2\ast0+1\ast1＝13$</li>
</ul>
</li>
</ul>
<h2 id="嵌套子查询"><a href="#嵌套子查询" class="headerlink" title="嵌套子查询"></a>嵌套子查询</h2><ul>
<li>集合成员资格（in子查询）</li>
<li>集合之间的比较（some&#x2F;all子查询）</li>
<li>集合基数的测试（exists子查询）</li>
</ul>
<h3 id="集合成员资格（in子查询）"><a href="#集合成员资格（in子查询）" class="headerlink" title="集合成员资格（in子查询）"></a>集合成员资格（in子查询）</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">表达式 [<span class="keyword">not</span>] <span class="keyword">in</span> (子查询)</span><br></pre></td></tr></table></figure>

<ul>
<li>判断表达式的值是否在子查询的结果中</li>
</ul>
<h4 id="应用"><a href="#应用" class="headerlink" title="应用"></a>应用</h4><ul>
<li>列出张军和王红同学的所有信息</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span></span><br><span class="line"><span class="keyword">from</span> S</span><br><span class="line"><span class="keyword">where</span> sname <span class="keyword">in</span> (<span class="string">&#x27;张军&#x27;</span>, <span class="string">&#x27;王红&#x27;</span>)</span><br></pre></td></tr></table></figure>

<ul>
<li>列出选修了c1号课程的学生的姓名<ul>
<li>效果上是等价的</li>
<li>连接操作一定不会比 in 子查询差<ul>
<li>一般的数据库会试图将 in 子查询转换为连接操作</li>
</ul>
</li>
<li>in 子查询效率不高<ul>
<li>在执行完 in 之后的操作之后，会进行一个排序的工作实现高效的查找</li>
<li>排序是个比较大的开销</li>
</ul>
</li>
</ul>
</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* 连接操作 */</span></span><br><span class="line"><span class="keyword">select</span> sname</span><br><span class="line">fromS, SC</span><br><span class="line"><span class="keyword">where</span> S.sno<span class="operator">=</span> SC.sno <span class="keyword">and</span> cno<span class="operator">=</span>c1</span><br><span class="line"></span><br><span class="line"><span class="comment">/* in 子查询 */</span></span><br><span class="line"><span class="keyword">select</span> sname</span><br><span class="line"><span class="keyword">from</span> S</span><br><span class="line"><span class="keyword">where</span> sno <span class="keyword">in</span> (</span><br><span class="line">    <span class="keyword">select</span> sno</span><br><span class="line">    <span class="keyword">from</span> SC</span><br><span class="line">    <span class="keyword">where</span> cno<span class="operator">=</span>c1</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<ul>
<li>列出选修了 c1 号和 c2 号课程的学生的学号</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> sno</span><br><span class="line"><span class="keyword">from</span> SC</span><br><span class="line"><span class="keyword">where</span> SC.cno<span class="operator">=</span>c1</span><br><span class="line"><span class="keyword">and</span> sno <span class="keyword">in</span> (</span><br><span class="line">    <span class="keyword">select</span> sno</span><br><span class="line">    <span class="keyword">from</span> SC</span><br><span class="line">    <span class="keyword">where</span> cno<span class="operator">=</span>c2</span><br><span class="line">)</span><br></pre></td></tr></table></figure>



<h3 id="集合之间的比较（some-x2F-all子查询）"><a href="#集合之间的比较（some-x2F-all子查询）" class="headerlink" title="集合之间的比较（some&#x2F;all子查询）"></a>集合之间的比较（some&#x2F;all子查询）</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">表达式 比较运算符θ <span class="keyword">some</span>(子查询)</span><br></pre></td></tr></table></figure>

<ul>
<li>表达式的值至少与子查询结果中的一个值相比，满足比较运算符 θ</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">表达式 比较运算符θ <span class="keyword">all</span>(子查询)</span><br></pre></td></tr></table></figure>

<ul>
<li>表达式的值与子查询结果中的所有的值相比，都满足比较运算符θ</li>
</ul>
<h4 id="和-in-子查询的比较"><a href="#和-in-子查询的比较" class="headerlink" title="和 in 子查询的比较"></a>和 in 子查询的比较</h4><ul>
<li>($\ne$all) 等价于 not in</li>
<li>(&#x3D;all) <span style="color:red;font-weight:bold">不等价于</span> in</li>
<li>(&#x3D;some) <span style="color:red;font-weight:bold">不等价于</span> in</li>
<li>($\ne$some) 等价 not in</li>
</ul>
<h4 id="应用-1"><a href="#应用-1" class="headerlink" title="应用"></a>应用</h4><ul>
<li>找出平均成绩最高的学生号</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> sno</span><br><span class="line"><span class="keyword">from</span> SC</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> sno</span><br><span class="line"><span class="keyword">having</span> <span class="built_in">avg</span>(grade)<span class="operator">&gt;=</span><span class="keyword">all</span> (</span><br><span class="line">    <span class="comment">/* 分组属性 sno 可以不出现在 select 后面 */</span></span><br><span class="line">    <span class="keyword">select</span> <span class="built_in">avg</span>(grade)</span><br><span class="line">    <span class="keyword">from</span> SC</span><br><span class="line">    <span class="keyword">group</span> <span class="keyword">by</span> sno</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<ul>
<li>求每个系平均成绩最高的同学</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> dno, X.sno</span><br><span class="line"><span class="keyword">from</span> S X,SC</span><br><span class="line"><span class="keyword">where</span> X.sno<span class="operator">=</span>SC.sno</span><br><span class="line"><span class="comment">/* select 后面的属性必须是分组属性(或者聚集函数) */</span></span><br><span class="line"><span class="comment">/* 单从分组而言, dno 无用 */</span></span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> dno, X.sno</span><br><span class="line"><span class="keyword">having</span> <span class="built_in">avg</span>(grade)<span class="operator">&gt;=</span><span class="keyword">all</span> (</span><br><span class="line">    <span class="keyword">select</span> <span class="built_in">avg</span>(grade)</span><br><span class="line">    <span class="keyword">from</span> S,SC</span><br><span class="line">    <span class="keyword">where</span> S.sno<span class="operator">=</span>SC.sno <span class="keyword">and</span> S.dno<span class="operator">=</span>X.dno</span><br><span class="line">    <span class="keyword">group</span> <span class="keyword">by</span> S.sno</span><br><span class="line">)</span><br></pre></td></tr></table></figure>



<h3 id="集合基数的测试（exists子查询）"><a href="#集合基数的测试（exists子查询）" class="headerlink" title="集合基数的测试（exists子查询）"></a>集合基数的测试（exists子查询）</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[<span class="keyword">not</span>] <span class="keyword">exists</span> (子查询)</span><br></pre></td></tr></table></figure>

<ul>
<li>判断子查询的结果集合中<strong>是否有任何元组存在</strong></li>
</ul>
<h4 id="in-和-exists"><a href="#in-和-exists" class="headerlink" title="in 和 exists"></a>in 和 exists</h4><ul>
<li>in 后的子查询与外层查询无关，每个子查询<strong>执行一次</strong></li>
<li>而 exists 后的子查询与外层查询有关，需要<strong>执行多次</strong>，称之为<strong>相关子查询</strong><ul>
<li>实际查询数据库可能会做优化</li>
<li>如果有索引，并不慢</li>
</ul>
</li>
</ul>
<h4 id="应用-2"><a href="#应用-2" class="headerlink" title="应用"></a>应用</h4><ul>
<li>列出选修了 c1 号课程的学生姓名<ul>
<li>对每位同学<strong>探测</strong>他是否选修了 c1 课程</li>
</ul>
</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> sname</span><br><span class="line"><span class="keyword">from</span> S</span><br><span class="line"><span class="keyword">where</span> <span class="keyword">exists</span> (</span><br><span class="line">    <span class="keyword">select</span> <span class="operator">*</span></span><br><span class="line">    <span class="keyword">from</span> SC</span><br><span class="line">    <span class="comment">/* 不加表名的 sno 是指子查询的 sno */</span></span><br><span class="line">    <span class="keyword">where</span> cno<span class="operator">=</span>c1 <span class="keyword">and</span> sno<span class="operator">=</span>S.sno</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<ul>
<li>列出选修了 c1 号和 c2 号课程的学生的学号<ul>
<li>先找到选修了 c1 的同学，然后再探测他是否也选修了 c2</li>
</ul>
</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> sno</span><br><span class="line"><span class="keyword">from</span> SC SC1</span><br><span class="line"><span class="keyword">where</span> SC1.cno <span class="operator">=</span> c1</span><br><span class="line"><span class="keyword">and</span> <span class="keyword">exists</span> (</span><br><span class="line">    <span class="keyword">select</span> sno</span><br><span class="line">    <span class="keyword">from</span> SC</span><br><span class="line">    <span class="keyword">where</span> cno <span class="operator">=</span> c2 <span class="keyword">and</span> sno <span class="operator">=</span> SC1.sno</span><br><span class="line">)</span><br></pre></td></tr></table></figure>



<h4 id="反半连接：not-in-not-exists"><a href="#反半连接：not-in-not-exists" class="headerlink" title="反半连接：not in, not exists"></a>反半连接：not in, not exists</h4><ul>
<li><strong>集合减法</strong></li>
<li>列出没有选修课程的学生的姓名</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* not in */</span></span><br><span class="line"><span class="keyword">select</span> sname</span><br><span class="line"><span class="keyword">from</span> S</span><br><span class="line"><span class="keyword">where</span> sno <span class="keyword">not</span> <span class="keyword">in</span> (</span><br><span class="line">    <span class="keyword">select</span> sno</span><br><span class="line">    <span class="keyword">from</span> SC</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">/* not exsits */</span></span><br><span class="line"><span class="keyword">select</span> sname</span><br><span class="line"><span class="keyword">from</span> S</span><br><span class="line"><span class="keyword">where</span> <span class="keyword">not</span> <span class="keyword">exists</span> (</span><br><span class="line">    <span class="keyword">select</span> sno</span><br><span class="line">    <span class="keyword">from</span> SC</span><br><span class="line">    <span class="keyword">where</span> sno <span class="operator">=</span> S.sno</span><br><span class="line">)</span><br></pre></td></tr></table></figure>



<h5 id="except"><a href="#except" class="headerlink" title="except"></a>except</h5><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> sname</span><br><span class="line"><span class="keyword">from</span> S</span><br><span class="line"><span class="keyword">where</span> sno <span class="keyword">in</span> (</span><br><span class="line">    ( <span class="keyword">select</span> sno <span class="keyword">from</span> S )</span><br><span class="line">    <span class="keyword">except</span> <span class="comment">/* MySQL 不支持 except */</span></span><br><span class="line">    ( <span class="keyword">select</span> sno <span class="keyword">from</span> SC )</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<h5 id="left-join"><a href="#left-join" class="headerlink" title="left join"></a>left join</h5><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> sname</span><br><span class="line"><span class="keyword">from</span>(S <span class="keyword">left</span> <span class="keyword">outer</span> <span class="keyword">join</span> SC <span class="keyword">on</span> S.sno<span class="operator">=</span>SC.sno)</span><br><span class="line"><span class="keyword">where</span> cno <span class="keyword">is</span> <span class="keyword">null</span></span><br></pre></td></tr></table></figure>



<h3 id="子查询中的属性解析匹配"><a href="#子查询中的属性解析匹配" class="headerlink" title="子查询中的属性解析匹配"></a>子查询中的属性解析匹配</h3><ul>
<li><strong>就近匹配</strong></li>
<li>两个表中表达相同含义的列，具有不同的名称</li>
</ul>
<img src="04-3/image-20210427151820962.png" style="zoom:50%;" />

<ul>
<li>输出没有选 c01 课程的同学<ul>
<li><strong>错误解法</strong></li>
<li>输出 null</li>
</ul>
</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> sno</span><br><span class="line"><span class="keyword">from</span> MyS</span><br><span class="line"><span class="keyword">where</span> sno <span class="keyword">not</span> <span class="keyword">in</span>(</span><br><span class="line">    <span class="keyword">select</span> sno</span><br><span class="line">    <span class="comment">/* SC 中没有找到 sno 属性列, 此时数据库向外层继续查找</span></span><br><span class="line"><span class="comment">     * 发现 MyS 中含有这个属性, 于是把 sno 解析为 MyS.sno</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">from</span> SC</span><br><span class="line">    <span class="keyword">where</span> cno<span class="operator">=</span><span class="string">&#x27;c01&#x27;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 实际执行的代码如下 */</span></span><br><span class="line"><span class="keyword">select</span> sno</span><br><span class="line"><span class="keyword">from</span> MyS</span><br><span class="line"><span class="keyword">where</span> sno <span class="keyword">not</span> <span class="keyword">in</span>(</span><br><span class="line">    <span class="keyword">select</span> MyS.sno</span><br><span class="line">    <span class="keyword">from</span> SC</span><br><span class="line">    <span class="keyword">where</span> cno<span class="operator">=</span><span class="string">&#x27;c01&#x27;</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure>



<h3 id="not-in-x2F-exists-与空值"><a href="#not-in-x2F-exists-与空值" class="headerlink" title="not in&#x2F;exists 与空值"></a>not in&#x2F;exists 与空值</h3><img src="04-3/image-20210427152445309.png" style="zoom:50%;" />

<ul>
<li>如下查询返回<strong>空集</strong>（<strong>非真即假</strong>）<ul>
<li>in 做的是一个相等的判断</li>
<li>t1 中的某个 a 元素和 null 做相等的判断，返回 null</li>
<li>null 做 not 的判断，返回 null</li>
<li>where 只会返回结果为 true 的值</li>
<li>因此最后返回空集</li>
</ul>
</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span></span><br><span class="line"><span class="keyword">from</span> t1</span><br><span class="line"><span class="keyword">where</span> a <span class="keyword">not</span> <span class="keyword">in</span>(<span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> t2)</span><br></pre></td></tr></table></figure>

<ul>
<li>如下查询返回 <strong>1,2</strong>（<strong>非假即真</strong>）<ul>
<li><code>select * from t2 where a=b</code> 返回空</li>
</ul>
</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span></span><br><span class="line"><span class="keyword">from</span> t1</span><br><span class="line"><span class="keyword">where</span> <span class="keyword">not</span> <span class="keyword">exists</span> (<span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> t2 <span class="keyword">where</span> a<span class="operator">=</span>b)</span><br></pre></td></tr></table></figure>

<ul>
<li>用于实际数据库测试</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* 建表 */</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> T_1(A <span class="type">int</span>);</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> T_2(B <span class="type">int</span>);</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> T_3(C <span class="type">int</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> T_1 <span class="keyword">values</span>(<span class="number">1</span>), (<span class="number">2</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> T_2 <span class="keyword">values</span>(<span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 查询 */</span></span><br><span class="line"><span class="comment">/* 空 */</span></span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> T_1 <span class="keyword">where</span> A <span class="keyword">not</span> <span class="keyword">in</span>(<span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> T_2);</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 1,2 */</span></span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> T_1 <span class="keyword">where</span> <span class="keyword">not</span> <span class="keyword">exists</span>(<span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> T_2 <span class="keyword">where</span> T_1.A<span class="operator">=</span>T_2.B);</span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> T_1 <span class="keyword">where</span> A <span class="keyword">not</span> <span class="keyword">in</span>(<span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> T_3);</span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> T_1 <span class="keyword">where</span> <span class="keyword">not</span> <span class="keyword">exists</span>(<span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> T_3 <span class="keyword">where</span> T_1.A<span class="operator">=</span>T_3.C);</span><br></pre></td></tr></table></figure>



<h3 id="除法实现"><a href="#除法实现" class="headerlink" title="除法实现"></a>除法实现</h3><ul>
<li>$\forall \Leftrightarrow$ not exists … not exists<ul>
<li><strong>双重否定的形式</strong></li>
</ul>
</li>
<li>列出选修了全部课程的学生姓名<ul>
<li>学生 s1 选修了所有课程</li>
<li>不存在任何一门课程 c1 所求学生 s1 没有选 c1</li>
</ul>
</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> sname</span><br><span class="line"><span class="keyword">from</span> S S1</span><br><span class="line"><span class="keyword">where</span> <span class="keyword">not</span> <span class="keyword">exists</span> (</span><br><span class="line">    <span class="keyword">select</span> cno</span><br><span class="line">    <span class="keyword">from</span> C C1</span><br><span class="line">    <span class="keyword">where</span> <span class="keyword">not</span> <span class="keyword">exists</span> (</span><br><span class="line">        <span class="keyword">select</span> <span class="operator">*</span></span><br><span class="line">        <span class="keyword">from</span> SC</span><br><span class="line">        <span class="keyword">where</span> cno<span class="operator">=</span>C1.cno</span><br><span class="line">        <span class="keyword">and</span> sno<span class="operator">=</span>S1.sno</span><br><span class="line">    )</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<ul>
<li>列出至少选修了 s1 号学生选修的所有课程的学生名<ul>
<li>s2 选修了 s1 选修的所有课程</li>
<li>不存在任何一门课程，s1 选修了但是 s2 没有选修</li>
</ul>
</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> sname</span><br><span class="line"><span class="keyword">from</span> S S2</span><br><span class="line"><span class="keyword">where</span> <span class="keyword">not</span> <span class="keyword">exists</span> (</span><br><span class="line">    <span class="keyword">select</span> cno</span><br><span class="line">    <span class="keyword">from</span> C C1</span><br><span class="line">    <span class="keyword">where</span> <span class="keyword">exists</span> (</span><br><span class="line">        <span class="keyword">select</span> <span class="operator">*</span></span><br><span class="line">        <span class="keyword">from</span> SC</span><br><span class="line">        <span class="keyword">where</span> cno<span class="operator">=</span>C1.cno <span class="keyword">and</span> sno<span class="operator">=</span>s1</span><br><span class="line">    )</span><br><span class="line">    <span class="keyword">and</span></span><br><span class="line">    <span class="keyword">not</span> <span class="keyword">exists</span>(</span><br><span class="line">        <span class="keyword">select</span> <span class="operator">*</span></span><br><span class="line">        <span class="keyword">from</span> SC</span><br><span class="line">        <span class="keyword">where</span> cno<span class="operator">=</span> C1.cno <span class="keyword">and</span> sno<span class="operator">=</span>S2.sno</span><br><span class="line">    )</span><br><span class="line">)</span><br></pre></td></tr></table></figure>


      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/04/24/DB/CLJ/04-3/" data-id="cl9lj74as00ev64tz0ng2bamj" data-title="数据库概论.陈立军.04.SQL 数据查询(2)" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/DB/" rel="tag">DB</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-DB/CLJ/04-2" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/04/20/DB/CLJ/04-2/" class="article-date">
  <time class="dt-published" datetime="2021-04-20T09:55:28.000Z" itemprop="datePublished">2021-04-20</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/DB-CLJ/">DB.CLJ</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2021/04/20/DB/CLJ/04-2/">数据库概论.陈立军.04.SQL 数据查询(1)</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="SQL-数据查询"><a href="#SQL-数据查询" class="headerlink" title="SQL 数据查询"></a>SQL 数据查询</h1><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Select</span> ...</span><br><span class="line"><span class="keyword">From</span> ...</span><br><span class="line"><span class="keyword">Where</span> ...</span><br><span class="line"><span class="keyword">Group</span> <span class="keyword">by</span> ...</span><br><span class="line"><span class="keyword">Having</span> ...</span><br><span class="line"><span class="keyword">Union</span> ...</span><br><span class="line"><span class="keyword">Order</span> <span class="keyword">by</span> ...</span><br><span class="line">Limit ...</span><br></pre></td></tr></table></figure>



<h2 id="在线资源"><a href="#在线资源" class="headerlink" title="在线资源"></a>在线资源</h2><ul>
<li><a target="_blank" rel="noopener" href="http://sqlfiddle.com/">http://sqlfiddle.com</a></li>
</ul>
<h2 id="查询基本结构"><a href="#查询基本结构" class="headerlink" title="查询基本结构"></a>查询基本结构</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> A1, A2, ..., An</span><br><span class="line"><span class="keyword">from</span> r1, r2, ..., rm</span><br><span class="line"><span class="keyword">where</span> P</span><br></pre></td></tr></table></figure>

<ul>
<li>上面 3 行对应着投影、<strong>笛卡尔积</strong>、选择</li>
</ul>
<p>$$<br>\prod_{A_1,A_2,\times ,A_n}(\sigma_{P}(r_1,\times r_2\times \cdots\times r_m))<br>$$</p>
<ul>
<li>SQL 返回结果是<span style="color:red;font-weight:bold">多集</span></li>
<li>快速生成测试数据</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> R1 <span class="keyword">values</span>(</span><br><span class="line">    (<span class="number">0</span>), (<span class="number">1</span>), (<span class="number">2</span>), (<span class="number">3</span>), (<span class="number">4</span>), (<span class="number">5</span>), (<span class="number">6</span>), (<span class="number">7</span>), (<span class="number">8</span>), (<span class="number">9</span>)</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 生成 10000 行数据 */</span></span><br><span class="line"><span class="keyword">select</span> R1.<span class="operator">*</span></span><br><span class="line"><span class="keyword">from</span> R R1, R R2, R R3, R R4, R R5</span><br></pre></td></tr></table></figure>

<ul>
<li>但是真正要用于生成数据的话应该使用数据库提供的工具，指定概率分布生成随机数据</li>
<li>理解笛卡尔积<ul>
<li>如下 sql 语句选择出来的结果是所有学生</li>
</ul>
</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* 所有的学生 */</span></span><br><span class="line"><span class="keyword">select</span> sname, dname</span><br><span class="line"><span class="keyword">from</span> S, DEPT</span><br><span class="line"><span class="keyword">where</span> dname <span class="operator">=</span> <span class="string">&#x27;计算机系&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* 计算机系的学生 */</span></span><br><span class="line"><span class="keyword">select</span> sname, dname</span><br><span class="line"><span class="keyword">from</span> S, DEPT</span><br><span class="line"><span class="keyword">where</span> dname <span class="operator">=</span> <span class="string">&#x27;计算机系&#x27;</span> <span class="keyword">and</span> S.dno <span class="operator">=</span> DEPT.dno</span><br></pre></td></tr></table></figure>



<h3 id="select子句"><a href="#select子句" class="headerlink" title="select子句"></a>select子句</h3><ul>
<li>select xx</li>
<li>xx 可以为<ul>
<li>列名</li>
<li><code>*</code>：表示所有的属性</li>
<li>算术表达式</li>
<li>聚集函数</li>
</ul>
</li>
<li>给出学生的所有信息</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> S</span><br></pre></td></tr></table></figure>

<ul>
<li><code>*</code> 对性能的影响<ul>
<li>丧失使用组合索引技术的可能</li>
<li>中间表的规模很大</li>
</ul>
</li>
<li>算术表达式<ul>
<li>给出所有学生的姓名及出生日期</li>
<li>存储年龄并不是一个好的设计，好的设计应该是存储出生日期<ul>
<li>把年龄作为出身日期的派生属性</li>
</ul>
</li>
</ul>
</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> sname, <span class="number">2020</span><span class="operator">-</span>age</span><br><span class="line"><span class="keyword">from</span> S</span><br></pre></td></tr></table></figure>

<ul>
<li>将多个列组合成一个目标列<ul>
<li>可以用作 web 前端（智能客服）</li>
</ul>
</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> pname <span class="operator">+</span> <span class="string">&#x27;老师的工资是&#x27;</span> <span class="operator">+</span> salary <span class="operator">+</span> <span class="string">&#x27;,年龄是&#x27;</span> <span class="operator">+</span> age <span class="operator">+</span> <span class="string">&#x27;,职称是&#x27;</span> <span class="operator">+</span> title</span><br><span class="line"><span class="keyword">from</span> professor</span><br></pre></td></tr></table></figure>




<h3 id="from子句"><a href="#from子句" class="headerlink" title="from子句"></a>from子句</h3><ul>
<li>from 子句列出查询的对象表<ul>
<li>对象表</li>
<li>做<strong>笛卡尔积</strong></li>
</ul>
</li>
<li>当目标列取自多个表时，需要<strong>显式</strong>指明来自哪个关系</li>
<li>写出与 $R(A,B)\bowtie S(B,C)$ 等价的 SQL</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* 错误, 无法分辨 B 来自于哪一个表 */</span></span><br><span class="line"><span class="keyword">select</span> A, B, C</span><br><span class="line"><span class="keyword">from</span> R, S</span><br><span class="line"><span class="keyword">where</span> R.B <span class="operator">=</span> S.B</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 不正确, 输出结果为 R.A, R.B, S.A, S.B */</span></span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span></span><br><span class="line"><span class="keyword">from</span> R, S</span><br><span class="line"><span class="keyword">where</span> R.B <span class="operator">=</span> S.B</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 正确 */</span></span><br><span class="line"><span class="keyword">select</span> A, R.B, C</span><br><span class="line"><span class="keyword">from</span> R, S</span><br><span class="line"><span class="keyword">where</span> R.B <span class="operator">=</span> S.B</span><br></pre></td></tr></table></figure>



<h3 id="where子句"><a href="#where子句" class="headerlink" title="where子句"></a>where子句</h3><ul>
<li>比较运算符</li>
</ul>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;、&lt;=、&gt;、&gt;=、=、&lt;&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li>逻辑运算符</li>
</ul>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">and、or、not</span><br></pre></td></tr></table></figure>

<ul>
<li>虽然不同的表达式可以表示相同的结果，但是使用不同的表达方式效率上可能不一样<ul>
<li>某些写法，系统可能会使用索引，但是针对其他写法，系统可能不使用索引</li>
</ul>
</li>
</ul>
<h4 id="between-子句"><a href="#between-子句" class="headerlink" title="between 子句"></a>between 子句</h4><ul>
<li>判断表达式的值是否在某范围内</li>
<li>列出工资在500~800之间的老师姓名</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> pname</span><br><span class="line"><span class="keyword">from</span> PROF</span><br><span class="line"><span class="keyword">where</span> salary <span class="keyword">between</span> <span class="number">500</span> <span class="keyword">and</span> <span class="number">800</span></span><br></pre></td></tr></table></figure>

<ul>
<li>between 前后两个词的大小关系<ul>
<li>SQL Server：都可以</li>
<li>其他：一般得满足前面小于后面</li>
<li>得看数据库的具体实现</li>
</ul>
</li>
<li><strong>优化小窍门</strong>：使用 between 合并两个比较谓词<ul>
<li>使用 between 来写，可能让系统有使用索引的机会</li>
</ul>
</li>
</ul>
<h3 id="重复行的处理"><a href="#重复行的处理" class="headerlink" title="重复行的处理"></a>重复行的处理</h3><ul>
<li>SQL 缺省为保留重复行（多集），也可用关键字 all 显式指明<ul>
<li>若要去掉重复行，可用关键字 distinct 指明</li>
</ul>
</li>
<li>找出所有选修课程的学生</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="keyword">distinct</span> sno</span><br><span class="line"><span class="keyword">from</span> SC</span><br></pre></td></tr></table></figure>

<ul>
<li><strong>优化小窍门</strong>：只在<strong>必要</strong>的时候去重<ul>
<li>开销比较大<ul>
<li>怎么去重：排序，哈希</li>
</ul>
</li>
<li>必要：业务要求</li>
<li>如果能够明确知道不会有重复的结果，则不需要加 distinct</li>
</ul>
</li>
</ul>
<h4 id="优化问题"><a href="#优化问题" class="headerlink" title="优化问题"></a>优化问题</h4><ul>
<li>两个表 R(A,B)、S(A,C)，其中A是这两个表的主码,哪些查询中的distinct可以去掉？</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* 可以去掉 */</span></span><br><span class="line"><span class="keyword">select</span> <span class="keyword">distinct</span> R.A, S.A</span><br><span class="line"><span class="keyword">from</span> R,S</span><br><span class="line"><span class="keyword">where</span> R.B <span class="operator">=</span> S.C</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 不能去掉 */</span></span><br><span class="line"><span class="keyword">select</span> <span class="keyword">distinct</span> R.A</span><br><span class="line"><span class="keyword">from</span> R,S</span><br><span class="line"><span class="keyword">where</span> R.B <span class="operator">=</span> S.C</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 可以去掉 */</span></span><br><span class="line"><span class="comment">/* 一行 R 最多和一行 S 对应, 否则不满足 A 为 S 的主码 */</span></span><br><span class="line"><span class="keyword">select</span> <span class="keyword">distinct</span> R.A</span><br><span class="line"><span class="keyword">from</span> R,S</span><br><span class="line"><span class="keyword">where</span> R.B <span class="operator">=</span> S.A</span><br></pre></td></tr></table></figure>



<h3 id="输出显示顺序"><a href="#输出显示顺序" class="headerlink" title="输出显示顺序"></a>输出显示顺序</h3><ul>
<li>order by</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> 列名 [<span class="keyword">asc</span> <span class="operator">|</span> <span class="keyword">desc</span>]</span><br></pre></td></tr></table></figure>

<ul>
<li>按年龄升序列出学生信息，相同年龄学生按姓名降序排列</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span></span><br><span class="line"><span class="keyword">from</span> S</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> age <span class="keyword">asc</span>, sname <span class="keyword">desc</span></span><br></pre></td></tr></table></figure>

<ul>
<li>order by 后面出现<strong>数字</strong>，表示 select 后的第几个属性</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* 对教工按缴纳所得税的多少排序 */</span></span><br><span class="line"><span class="keyword">select</span> pname, salary<span class="operator">*</span><span class="number">0.2</span></span><br><span class="line"><span class="keyword">from</span> PROF</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> <span class="number">2</span></span><br></pre></td></tr></table></figure>

<ul>
<li>允许排序的属性不是目标列</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* 按年龄顺序输出学生姓名 */</span></span><br><span class="line"><span class="keyword">select</span> sname</span><br><span class="line"><span class="keyword">from</span> S</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> age</span><br></pre></td></tr></table></figure>



<h3 id="table"><a href="#table" class="headerlink" title="table"></a>table</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> t1 (r1 <span class="type">int</span>, r2 <span class="type">int</span>)</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> t1</span><br><span class="line"><span class="keyword">with</span> <span class="keyword">recursive</span> aa(a,b)</span><br><span class="line"><span class="keyword">as</span> (</span><br><span class="line">    <span class="keyword">select</span> <span class="number">1</span>, <span class="number">1</span> <span class="comment">/* 先插入 1,1 */</span></span><br><span class="line">    <span class="keyword">union</span> <span class="keyword">all</span></span><br><span class="line">    <span class="keyword">select</span> a<span class="operator">+</span><span class="number">1</span>, cee(rand()<span class="operator">*</span><span class="number">20</span>)</span><br><span class="line">    <span class="keyword">from</span> aa</span><br><span class="line">    <span class="keyword">where</span> a <span class="operator">&lt;</span> <span class="number">10</span></span><br><span class="line">)</span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> aa</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> t2 <span class="keyword">like</span> t2 <span class="comment">/* 表形式统一 */</span></span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> t2 <span class="keyword">table</span> t1 <span class="comment">/* 插入数据 */</span></span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> t2 <span class="keyword">where</span> (r1,r2) <span class="keyword">in</span> (<span class="keyword">table</span> t1) <span class="comment">/* t2 中在 t1 内的行 */</span></span><br></pre></td></tr></table></figure>



<h3 id="values-x2F-row"><a href="#values-x2F-row" class="headerlink" title="values&#x2F;row"></a>values&#x2F;row</h3><ul>
<li>values 表值构造器</li>
<li>row 行值构造器</li>
<li>用于简单的生成行或者表</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* ex 1 */</span></span><br><span class="line"><span class="keyword">values</span> <span class="type">row</span>(<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>), <span class="type">row</span>(<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">/* ex 2 */</span></span><br><span class="line"><span class="keyword">values</span> <span class="type">row</span>(<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>), <span class="type">row</span>(<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>)</span><br><span class="line"><span class="keyword">union</span> <span class="keyword">all</span></span><br><span class="line"><span class="keyword">values</span> <span class="type">row</span>(<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>), <span class="type">row</span>(<span class="number">4</span>,<span class="number">5</span>,<span class="number">6</span>)</span><br></pre></td></tr></table></figure>



<h2 id="更名运算"><a href="#更名运算" class="headerlink" title="更名运算"></a>更名运算</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">old_name <span class="keyword">as</span> new_name</span><br></pre></td></tr></table></figure>

<ul>
<li>为<strong>关系</strong>和<strong>属性</strong>重新命名</li>
<li>可出现在 select 和 from 子句中</li>
<li><strong>as 可选</strong></li>
</ul>
<h3 id="属性更名（列）"><a href="#属性更名（列）" class="headerlink" title="属性更名（列）"></a>属性更名（列）</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* 输出的时候吧英文转化为中文 */</span></span><br><span class="line"><span class="keyword">select</span> sname <span class="string">&#x27;姓名&#x27;</span> ,sex <span class="string">&#x27;性别&#x27;</span>, <span class="number">2019</span><span class="operator">-</span>age <span class="string">&#x27;出生日期&#x27;</span></span><br><span class="line"><span class="keyword">from</span> S</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> 出生日期 <span class="comment">/* 或者 order by 3 */</span></span><br></pre></td></tr></table></figure>



<h3 id="关系更名（表）"><a href="#关系更名（表）" class="headerlink" title="关系更名（表）"></a>关系更名（表）</h3><ul>
<li>例如：表的自连接</li>
<li>找出比 s1 学生选修 c1 课程成绩高的学生号</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> S2.sno</span><br><span class="line"><span class="keyword">from</span> SC <span class="keyword">as</span> S1, SC <span class="keyword">as</span> S2</span><br><span class="line"><span class="keyword">where</span> S1.sno <span class="operator">=</span> <span class="string">&#x27;s1&#x27;</span></span><br><span class="line"><span class="keyword">and</span> S1.cno <span class="operator">=</span> <span class="string">&#x27;c1&#x27;</span></span><br><span class="line"><span class="keyword">and</span> S2.cno <span class="operator">=</span> <span class="string">&#x27;c1&#x27;</span></span><br><span class="line"><span class="keyword">and</span> S1.grade <span class="operator">&lt;</span> S2.grade</span><br></pre></td></tr></table></figure>



<h2 id="连接操作"><a href="#连接操作" class="headerlink" title="连接操作"></a>连接操作</h2><ul>
<li><strong>连接成分</strong><ul>
<li>包括<strong>两个输入关系</strong>、<strong>连接条件</strong>、<strong>连接类型</strong></li>
</ul>
</li>
<li><strong>连接条件</strong><ul>
<li>决定两个关系中哪些元组相互匹配，以及连接结果中出现哪些属性</li>
</ul>
</li>
<li><strong>连接类型</strong><ul>
<li>决定如何处理与连接条件<strong>不匹配</strong>的元组</li>
</ul>
</li>
<li>SQL<ul>
<li>连接类型<ul>
<li>inner join</li>
<li>left outer join</li>
<li>right outer join</li>
<li>full outer join</li>
</ul>
</li>
<li>连接条件<ul>
<li>on &lt;谓词&gt;</li>
<li>(R cross join S) as T<ul>
<li>两个关系的笛卡儿积</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>列出所有老师的教工号、姓名、工资、所教课程号<ul>
<li>需要保留没有授课的老师</li>
</ul>
</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> pno, pname, salary, cno</span><br><span class="line"><span class="keyword">from</span> prof <span class="keyword">left</span> <span class="keyword">join</span> PC <span class="keyword">on</span> PROF.pno<span class="operator">=</span>PC.pno</span><br></pre></td></tr></table></figure>

<ul>
<li>如果不支持外连接，实现方式</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* 有教授课程的老师 + 没有教授课程的老师 */</span></span><br><span class="line"><span class="keyword">select</span> pno, pname, salary, cno</span><br><span class="line"><span class="keyword">from</span> PROF, PC</span><br><span class="line"><span class="keyword">where</span> PROF.pno<span class="operator">=</span>PC.pno</span><br><span class="line"><span class="keyword">union</span></span><br><span class="line"><span class="keyword">select</span> pno, pname, salary, <span class="keyword">null</span></span><br><span class="line"><span class="keyword">from</span> PROF</span><br><span class="line"><span class="keyword">where</span> pno <span class="keyword">not</span> <span class="keyword">in</span> (<span class="keyword">select</span> pno <span class="keyword">from</span> PC)</span><br></pre></td></tr></table></figure>

<ul>
<li>注意 SQL 不删除重复列（因为 on 的条件可能不是等于）</li>
</ul>
<h3 id="inner-join"><a href="#inner-join" class="headerlink" title="inner join"></a>inner join</h3><img src="04-2/image-20210422211110317.png" style="zoom:50%;" />

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span></span><br><span class="line"><span class="keyword">from</span> tbA <span class="keyword">inner</span> <span class="keyword">join</span> tbC <span class="keyword">on</span> tbA.b<span class="operator">=</span>tbC.b</span><br></pre></td></tr></table></figure>



<h3 id="left-join"><a href="#left-join" class="headerlink" title="left join"></a>left join</h3><img src="04-2/image-20210422211343137.png" style="zoom:50%;" />

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span></span><br><span class="line"><span class="keyword">from</span> tbA <span class="keyword">left</span> <span class="keyword">join</span> tbC <span class="keyword">on</span> tbA.b<span class="operator">=</span>tbC.b</span><br></pre></td></tr></table></figure>





<h3 id="right-join"><a href="#right-join" class="headerlink" title="right join"></a>right join</h3><img src="04-2/image-20210422211402914.png" style="zoom:50%;" />

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span></span><br><span class="line"><span class="keyword">from</span> tbA <span class="keyword">right</span> <span class="keyword">join</span> tbC <span class="keyword">on</span> tbA.b<span class="operator">=</span>tbC.b</span><br></pre></td></tr></table></figure>



<h3 id="left-join-excluding-inner-join"><a href="#left-join-excluding-inner-join" class="headerlink" title="left join excluding inner join"></a>left join excluding inner join</h3><img src="04-2/image-20210422211610961.png" style="zoom:50%;" />

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> tbA.<span class="operator">*</span></span><br><span class="line"><span class="keyword">from</span> tbA <span class="keyword">left</span> tbC <span class="keyword">on</span> tbA.b<span class="operator">=</span>tbC.b</span><br><span class="line"><span class="keyword">where</span> tbC.b <span class="keyword">is</span> <span class="keyword">null</span></span><br></pre></td></tr></table></figure>



<h3 id="full-join-excluding-inner-join"><a href="#full-join-excluding-inner-join" class="headerlink" title="full join excluding inner join"></a>full join excluding inner join</h3><img src="04-2/image-20210422211721180.png" style="zoom:50%;" />

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span></span><br><span class="line"><span class="keyword">from</span> tbA <span class="keyword">left</span> tbC <span class="keyword">on</span> tbA.b<span class="operator">=</span>tbC.b</span><br><span class="line"><span class="keyword">where</span> tbC.b <span class="keyword">is</span> <span class="keyword">null</span></span><br><span class="line"><span class="keyword">union</span></span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span></span><br><span class="line"><span class="keyword">from</span> tbA <span class="keyword">right</span> tbC <span class="keyword">on</span> tbA.b<span class="operator">=</span>tbC.b</span><br><span class="line"><span class="keyword">where</span> tbA.b <span class="keyword">is</span> <span class="keyword">null</span></span><br></pre></td></tr></table></figure>



<h3 id="cross-join"><a href="#cross-join" class="headerlink" title="cross join"></a>cross join</h3><ul>
<li>做笛卡尔积</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span></span><br><span class="line"><span class="keyword">from</span> tbA <span class="keyword">cross</span> <span class="keyword">join</span> tbC</span><br><span class="line"><span class="comment">/* 等价于 */</span></span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span></span><br><span class="line"><span class="keyword">from</span> tbA, tbC</span><br></pre></td></tr></table></figure>



<h3 id="natural-join"><a href="#natural-join" class="headerlink" title="natural join"></a>natural join</h3><ul>
<li>去除重复（公共）列</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* ex 1*/</span></span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span></span><br><span class="line"><span class="keyword">from</span> tbA <span class="keyword">natural</span> <span class="keyword">join</span> tbC</span><br><span class="line"></span><br><span class="line"><span class="comment">/* ex2 */</span></span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span></span><br><span class="line"><span class="keyword">from</span> tbA <span class="keyword">join</span> tbC <span class="keyword">using</span>(b)</span><br></pre></td></tr></table></figure>



<h3 id="straight-join"><a href="#straight-join" class="headerlink" title="straight_join"></a>straight_join</h3><ul>
<li>嵌套循环</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span></span><br><span class="line"><span class="keyword">from</span> R straight_join S</span><br></pre></td></tr></table></figure>

<img src="04-2/image-20210422212426321.png" style="zoom:80%;" />

<h3 id="多表连接"><a href="#多表连接" class="headerlink" title="多表连接"></a>多表连接</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span></span><br><span class="line"><span class="keyword">from</span> tbA A <span class="keyword">inner</span> <span class="keyword">join</span> tbA B <span class="keyword">on</span> A.b<span class="operator">=</span>B.b</span><br><span class="line">           <span class="keyword">inner</span> <span class="keyword">join</span> tbA C <span class="keyword">on</span> A.b<span class="operator">=</span>C.b</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span></span><br><span class="line"><span class="keyword">from</span> tbA A</span><br><span class="line"><span class="keyword">join</span>(tbA B, tbA C)</span><br><span class="line"><span class="keyword">on</span>(A.b<span class="operator">=</span>B.b <span class="keyword">and</span> A.b<span class="operator">=</span>C.b)</span><br></pre></td></tr></table></figure>



<h2 id="集合操作"><a href="#集合操作" class="headerlink" title="集合操作"></a>集合操作</h2><ul>
<li>默认去重，显式声明 all 才表示不去重</li>
<li>集合并：union(all)</li>
<li>集合交：intersect(all)</li>
<li>集合差：except(all)</li>
<li>优先级<ul>
<li>intersect 的优先级高于其他集合操作的优先级</li>
</ul>
</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">S1 <span class="keyword">intersect</span> <span class="keyword">all</span> S2</span><br><span class="line">S1 <span class="keyword">intersect</span> S2</span><br></pre></td></tr></table></figure>

<ul>
<li>求工资大于1000或者年龄大于60的教工</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">(<span class="keyword">select</span> pno</span><br><span class="line"><span class="keyword">from</span> PROF</span><br><span class="line"><span class="keyword">where</span> sal<span class="operator">&gt;</span> <span class="number">1000</span>)</span><br><span class="line"><span class="keyword">union</span> <span class="keyword">all</span></span><br><span class="line">(<span class="keyword">select</span> pno</span><br><span class="line"><span class="keyword">from</span> PROF</span><br><span class="line"><span class="keyword">where</span> age <span class="operator">&gt;</span> <span class="number">60</span>)</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">(<span class="keyword">select</span> pno</span><br><span class="line"><span class="keyword">from</span> PROF</span><br><span class="line"><span class="keyword">where</span> sal<span class="operator">&gt;</span> <span class="number">1000</span></span><br><span class="line"><span class="keyword">or</span> age <span class="operator">&gt;</span> <span class="number">60</span>)</span><br></pre></td></tr></table></figure>

<ul>
<li>union all 不去重</li>
<li>效率<ul>
<li>第一种写法可能会让数据库使用索引</li>
<li>第二种写法，很多数据库看到 or 直接就不使用索引了</li>
</ul>
</li>
</ul>
<h3 id="用集合运算实现除法"><a href="#用集合运算实现除法" class="headerlink" title="用集合运算实现除法"></a>用集合运算实现除法</h3><ul>
<li>选修了所有课程的同学</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> sno</span><br><span class="line"><span class="keyword">from</span> S S1</span><br><span class="line"><span class="keyword">where</span></span><br><span class="line">(</span><br><span class="line">    <span class="comment">/* 所有的课程 */</span></span><br><span class="line">    <span class="keyword">select</span> cno</span><br><span class="line">    <span class="keyword">from</span> C</span><br><span class="line">    <span class="keyword">except</span></span><br><span class="line">    <span class="comment">/* S1 同学选修的所有课程 */</span></span><br><span class="line">    <span class="keyword">select</span> cno</span><br><span class="line">    <span class="keyword">from</span> SC</span><br><span class="line">    <span class="keyword">where</span> S1.sno<span class="operator">=</span>SC.sno</span><br><span class="line">)</span><br><span class="line"><span class="keyword">is</span> <span class="keyword">null</span></span><br></pre></td></tr></table></figure>



<h2 id="空值"><a href="#空值" class="headerlink" title="空值"></a>空值</h2><ul>
<li>很麻烦但是是必要的</li>
</ul>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">No cat has 12 tails.</span><br><span class="line">A cat has one more tail than no cat.</span><br><span class="line">Therefore, a cat has 13 tails.</span><br></pre></td></tr></table></figure>

<ul>
<li>谬论，no cat 不是一个实体</li>
<li>C.J Date<ul>
<li>null 是标识，不是值</li>
<li>包含 null 违反了关系定义</li>
</ul>
</li>
<li>Codd 提出了两类 null<ul>
<li>A-Mark null：未知的</li>
<li>T-Mark null：不适用的</li>
<li>但是数据库没有办法区分这两类 null</li>
</ul>
</li>
</ul>
<h3 id="空值的逻辑计算"><a href="#空值的逻辑计算" class="headerlink" title="空值的逻辑计算"></a>空值的逻辑计算</h3><table>
<thead>
<tr>
<th align="center">and</th>
<th align="center">true</th>
<th align="center">false</th>
<th align="center">unknown</th>
</tr>
</thead>
<tbody><tr>
<td align="center">true</td>
<td align="center">true</td>
<td align="center">false</td>
<td align="center">unknown</td>
</tr>
<tr>
<td align="center">false</td>
<td align="center">false</td>
<td align="center">false</td>
<td align="center">false</td>
</tr>
<tr>
<td align="center">unknown</td>
<td align="center">unknown</td>
<td align="center">false</td>
<td align="center">unknown</td>
</tr>
</tbody></table>
<table>
<thead>
<tr>
<th align="center">or</th>
<th align="center">true</th>
<th align="center">false</th>
<th align="center">unknown</th>
</tr>
</thead>
<tbody><tr>
<td align="center">true</td>
<td align="center">true</td>
<td align="center">true</td>
<td align="center">true</td>
</tr>
<tr>
<td align="center">false</td>
<td align="center">true</td>
<td align="center">false</td>
<td align="center">unknown</td>
</tr>
<tr>
<td align="center">unknown</td>
<td align="center">true</td>
<td align="center">unknown</td>
<td align="center">unknown</td>
</tr>
</tbody></table>
<ul>
<li>强度：true &gt; unknown &gt; false</li>
</ul>
<h3 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h3><img src="04-2/image-20210423150349419.png" style="zoom:50%;" />

<ul>
<li>列出满足如下条件的(SNO, PNO)对：<ul>
<li>或者供应商和零件的所在城市不同，或者零件所在城市不是 Paris</li>
</ul>
</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> S.SNO, P.PNO</span><br><span class="line"><span class="keyword">from</span> S, P</span><br><span class="line"><span class="keyword">where</span> S.CITY <span class="operator">&lt;&gt;</span> P.CITY</span><br><span class="line"><span class="keyword">or</span> P.CITY <span class="operator">&lt;&gt;</span> <span class="string">&#x27;Paris&#x27;</span></span><br></pre></td></tr></table></figure>

<ul>
<li><strong>返回结果为 <code>S1, P2</code></strong></li>
<li>不会返回结果 <code>S1,P1</code><ul>
<li>(S1.CITY &#x3D; P1.CITY) 返回 null(unknown)</li>
<li>(P1.CITY &#x3D; ‘Paris’) 返回 null(unknown)</li>
<li><strong>而数据库只返回结果为 true 的行</strong></li>
</ul>
</li>
<li><span style="color:red;font-weight:bold">问题</span>：P1.CITY虽目前未知，但肯定是或不是Paris，总会满足查询条件之一<ul>
<li>应该输出 <code>S1,P1</code></li>
</ul>
</li>
</ul>
<h3 id="空值测试"><a href="#空值测试" class="headerlink" title="空值测试"></a>空值测试</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">is</span> [<span class="keyword">not</span>] <span class="keyword">null</span></span><br></pre></td></tr></table></figure>



<h3 id="空值的查询"><a href="#空值的查询" class="headerlink" title="空值的查询"></a>空值的查询</h3><ul>
<li>除 is [not] null 之外，空值不满足任何查找条件</li>
<li>如果 null 参与算术运算，则该算术表达式的值为 null</li>
<li>如果 null 参与比较运算，则结果可视为 unknown</li>
</ul>
<h3 id="例子"><a href="#例子" class="headerlink" title="例子"></a>例子</h3><ul>
<li>表中存在两行(1, 2, null), (1, 2, null)<ul>
<li>请问 select distinct * 的输出结果是？</li>
<li><span style="color:red;font-weight:bold">输出一行</span></li>
<li>可能底层的判断并不是简单的 &#x3D;</li>
</ul>
</li>
<li>找出成绩值为空的学生号</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> sno</span><br><span class="line"><span class="keyword">from</span> SC</span><br><span class="line"><span class="keyword">where</span> grade <span class="keyword">is</span> <span class="keyword">null</span></span><br><span class="line"><span class="comment">/* 不可写为 where grade = null */</span></span><br></pre></td></tr></table></figure>

<ul>
<li>空串、null、’null’</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> NULL_TB(col <span class="type">char</span>(<span class="number">10</span>));</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> NULL_TB <span class="keyword">values</span>(<span class="keyword">null</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> NULL_TB <span class="keyword">values</span>(<span class="string">&#x27;&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> NULL_TB <span class="keyword">values</span>(<span class="string">&#x27;null&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 以下 3 个查询都只会返回一个记录 */</span></span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> NULL_TB <span class="keyword">where</span> col<span class="operator">=</span><span class="string">&#x27;&#x27;</span>;</span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> NULL_TB <span class="keyword">where</span> col<span class="operator">=</span><span class="string">&#x27;null&#x27;</span>;</span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> NULL_TB <span class="keyword">where</span> col <span class="keyword">is</span> <span class="keyword">null</span>;</span><br></pre></td></tr></table></figure>



<h3 id="空值处理函数"><a href="#空值处理函数" class="headerlink" title="空值处理函数"></a>空值处理函数</h3><h4 id="isnull"><a href="#isnull" class="headerlink" title="isnull"></a>isnull</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">isnull(check_expression, replacement_value)</span><br></pre></td></tr></table></figure>

<ul>
<li>如果 check_expression 值为空，则返回 replacement_value，否则返回check_expression</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> sno, cno, isnull( grade, <span class="number">0</span>)</span><br><span class="line"><span class="keyword">from</span> SC</span><br></pre></td></tr></table></figure>



<h4 id="coalesce"><a href="#coalesce" class="headerlink" title="coalesce"></a>coalesce</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">coalesce</span>(expression1, expression2, ...)</span><br></pre></td></tr></table></figure>

<ul>
<li>返回第一个不为 null 的expression</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> sno,cno,<span class="built_in">coalesce</span>(grade, <span class="number">0</span>)</span><br><span class="line"><span class="keyword">from</span> SC</span><br><span class="line"><span class="keyword">where</span> <span class="built_in">coalesce</span>(grade,<span class="number">0</span>) <span class="operator">&lt;</span> <span class="number">60</span></span><br></pre></td></tr></table></figure>



<h4 id="nullif"><a href="#nullif" class="headerlink" title="nullif"></a>nullif</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">nullif</span>(expression1, expression2)</span><br></pre></td></tr></table></figure>

<ul>
<li>如果两个表达式相等则返回空值，否则返回第一个表达式</li>
</ul>
<h3 id="空值的排序处理"><a href="#空值的排序处理" class="headerlink" title="空值的排序处理"></a>空值的排序处理</h3><ul>
<li>缺省情况下空值是最后输出的</li>
<li>当指定 order by 时，<strong>降序</strong>情况下<strong>首先</strong>输出空值，升序情况下最后输出空值<ul>
<li>把空值看成是最大的</li>
</ul>
</li>
<li>首先输出 null，由大到小输出工资</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> pname,salary</span><br><span class="line"><span class="keyword">from</span> prof</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> <span class="number">2</span> <span class="keyword">desc</span></span><br></pre></td></tr></table></figure>

<ul>
<li>首先输出 null，再由小到大输出工资</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> pname,salary</span><br><span class="line"><span class="keyword">from</span> (</span><br><span class="line">    <span class="keyword">select</span> pname,salary,</span><br><span class="line">    <span class="keyword">case</span> <span class="keyword">when</span> salary <span class="keyword">is</span> <span class="keyword">null</span> <span class="keyword">then</span> <span class="number">0</span> <span class="keyword">else</span> <span class="number">1</span></span><br><span class="line">    <span class="keyword">as</span> is_null</span><br><span class="line">    <span class="keyword">from</span> prof</span><br><span class="line">) temp_faculty</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> is_null, salary</span><br></pre></td></tr></table></figure>



<h2 id="聚集函数"><a href="#聚集函数" class="headerlink" title="聚集函数"></a>聚集函数</h2><ul>
<li>将一列中所有的值聚集为单个值<ul>
<li>平均值：avg</li>
<li>最小值：min</li>
<li>最大值：max</li>
<li>总和：sum</li>
<li>记数：count</li>
</ul>
</li>
</ul>
<h3 id="max"><a href="#max" class="headerlink" title="max"></a>max</h3><ul>
<li>错误的写法<ul>
<li>两种理解方式<ul>
<li>max(grade) 没有限定语</li>
<li>执行树上，max 应该在最后执行，where 语句不能引用后面计算得到的结果</li>
</ul>
</li>
</ul>
</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> sno</span><br><span class="line"><span class="keyword">from</span> SC</span><br><span class="line"><span class="keyword">where</span> grade <span class="operator">=</span> <span class="built_in">max</span>(grade)</span><br></pre></td></tr></table></figure>

<ul>
<li>正确的写法</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> sno</span><br><span class="line"><span class="keyword">from</span> SC</span><br><span class="line"><span class="keyword">where</span> grade <span class="operator">=</span> (</span><br><span class="line">    <span class="keyword">select</span> <span class="built_in">max</span>(grade)</span><br><span class="line">    <span class="keyword">from</span> SC</span><br><span class="line">)</span><br></pre></td></tr></table></figure>



<h3 id="count"><a href="#count" class="headerlink" title="count"></a>count</h3><ul>
<li>只有 count(*) 会考虑空值，其他都会将空值排除在外<ul>
<li>count(*) 是对行数的计数</li>
<li>count(grade) 是对有效值的计数</li>
</ul>
</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> SC(</span><br><span class="line">    sno   <span class="type">char</span>(<span class="number">10</span>),</span><br><span class="line">    cno   <span class="type">char</span>(<span class="number">10</span>),</span><br><span class="line">    grade <span class="type">int</span></span><br><span class="line">);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> SC <span class="keyword">values</span>(&quot;s1&quot;, &quot;c1&quot;, <span class="number">90</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> SC <span class="keyword">values</span>(&quot;s1&quot;, &quot;c1&quot;, <span class="number">90</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> SC <span class="keyword">values</span>(&quot;s1&quot;, &quot;c2&quot;, <span class="number">90</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> SC <span class="keyword">values</span>(&quot;s1&quot;, &quot;c3&quot;, <span class="number">90</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> SC <span class="keyword">values</span>(&quot;s2&quot;, &quot;c1&quot;, <span class="keyword">null</span>);</span><br></pre></td></tr></table></figure>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* 输出 4 */</span></span><br><span class="line"><span class="keyword">select</span> <span class="built_in">count</span>(grade)</span><br><span class="line"><span class="keyword">from</span> SC</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 输出 5 */</span></span><br><span class="line"><span class="keyword">select</span> <span class="built_in">count</span>(<span class="operator">*</span>)</span><br><span class="line"><span class="keyword">from</span> SC</span><br></pre></td></tr></table></figure>



<h3 id="统计型聚集函数"><a href="#统计型聚集函数" class="headerlink" title="统计型聚集函数"></a>统计型聚集函数</h3><ul>
<li>std</li>
<li>stddev</li>
<li>stddev_pop</li>
<li>stddev_samp</li>
<li>variance</li>
<li>var_pop</li>
<li>var_samp</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/04/20/DB/CLJ/04-2/" data-id="cl9lj74ar00ek64tz5428630a" data-title="数据库概论.陈立军.04.SQL 数据查询(1)" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/DB/" rel="tag">DB</a></li></ul>

    </footer>
  </div>
  
</article>



  


  <nav id="page-nav">
    
    <a class="extend prev" rel="prev" href="/page/18/">&laquo; Prev</a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/17/">17</a><a class="page-number" href="/page/18/">18</a><span class="page-number current">19</span><a class="page-number" href="/page/20/">20</a><a class="page-number" href="/page/21/">21</a><span class="space">&hellip;</span><a class="page-number" href="/page/26/">26</a><a class="extend next" rel="next" href="/page/20/">Next &raquo;</a>
  </nav>

</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/0/">0</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Algebra/">Algebra</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/C-Kits/">C++.Kits</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/CG/">CG</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/CG-Algorithm/">CG.Algorithm</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/CG-GAMES101/">CG.GAMES101</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/CG-GAMES102/">CG.GAMES102</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/CG-GAMES103/">CG.GAMES103</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/CG-GAMES104/">CG.GAMES104</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/CG-GAMES202/">CG.GAMES202</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/CG-GAMES203/">CG.GAMES203</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/CG-Kits/">CG.Kits</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/CG-LS/">CG.LS</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/CG-PBRT/">CG.PBRT</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/CG-Paper/">CG.Paper</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/CV/">CV</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Code/">Code</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/DB-CLJ/">DB.CLJ</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/DB-MySQL/">DB.MySQL</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/DB-SQLServer/">DB.SQLServer</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/DSA/">DSA</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Kits/">Kits</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Math/">Math</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/OS-CXQ/">OS.CXQ</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/OS-OSTEP/">OS.OSTEP</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/OS-xv6-labs/">OS.xv6-labs</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/OS-xv6-source-code/">OS.xv6-source-code</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/TODO/">TODO</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/book-directory/">book.directory</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/computation-pyr/">computation.pyr</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/csharp-kits/">csharp.kits</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/csharp-tds/">csharp.tds</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/images/">images</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/installation/">installation</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/mitsuba/">mitsuba</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/nothing/">nothing</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/software-Maya/">software.Maya</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/software-ps/">software.ps</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/software-vscode/">software.vscode</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/win/">win</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Algebra/" rel="tag">Algebra</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/BFS/" rel="tag">BFS</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/BST/" rel="tag">BST</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/BVH/" rel="tag">BVH</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/C/" rel="tag">C++</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/CG/" rel="tag">CG</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/CG-Algorithm/" rel="tag">CG-Algorithm</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/CV/" rel="tag">CV</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Code/" rel="tag">Code</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/DB/" rel="tag">DB</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/DFS/" rel="tag">DFS</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/DP/" rel="tag">DP</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/DSA/" rel="tag">DSA</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Dijkstra/" rel="tag">Dijkstra</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/EG/" rel="tag">EG</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Floyd/" rel="tag">Floyd</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/GI/" rel="tag">GI</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Glints/" rel="tag">Glints</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/HDR/" rel="tag">HDR</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/HQX/" rel="tag">HQX</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Heap/" rel="tag">Heap</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Kits/" rel="tag">Kits</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/LCA/" rel="tag">LCA</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/LLG/" rel="tag">LLG</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/MCMC/" rel="tag">MCMC</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/MIS/" rel="tag">MIS</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/MLT/" rel="tag">MLT</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Maya/" rel="tag">Maya</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/MySQL/" rel="tag">MySQL</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/NEE/" rel="tag">NEE</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/OS/" rel="tag">OS</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/PBRT/" rel="tag">PBRT</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Paper/" rel="tag">Paper</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Radiometry/" rel="tag">Radiometry</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/RayTracing/" rel="tag">RayTracing</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/SAH/" rel="tag">SAH</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/SDF/" rel="tag">SDF</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/SGJ/" rel="tag">SGJ</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/SQL/" rel="tag">SQL</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/SQLServer/" rel="tag">SQLServer</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/STL/" rel="tag">STL</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Shadow/" rel="tag">Shadow</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/WHM/" rel="tag">WHM</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/WX/" rel="tag">WX</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/YLQ/" rel="tag">YLQ</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/book/" rel="tag">book</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/computation/" rel="tag">computation</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/csharp/" rel="tag">csharp</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/images/" rel="tag">images</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/installation/" rel="tag">installation</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/js/" rel="tag">js</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/linux/" rel="tag">linux</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/math/" rel="tag">math</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/mitsuba/" rel="tag">mitsuba</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/mobaxterm/" rel="tag">mobaxterm</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/nothing/" rel="tag">nothing</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/obs/" rel="tag">obs</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/occlusion/" rel="tag">occlusion</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ps/" rel="tag">ps</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/software/" rel="tag">software</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/test/" rel="tag">test</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/tree/" rel="tag">tree</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/vscode/" rel="tag">vscode</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/win/" rel="tag">win</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/xv6/" rel="tag">xv6</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E4%BA%8C%E5%88%86/" rel="tag">二分</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%85%83%E5%AE%87%E5%AE%99/" rel="tag">元宇宙</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%87%A0%E4%BD%95/" rel="tag">几何</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%8F%AF%E8%A7%81%E6%80%A7/" rel="tag">可见性</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%B9%B6%E6%9F%A5%E9%9B%86/" rel="tag">并查集</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%8B%93%E6%89%91%E6%8E%92%E5%BA%8F/" rel="tag">拓扑排序</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%8E%92%E5%BA%8F/" rel="tag">排序</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%99%AE%E5%90%95%E5%85%8B%E5%9D%90%E6%A0%87/" rel="tag">普吕克坐标</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%9C%80%E5%B0%8F%E7%94%9F%E6%88%90%E6%A0%91/" rel="tag">最小生成树</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%9C%80%E7%9F%AD%E8%B7%AF/" rel="tag">最短路</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%BA%BF%E6%AE%B5%E6%A0%91/" rel="tag">线段树</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/Algebra/" style="font-size: 10px;">Algebra</a> <a href="/tags/BFS/" style="font-size: 10px;">BFS</a> <a href="/tags/BST/" style="font-size: 10px;">BST</a> <a href="/tags/BVH/" style="font-size: 12.5px;">BVH</a> <a href="/tags/C/" style="font-size: 10px;">C++</a> <a href="/tags/CG/" style="font-size: 20px;">CG</a> <a href="/tags/CG-Algorithm/" style="font-size: 10px;">CG-Algorithm</a> <a href="/tags/CV/" style="font-size: 10.63px;">CV</a> <a href="/tags/Code/" style="font-size: 14.38px;">Code</a> <a href="/tags/DB/" style="font-size: 19.38px;">DB</a> <a href="/tags/DFS/" style="font-size: 12.5px;">DFS</a> <a href="/tags/DP/" style="font-size: 13.13px;">DP</a> <a href="/tags/DSA/" style="font-size: 11.25px;">DSA</a> <a href="/tags/Dijkstra/" style="font-size: 10px;">Dijkstra</a> <a href="/tags/EG/" style="font-size: 12.5px;">EG</a> <a href="/tags/Floyd/" style="font-size: 10.63px;">Floyd</a> <a href="/tags/GI/" style="font-size: 11.25px;">GI</a> <a href="/tags/Glints/" style="font-size: 10px;">Glints</a> <a href="/tags/HDR/" style="font-size: 10px;">HDR</a> <a href="/tags/HQX/" style="font-size: 10px;">HQX</a> <a href="/tags/Heap/" style="font-size: 10px;">Heap</a> <a href="/tags/Kits/" style="font-size: 13.75px;">Kits</a> <a href="/tags/LCA/" style="font-size: 10px;">LCA</a> <a href="/tags/LLG/" style="font-size: 12.5px;">LLG</a> <a href="/tags/MCMC/" style="font-size: 10.63px;">MCMC</a> <a href="/tags/MIS/" style="font-size: 10px;">MIS</a> <a href="/tags/MLT/" style="font-size: 10px;">MLT</a> <a href="/tags/Maya/" style="font-size: 10px;">Maya</a> <a href="/tags/MySQL/" style="font-size: 11.88px;">MySQL</a> <a href="/tags/NEE/" style="font-size: 10px;">NEE</a> <a href="/tags/OS/" style="font-size: 17.5px;">OS</a> <a href="/tags/PBRT/" style="font-size: 10px;">PBRT</a> <a href="/tags/Paper/" style="font-size: 15.63px;">Paper</a> <a href="/tags/Radiometry/" style="font-size: 10px;">Radiometry</a> <a href="/tags/RayTracing/" style="font-size: 10px;">RayTracing</a> <a href="/tags/SAH/" style="font-size: 10px;">SAH</a> <a href="/tags/SDF/" style="font-size: 10px;">SDF</a> <a href="/tags/SGJ/" style="font-size: 10.63px;">SGJ</a> <a href="/tags/SQL/" style="font-size: 13.13px;">SQL</a> <a href="/tags/SQLServer/" style="font-size: 10.63px;">SQLServer</a> <a href="/tags/STL/" style="font-size: 11.25px;">STL</a> <a href="/tags/Shadow/" style="font-size: 10px;">Shadow</a> <a href="/tags/WHM/" style="font-size: 16.88px;">WHM</a> <a href="/tags/WX/" style="font-size: 11.88px;">WX</a> <a href="/tags/YLQ/" style="font-size: 18.13px;">YLQ</a> <a href="/tags/book/" style="font-size: 10.63px;">book</a> <a href="/tags/computation/" style="font-size: 18.75px;">computation</a> <a href="/tags/csharp/" style="font-size: 16.25px;">csharp</a> <a href="/tags/images/" style="font-size: 10px;">images</a> <a href="/tags/installation/" style="font-size: 11.88px;">installation</a> <a href="/tags/js/" style="font-size: 10px;">js</a> <a href="/tags/linux/" style="font-size: 11.25px;">linux</a> <a href="/tags/math/" style="font-size: 10px;">math</a> <a href="/tags/mitsuba/" style="font-size: 11.88px;">mitsuba</a> <a href="/tags/mobaxterm/" style="font-size: 10px;">mobaxterm</a> <a href="/tags/nothing/" style="font-size: 10.63px;">nothing</a> <a href="/tags/obs/" style="font-size: 10px;">obs</a> <a href="/tags/occlusion/" style="font-size: 15px;">occlusion</a> <a href="/tags/ps/" style="font-size: 10px;">ps</a> <a href="/tags/software/" style="font-size: 10px;">software</a> <a href="/tags/test/" style="font-size: 10px;">test</a> <a href="/tags/tree/" style="font-size: 11.25px;">tree</a> <a href="/tags/vscode/" style="font-size: 10.63px;">vscode</a> <a href="/tags/win/" style="font-size: 10.63px;">win</a> <a href="/tags/xv6/" style="font-size: 16.25px;">xv6</a> <a href="/tags/%E4%BA%8C%E5%88%86/" style="font-size: 10.63px;">二分</a> <a href="/tags/%E5%85%83%E5%AE%87%E5%AE%99/" style="font-size: 10.63px;">元宇宙</a> <a href="/tags/%E5%87%A0%E4%BD%95/" style="font-size: 10px;">几何</a> <a href="/tags/%E5%8F%AF%E8%A7%81%E6%80%A7/" style="font-size: 11.88px;">可见性</a> <a href="/tags/%E5%B9%B6%E6%9F%A5%E9%9B%86/" style="font-size: 10.63px;">并查集</a> <a href="/tags/%E6%8B%93%E6%89%91%E6%8E%92%E5%BA%8F/" style="font-size: 10px;">拓扑排序</a> <a href="/tags/%E6%8E%92%E5%BA%8F/" style="font-size: 10px;">排序</a> <a href="/tags/%E6%99%AE%E5%90%95%E5%85%8B%E5%9D%90%E6%A0%87/" style="font-size: 10px;">普吕克坐标</a> <a href="/tags/%E6%9C%80%E5%B0%8F%E7%94%9F%E6%88%90%E6%A0%91/" style="font-size: 10px;">最小生成树</a> <a href="/tags/%E6%9C%80%E7%9F%AD%E8%B7%AF/" style="font-size: 13.13px;">最短路</a> <a href="/tags/%E7%BA%BF%E6%AE%B5%E6%A0%91/" style="font-size: 10px;">线段树</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/10/">October 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/04/">April 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/03/">March 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/02/">February 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/01/">January 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/12/">December 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/11/">November 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/10/">October 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/09/">September 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/08/">August 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/07/">July 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/06/">June 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/05/">May 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/04/">April 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/03/">March 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/02/">February 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/01/">January 2021</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2022/10/23/CG/WHM-GAMES103/11/">GAMES103.王华民.11.Incompressible Fluid Dynamics and Eulerian Fluids</a>
          </li>
        
          <li>
            <a href="/2022/10/23/CG/Papers/2021/bvh-survey-3/">(论文)[2021] A Survey on Bounding Volume Hierarchies for Ray Tracing(4)</a>
          </li>
        
          <li>
            <a href="/2022/04/28/CG/Kits/MIS-NEE/">NEE、MIS(多重重要性采样)</a>
          </li>
        
          <li>
            <a href="/2022/04/18/CG/WHM-GAMES103/10/">GAMES103.王华民.10.Surface Waves</a>
          </li>
        
          <li>
            <a href="/2022/04/17/CG/WHM-GAMES103/09-1/">GAMES103.王华民.09.Collision Handling(1)</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
      &copy; 2022 John Doe<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/js/jquery-3.4.1.min.js"></script>



  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>





  </div>
</body>
</html>